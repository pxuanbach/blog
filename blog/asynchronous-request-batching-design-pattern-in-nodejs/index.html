<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Asynchronous Request Batching Design Pattern in Node.js | Immersed in Code</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Asynchronous Request Batching Design Pattern in Node.js | Immersed in Code"><meta data-rh="true" name="description" content="Hello, This is the first post when I migrated from Wordpress to Docusaurus."><meta data-rh="true" property="og:description" content="Hello, This is the first post when I migrated from Wordpress to Docusaurus."><meta data-rh="true" property="og:image" content="https://immersedincode.io.vn/img/07_asynchronous_request_batching/featured.png"><meta data-rh="true" name="twitter:image" content="https://immersedincode.io.vn/img/07_asynchronous_request_batching/featured.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-07-18T10:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/pxuanbach"><meta data-rh="true" property="article:tag" content="nodejs,batching"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs"><link data-rh="true" rel="alternate" href="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs" hreflang="en"><link data-rh="true" rel="alternate" href="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs","mainEntityOfPage":"https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs","url":"https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs","headline":"Asynchronous Request Batching Design Pattern in Node.js","name":"Asynchronous Request Batching Design Pattern in Node.js","description":"Hello, This is the first post when I migrated from Wordpress to Docusaurus.","datePublished":"2024-07-18T10:00:00.000Z","author":{"@type":"Person","name":"Bach Pham","description":"Software Engineer","url":"https://github.com/pxuanbach","image":"https://avatars.githubusercontent.com/u/55500268?v=4"},"image":{"@type":"ImageObject","@id":"https://immersedincode.io.vn/img/07_asynchronous_request_batching/featured.png","url":"https://immersedincode.io.vn/img/07_asynchronous_request_batching/featured.png","contentUrl":"https://immersedincode.io.vn/img/07_asynchronous_request_batching/featured.png","caption":"title image for the blog post: Asynchronous Request Batching Design Pattern in Node.js"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://immersedincode.io.vn/blog","name":"My Awesome Blog"}}</script><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2VH0PJCNSH"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2VH0PJCNSH",{anonymize_ip:!0})</script>




<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Immersed in Code RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Immersed in Code Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e64f082f.css">
<script src="/assets/js/runtime~main.658633a5.js" defer="defer"></script>
<script src="/assets/js/main.f6ef97e8.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Immersed in Code Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Immersed in Code Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Immersed in Code</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/about">About</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/pxuanbach" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">My GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring">Essential modules for developing applications with FastAPI (P6 - Monitoring)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting">Essential modules for developing applications with FastAPI (P5 - Rate-limiting)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler">Essential modules for developing applications with FastAPI (P4 - Job Scheduler)</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/asynchronous-request-batching-design-pattern-in-nodejs">Asynchronous Request Batching Design Pattern in Node.js</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/destructuring-in-python">Destructuring in Python</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching">Essential modules for developing applications with FastAPI (P3 - Caching)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/dockerizing-medusajs-for-optimized-deployment">Dockerize MedusaJS Components: Optimize and Deploy Your Application</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging">Essential modules for developing applications with FastAPI (P2 - Logging)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration">Essential modules for developing applications with FastAPI (P1 - Migration)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/zero-downtime-deployment-with-docker-compose-nginx">Zero-downtime Deployments with Docker Compose &amp; Nginx</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/welcome">Welcome</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">Asynchronous Request Batching Design Pattern in Node.js</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-07-18T10:00:00.000Z">July 18, 2024</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/pxuanbach" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/55500268?v=4" alt="Bach Pham"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/pxuanbach" target="_blank" rel="noopener noreferrer"><span>Bach Pham</span></a></div><small class="avatar__subtitle">Software Engineer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Hello, This is the first post when I migrated from Wordpress to Docusaurus.</p>
<p>Recently, I have been researching some design patterns in Node.js to apply to my team&#x27;s project. Are you a fan of Node.js?</p>
<p>I have discovered some interesting patterns that can be applied to my project. Today, I will introduce the <strong>Asynchronous Request Batching Design Pattern</strong>. I&#x27;m really excited to share it with you.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="define-the-problem">Define the Problem<a href="#define-the-problem" class="hash-link" aria-label="Direct link to Define the Problem" title="Direct link to Define the Problem">​</a></h2>
<p>In reality, a large number of systems are expected to face issues with high throughput and large workloads. And the projects I have been assigned to are no exception 😁. So… what is the solution? At that time, I imagined a lot of solutions like caching, scaling, partitioning,…</p>
<p>Caching seems quite efficient. However, it comes with the challenge of invalidating cached data. Is there a similar approach to caching that doesn&#x27;t involve worrying about data invalidation? Is there any simpler way?</p>
<p>The Asynchronous Request Batching Design Pattern appears. This design pattern is really appealing to me at the moment.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-asynchronous-request-batching">Introduction to Asynchronous Request Batching<a href="#introduction-to-asynchronous-request-batching" class="hash-link" aria-label="Direct link to Introduction to Asynchronous Request Batching" title="Direct link to Introduction to Asynchronous Request Batching">​</a></h2>
<p>Let&#x27;s say I export an API and the Client makes multiple requests to that API at the same time. The server receives those requests and processes them concurrently. Please look at the image below.</p>
<div class="text--center"><p><img decoding="async" loading="lazy" alt="Normal Async Request" src="/assets/images/normal-async-request-fde198fd5d30185c2c43b3cd4f4db3a6.png" width="541" height="291" class="img_ev3q"></p></div>
<p>In the example above, both Client 1 and Client 2 make requests to the server. Each request is considered an async operation. As the number of requests increases, the number of asynchronous operations that need to be executed also grows.</p>
<p>Now, let&#x27;s talk about batching.</p>
<div class="text--center"><p><img decoding="async" loading="lazy" alt="Async Request Batching" src="/assets/images/async-request-batching-98383fcadb78102b51d34bf1dfb76a92.png" width="421" height="301" class="img_ev3q"></p></div>
<p>Still using the example with Client 1 and Client 2, but this time, their requests are batched together and processed in just one async operation. By doing this, when the operation completes, both clients are notified, even though the async operation is actually executed only once.</p>
<p>This approach offers a remarkably simple yet powerful way to optimize the load of an application. It avoids the complexity of caching mechanisms, which often require robust memory management and invalidation strategies.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="normal-api-server">Normal API server<a href="#normal-api-server" class="hash-link" aria-label="Direct link to Normal API server" title="Direct link to Normal API server">​</a></h2>
<p>Let&#x27;s consider an API server that manages the sales of an e-commerce company. Its task is to retrieve quantity information for hundreds of thousands of products from the database.</p>
<p>The schema used for this example is a simple table with three fields.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">TABLE</span><span class="token plain"> sales </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  id </span><span class="token keyword" style="color:#0c4a6e">INTEGER</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">KEY</span><span class="token plain"> AUTOINCREMENT</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  product </span><span class="token keyword" style="color:#0c4a6e">varchar</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">255</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  quantity </span><span class="token keyword" style="color:#0c4a6e">bigint</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The data processing operation is straightforward. It involves retrieving all records with the corresponding product and calculating their total quantity. The algorithm is intentionally slow as we want to highlight the effect of batching and caching later on. The routine would look as follows (file <code>totalQuantity.js</code>):</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./totalQuantity.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword module" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token imports">db</span><span class="token plain"> </span><span class="token keyword module" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&#x27;./database.js&#x27;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword module" style="color:#0c4a6e">export</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">function</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">totalQuantity</span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> now </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:#0ea5e9">Date</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">now</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">let</span><span class="token plain"> sql </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#64748b">`</span><span class="token template-string string" style="color:#64748b">SELECT product, quantity FROM sales WHERE product=?</span><span class="token template-string template-punctuation string" style="color:#64748b">`</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">let</span><span class="token plain"> total </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Promise</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation" style="color:#475569">,</span><span class="token parameter"> reject</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    db</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">all</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">sql</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">err</span><span class="token parameter punctuation" style="color:#475569">,</span><span class="token parameter"> rows</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#475569">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">reject</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      rows</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">forEach</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">row</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#475569">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        total </span><span class="token operator" style="color:#475569">+=</span><span class="token plain"> row</span><span class="token punctuation" style="color:#475569">.</span><span class="token property-access">quantity</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token console class-name" style="color:#0ea5e9">console</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">log</span><span class="token punctuation" style="color:#475569">(</span><span class="token template-string template-punctuation string" style="color:#64748b">`</span><span class="token template-string string" style="color:#64748b">totalQuantity() took: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#475569">${</span><span class="token template-string interpolation known-class-name class-name" style="color:#0ea5e9">Date</span><span class="token template-string interpolation punctuation" style="color:#475569">.</span><span class="token template-string interpolation method function property-access" style="color:#0e7490">now</span><span class="token template-string interpolation punctuation" style="color:#475569">(</span><span class="token template-string interpolation punctuation" style="color:#475569">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#475569">-</span><span class="token template-string interpolation"> now</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#475569">}</span><span class="token template-string string" style="color:#64748b">ms</span><span class="token template-string template-punctuation string" style="color:#64748b">`</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token function" style="color:#0e7490">resolve</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">total</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, I will expose the <code>totalQuantity</code> API through a simple <a href="https://expressjs.com/" target="_blank" rel="noopener noreferrer">Express.js</a> server (the <code>server.js</code> file):</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./server.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword module" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token imports">express</span><span class="token plain"> </span><span class="token keyword module" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&#x27;express&#x27;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword module" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#475569">{</span><span class="token imports"> totalQuantity </span><span class="token imports punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&#x27;./totalQuantity.js&#x27;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> app </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">express</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">PORT</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">8000</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">app</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&#x27;/&#x27;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#475569">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#475569">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  res</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">send</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&#x27;Hello World!&#x27;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">app</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&#x27;/total-quantity&#x27;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#475569">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#475569">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"> product </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#475569">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> total </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#0c4a6e">await</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">totalQuantity</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  res</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">status</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">200</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">json</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    product</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    total</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">app</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">listen</span><span class="token punctuation" style="color:#475569">(</span><span class="token constant" style="color:#0f172a">PORT</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#475569">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token console class-name" style="color:#0ea5e9">console</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">log</span><span class="token punctuation" style="color:#475569">(</span><span class="token template-string template-punctuation string" style="color:#64748b">`</span><span class="token template-string string" style="color:#64748b">Example app listening on PORT </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#475569">${</span><span class="token template-string interpolation constant" style="color:#0f172a">PORT</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#475569">}</span><span class="token template-string template-punctuation string" style="color:#64748b">`</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Before starting the server, we will generate some sample data. Leveraging SQLite&#x27;s lightweight and efficient nature, I&#x27;ve chosen it as the database for this example. Furthermore, I have prepared a script to populate the sales table with 200,000 rows (the Github repository can be found in the conclusion section).</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">npm run populate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After seeding data:</p>
<p><img decoding="async" loading="lazy" alt="After Seeding Data" src="/assets/images/after-seeding-data-63b73ddc739568126e114f1a6c36694f.png" width="698" height="257" class="img_ev3q"></p>
<p>Let&#x27;s start the server now.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">npm start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="test-scenario">Test scenario<a href="#test-scenario" class="hash-link" aria-label="Direct link to Test scenario" title="Direct link to Test scenario">​</a></h2>
<p>To clearly illustrate the difference between a server without batching and one with a batching pattern, we will create a scenario with more than one request. So, we will use a script named <code>loadTest.js</code>, which sends 20 requests at intervals of 20ms. The request sending interval should be lower than the <code>totalQuantity</code> function&#x27;s processing duration.</p>
<p>To run the test, just execute the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">node loadTest.js</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note the total time taken for the test.</p>
<p><img decoding="async" loading="lazy" alt="Test Normal API Server" src="/assets/images/test-normal-api-server-df24c9a3be02b90d9a64fb304b28fc3a.png" width="697" height="466" class="img_ev3q"></p>
<p>The results of 3 test runs are 994ms, 954ms, 957ms ~ avg <strong>968ms</strong>.</p>
<p>Let&#x27;s move on to the exciting part of today&#x27;s discussion: optimizing asynchronous request processing using the batching pattern.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="async-request-batching-server">Async request batching server<a href="#async-request-batching-server" class="hash-link" aria-label="Direct link to Async request batching server" title="Direct link to Async request batching server">​</a></h2>
<p>Now, we need to introduce an additional processing layer on top of the <code>totalQuantity</code> function. This is where we implement the mechanism of the batching pattern.</p>
<p>Now, imagine working with caching without worrying about cache invalidation. That makes it much easier to understand.</p>
<p>We will use a memory space to store the promises that need to be processed (it could be an array, map, dict, etc.). And we will differentiate them based on the input of the request. New requests with the same input will reference the promises stored in the memory space. When the promises complete, they will return results to all the requests referencing them, and then we will remove them from the memory space.</p>
<p>Now it&#x27;s time to code.</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./totalQuantityBatch.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword module" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#475569">{</span><span class="token imports"> totalQuantity </span><span class="token imports keyword module" style="color:#0c4a6e">as</span><span class="token imports"> totalQuantityRaw </span><span class="token imports punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;./totalQuantity.js&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> requestsQueue </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Map</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword module" style="color:#0c4a6e">export</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">function</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">totalQuantity</span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">requestsQueue</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">has</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token console class-name" style="color:#0ea5e9">console</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">log</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;Batching...&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#0c4a6e">return</span><span class="token plain"> requestsQueue</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> promise </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">totalQuantityRaw</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  requestsQueue</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">set</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> promise</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  promise</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword control-flow" style="color:#0c4a6e">finally</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#475569">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    requestsQueue</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">delete</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#0c4a6e">return</span><span class="token plain"> promise</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>totalQuantity</code> function of <code>totalQuantityBatch</code> module can be considered a proxy for <code>totalQuantityRaw</code> function of <code>totalQuantity</code> module, let&#x27;s see how it works:</p>
<ol>
<li>In <strong>line 3</strong>, I define the variable <code>requestsQueue</code> as a Map to serve as temporary memory.</li>
<li>From <strong>line 6-8</strong>, we check if a request with the input “product” already exists in the temporary memory. If it does, we return the stored promises.</li>
<li>From <strong>line 11-14</strong>, If the input “product” does not exist, we start executing the <code>totalQuantityRaw</code> function and store it in the temporary memory. One nice thing is that we can leverage <code>.finally</code> to attach a callback that removes the promise from the temporary memory.</li>
<li>In <strong>line 16</strong>, return running promise.</li>
</ol>
<p>After completing the logic in the <code>totalQuantityBatch</code> module, we need to update the <code>server.js</code> to incorporate the new logic.</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./server.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword module" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token imports">express</span><span class="token plain"> </span><span class="token keyword module" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&#x27;express&#x27;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955">// import { totalQuantity } from &#x27;./totalQuantity.js&#x27;;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword module" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#475569">{</span><span class="token imports"> totalQuantity </span><span class="token imports punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&#x27;./totalQuantityBatch.js&#x27;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token spread operator" style="color:#475569">...</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Restart the server and let&#x27;s see how the results change.</p>
<div class="text--center"><p><img decoding="async" loading="lazy" alt="Restart Server" src="/assets/images/restart-server-b24e101342a2910b8a93a580cfd7a6a5.png" width="501" height="631" class="img_ev3q"></p></div>
<p>Let’s run the <code>loadTest.js</code> script:</p>
<p><img decoding="async" loading="lazy" alt="Test Async Request Batching" src="/assets/images/test-async-request-batching-43726a2ba63910e1b231a035d738df6b.png" width="688" height="463" class="img_ev3q"></p>
<p>The results of 3 test runs are 624ms, 648ms, 592ms ~ avg <strong>621ms</strong>.</p>
<p>We can clearly see that the processing time for all requests has been significantly reduced. To observe even greater efficiency, you can increase the number of records in the database to extend the processing time of the <code>totalQuantity</code> function.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2>
<p>When implementing in a real-world project, we will use more advanced techniques to ensure the application operates reliably and smoothly.</p>
<ul>
<li>We will need a more optimized temporary memory space. A large number of requests to the server with different inputs later could cause the memory to expand significantly. You might consider using <strong>LRU (Least Recently Used)</strong> or <strong>FIFO (First In, First Out)</strong> methods for data management.</li>
<li>You can also apply caching to enhance the effectiveness of this technique and standardize the stored data for easier sharing. Of course, you will need to address the issue of cache invalidation.</li>
<li>When the application is distributed across multiple processes and instances, storing data in memory in different locations can lead to inconsistent results and become redundant. The solution is to use a shared storage. Common caching solutions include <strong>Redis</strong> (<a href="https://redis.io/" target="_blank" rel="noopener noreferrer">Redis - The Real-time Data Platform</a>) and <strong>Memcached</strong> (<a href="https://memcached.org/" target="_blank" rel="noopener noreferrer">memcached - a distributed memory object caching system</a>).</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>I hope this post was useful. If you need a project to run a demo on your environment, here is my <a href="https://github.com/pxuanbach/nodejs-design-pattern" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<p>See you again!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://blog.gogroup.co/asynchronous-request-batching-caching-in-node-js-b724c8a92562" target="_blank" rel="noopener noreferrer">Asynchronous Request Batching &amp; Caching in Node.js | by Maharshi Shah | GoGroup Tech Blog</a></li>
<li><a href="https://www.nodejsdesignpatterns.com/" target="_blank" rel="noopener noreferrer">Node.js Design Patterns Third Edition by Mario Casciaro and Luciano Mammino (nodejsdesignpatterns.com)</a></li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/nodejs">nodejs</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/batching">batching</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Essential modules for developing applications with FastAPI (P4 - Job Scheduler)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/destructuring-in-python"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Destructuring in Python</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#define-the-problem" class="table-of-contents__link toc-highlight">Define the Problem</a></li><li><a href="#introduction-to-asynchronous-request-batching" class="table-of-contents__link toc-highlight">Introduction to Asynchronous Request Batching</a></li><li><a href="#normal-api-server" class="table-of-contents__link toc-highlight">Normal API server</a></li><li><a href="#test-scenario" class="table-of-contents__link toc-highlight">Test scenario</a></li><li><a href="#async-request-batching-server" class="table-of-contents__link toc-highlight">Async request batching server</a></li><li><a href="#notes" class="table-of-contents__link toc-highlight">Notes</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ImmersedinCode Blog</div><ul class="footer__items clean-list"><li class="footer__item"><p>Simplicity is the soul of efficiency.</p></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/pxuanbach" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="mailto:pxuanbach1412@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gmail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/pham-bach-97a389217/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Bach Pham, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>