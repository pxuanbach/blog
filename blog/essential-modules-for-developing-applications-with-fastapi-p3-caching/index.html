<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Essential modules for developing applications with FastAPI (P3 - Caching) | Immersed in Code</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Essential modules for developing applications with FastAPI (P3 - Caching) | Immersed in Code"><meta data-rh="true" name="description" content="Hello, we meet again!"><meta data-rh="true" property="og:description" content="Hello, we meet again!"><meta data-rh="true" property="og:image" content="https://immersedincode.io.vn/img/02_essential-modules-for-developing-applications-with-fastapi-p1/featured.png"><meta data-rh="true" name="twitter:image" content="https://immersedincode.io.vn/img/02_essential-modules-for-developing-applications-with-fastapi-p1/featured.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-04-20T10:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/pxuanbach"><meta data-rh="true" property="article:tag" content="caching,fastapi,redis,python,essential-modules-fastapi"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching"><link data-rh="true" rel="alternate" href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching" hreflang="en"><link data-rh="true" rel="alternate" href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching","mainEntityOfPage":"https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching","url":"https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching","headline":"Essential modules for developing applications with FastAPI (P3 - Caching)","name":"Essential modules for developing applications with FastAPI (P3 - Caching)","description":"Hello, we meet again!","datePublished":"2024-04-20T10:00:00.000Z","author":{"@type":"Person","name":"Bach Pham","description":"Software Engineer","url":"https://github.com/pxuanbach","image":"https://avatars.githubusercontent.com/u/55500268?v=4"},"image":{"@type":"ImageObject","@id":"https://immersedincode.io.vn/img/02_essential-modules-for-developing-applications-with-fastapi-p1/featured.png","url":"https://immersedincode.io.vn/img/02_essential-modules-for-developing-applications-with-fastapi-p1/featured.png","contentUrl":"https://immersedincode.io.vn/img/02_essential-modules-for-developing-applications-with-fastapi-p1/featured.png","caption":"title image for the blog post: Essential modules for developing applications with FastAPI (P3 - Caching)"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://immersedincode.io.vn/blog","name":"My Awesome Blog"}}</script><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2VH0PJCNSH"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2VH0PJCNSH",{anonymize_ip:!0})</script>




<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Immersed in Code RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Immersed in Code Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e64f082f.css">
<script src="/assets/js/runtime~main.fdfecc80.js" defer="defer"></script>
<script src="/assets/js/main.7abbe558.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Immersed in Code Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Immersed in Code Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Immersed in Code</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/about">About</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/pxuanbach" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">My GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring">Essential modules for developing applications with FastAPI (P6 - Monitoring)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting">Essential modules for developing applications with FastAPI (P5 - Rate-limiting)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler">Essential modules for developing applications with FastAPI (P4 - Job Scheduler)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/asynchronous-request-batching-design-pattern-in-nodejs">Asynchronous Request Batching Design Pattern in Node.js</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/destructuring-in-python">Destructuring in Python</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching">Essential modules for developing applications with FastAPI (P3 - Caching)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/dockerizing-medusajs-for-optimized-deployment">Dockerize MedusaJS Components: Optimize and Deploy Your Application</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging">Essential modules for developing applications with FastAPI (P2 - Logging)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration">Essential modules for developing applications with FastAPI (P1 - Migration)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/zero-downtime-deployment-with-docker-compose-nginx">Zero-downtime Deployments with Docker Compose &amp; Nginx</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/welcome">Welcome</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">Essential modules for developing applications with FastAPI (P3 - Caching)</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-04-20T10:00:00.000Z">April 20, 2024</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/pxuanbach" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/55500268?v=4" alt="Bach Pham"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/pxuanbach" target="_blank" rel="noopener noreferrer"><span>Bach Pham</span></a></div><small class="avatar__subtitle">Software Engineer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Hello, we meet again!</p>
<p>In the previous post, I introduced two quite important modules in a project, which are Migration and Logging. In this article, I will introduce the Caching module.</p>
<p>I hope you enjoy it!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="frameworklibrary-version">Framework/Library version<a href="#frameworklibrary-version" class="hash-link" aria-label="Direct link to Framework/Library version" title="Direct link to Framework/Library version">​</a></h2>
<p>This project uses <a href="https://www.python.org/" target="_blank" rel="noopener noreferrer">Python</a> 3.10 as the environment and <a href="https://python-poetry.org/" target="_blank" rel="noopener noreferrer">Poetry</a> as the package manager.</p>
<p>The code and examples in this post will use frameworks/libraries with the following versions.</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./pyproject.toml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">[tool.poetry.dependencies]</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python = &quot;^3.10&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">uvicorn = {extras = [&quot;standard&quot;], version = &quot;^0.24.0.post1&quot;}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">fastapi = &quot;^0.109.1&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python-multipart = &quot;^0.0.7&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">email-validator = &quot;^2.1.0.post1&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">passlib = {extras = [&quot;bcrypt&quot;], version = &quot;^1.7.4&quot;}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">tenacity = &quot;^8.2.3&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">pydantic = &quot;&gt;2.0&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">emails = &quot;^0.6&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">gunicorn = &quot;^21.2.0&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">jinja2 = &quot;^3.1.2&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">alembic = &quot;^1.12.1&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python-jose = {extras = [&quot;cryptography&quot;], version = &quot;^3.3.0&quot;}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">httpx = &quot;^0.25.1&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">psycopg = {extras = [&quot;binary&quot;], version = &quot;^3.1.13&quot;}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">sqlmodel = &quot;^0.0.16&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Pin bcrypt until passlib supports the latest</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">bcrypt = &quot;4.0.1&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">pydantic-settings = &quot;^2.2.1&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">sentry-sdk = {extras = [&quot;fastapi&quot;], version = &quot;^1.40.6&quot;}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">psycopg2 = &quot;^2.9.9&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">asyncpg = &quot;^0.29.0&quot;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">redis = {extras = [&quot;hiredis&quot;], version = &quot;^5.0.3&quot;}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">orjson = &quot;^3.10.0&quot;</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="caching">Caching<a href="#caching" class="hash-link" aria-label="Direct link to Caching" title="Direct link to Caching">​</a></h2>
<p>We will explore integrating a caching module into FastAPI. This caching module will automatically store the results of previous API requests, thereby improving response times and reducing server load. There are many other places where you can cache data, such as In-memory, Redis, DynamoDB,… This section will implement a simple Redis caching solution for APIs.</p>
<p>First, we should install the <a href="https://github.com/redis/redis-py" target="_blank" rel="noopener noreferrer">Redis</a> package.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">poetry add redis   # pip install redis</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prepare-an-adapter-for-redis">Prepare an adapter for Redis<a href="#prepare-an-adapter-for-redis" class="hash-link" aria-label="Direct link to Prepare an adapter for Redis" title="Direct link to Prepare an adapter for Redis">​</a></h3>
<p>When working with Redis, we must manage connecting and disconnecting to Redis as necessary. Additionally, certain features require additional logic to integrate with the system seamlessly.</p>
<p>So, I define some functions that I want to use such as…</p>
<ul>
<li>Connect.</li>
<li>Disconnect.</li>
<li>Add a key to Redis.</li>
<li>Check the key exists in Redis.</li>
</ul>
<p>Let’s build it.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/redis.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> Dict</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> Tuple</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">asyncio </span><span class="token keyword" style="color:#0c4a6e">as</span><span class="token plain"> aioredis</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> logging</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">utils </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> ORJsonCoder</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RedisClient</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">connect</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> redis_url</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">pool </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> aioredis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ConnectionPool</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">from_url</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">redis_url</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> aioredis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">Redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">from_pool</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">pool</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ping</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;Redis connected&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;Cannot connect to Redis&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">add_to_cache</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Dict</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> expire</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">bool</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        response_data </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            response_data </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> ORJsonCoder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">except</span><span class="token plain"> TypeError</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            message </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#64748b">f&quot;Object of type </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation builtin" style="color:#0c4a6e">type</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">(</span><span class="token string-interpolation interpolation">value</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">)</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b"> is not JSON-serializable&quot;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        cached </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token builtin" style="color:#0c4a6e">set</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">name</span><span class="token operator" style="color:#475569">=</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> value</span><span class="token operator" style="color:#475569">=</span><span class="token plain">response_data</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> ex</span><span class="token operator" style="color:#475569">=</span><span class="token plain">expire</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> cached</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">key</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b"> added to cache&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># pragma: no cover</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f&quot;Failed to cache key </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">key</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> cached</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">check_cache</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> Tuple</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        pipe </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">pipeline</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        ttl</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> in_cache </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> pipe</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ttl</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> in_cache</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f&quot;Key </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">key</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b"> found in cache&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">ttl</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> in_cache</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">disconnect</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ping</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">aclose</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;Redis disconnected&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">redis_client </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> RedisClient</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this class, you might wonder about the <code>ORJsonCoder</code> module. Where is it? What can it do?</p>
<p>This module provides methods to perform JSON encoding and decoding using the <a href="https://github.com/ijl/orjson" target="_blank" rel="noopener noreferrer">orjson</a> library, aimed at increasing speed and performance compared to standard JSON libraries in Python.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/utils/orjson_coder.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> Union</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">encoders </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> jsonable_encoder</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> orjson</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ORJsonCoder</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">encode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">cls</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">bytes</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> orjson</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            value</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            default</span><span class="token operator" style="color:#475569">=</span><span class="token plain">jsonable_encoder</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            option</span><span class="token operator" style="color:#475569">=</span><span class="token plain">orjson</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">OPT_NON_STR_KEYS </span><span class="token operator" style="color:#475569">|</span><span class="token plain"> orjson</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">OPT_SERIALIZE_NUMPY</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">decode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">cls</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Union</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">bytes</span><span class="token plain"> </span><span class="token operator" style="color:#475569">|</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> orjson</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implement-logic-for-caching">Implement logic for caching<a href="#implement-logic-for-caching" class="hash-link" aria-label="Direct link to Implement logic for caching" title="Direct link to Implement logic for caching">​</a></h3>
<p>Next, we will create a module to provide caching features based on <code>RedisClient</code>. To clarify what we need, let&#x27;s explore the concept of Redis a bit.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-redis">What is Redis?<a href="#what-is-redis" class="hash-link" aria-label="Direct link to What is Redis?" title="Direct link to What is Redis?">​</a></h4>
<blockquote>
<p>Redis (<strong>RE</strong>mote <strong>DI</strong>ctionary <strong>S</strong>erver) is an open source, in-memory, NoSQL key/value store that is used primarily as an application cache or quick-response database.
<a href="https://www.ibm.com/topics/redis" target="_blank" rel="noopener noreferrer"><em>— By IBM —</em></a></p>
</blockquote>
<p>So, to effectively use Redis as a cache, we need an efficient strategy for creating keys and values. Fortunately, Redis now supports various <a href="https://redis.io/docs/latest/develop/data-types/" target="_blank" rel="noopener noreferrer">data types</a> such as strings, hashes, lists, sets, sorted sets, and JSON…</p>
<p>Another thing to keep in mind is what to cache and how long to keep it in cache.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-to-cache">What to cache?<a href="#what-to-cache" class="hash-link" aria-label="Direct link to What to cache?" title="Direct link to What to cache?">​</a></h4>
<blockquote>
<p>We don&#x27;t want to cache many keys that change continuously.
We don&#x27;t want to cache many keys that are requested very rarely.
We want to cache keys that are requested often and change at a reasonable rate. For an example of key not changing at a reasonable rate, think of a global counter that is continuously <a href="https://redis.io/docs/latest/commands/incr/" target="_blank" rel="noopener noreferrer">INCR</a>emented.
<a href="https://redis.io/docs/latest/develop/use/client-side-caching/#what-to-cache" target="_blank" rel="noopener noreferrer">— By Redis Docs —</a></p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="how-long-to-keep-it">How long to keep it?<a href="#how-long-to-keep-it" class="hash-link" aria-label="Direct link to How long to keep it?" title="Direct link to How long to keep it?">​</a></h4>
<p>This is a question that you need to answer for yourself; everything depends on the logic of your system.</p>
<p>Some systems use Redis to implement a whitelist strategy for their authorization tokens, so the time to keep that key in the cache memory could be the token&#x27;s lifespan.</p>
<p>They also implement data caching for high-traffic APIs with large response data, where the data returned from these APIs has minimal changes. The time to keep the key in the cache memory could be either the time it takes for a change to occur or just enough time to ensure users aren&#x27;t stuck with outdated data for too long.</p>
<p>Suppose you have complex computational tasks that are time-consuming or require significant computational resources. In that case, you can use cron jobs (schedule jobs) to precompute the results and store them in the cache to optimize user experience and system resource utilization.</p>
<p>Next, let&#x27;s take a quick look at this code snippet.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/cache.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> Any</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> urllib</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">parse </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> urlencode</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> Request</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">datastructures </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> QueryParams</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> redis_client</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">utils </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> ORJsonCoder</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">query_params_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">params</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> QueryParams</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    sorted_query_params </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">sorted</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">params</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> urlencode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">sorted_query_params</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> doseq</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">req_key_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token operator" style="color:#475569">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;:&quot;</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        req</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">method</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        req</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">url</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        query_params_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">query_params</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">add</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> expire</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">60</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain">   </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    cached </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">add_to_cache</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req_key_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> expire</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">not</span><span class="token plain"> cached</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">check_exist</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    key </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> req_key_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    ttl</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> in_cache </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">check_cache</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> in_cache</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">load_cache_data</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> ORJsonCoder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><strong>query_params_builder</strong>: The order of sent query parameters may be inconsistent. Therefore, we need a function to ensure consistency for the query parameters.</li>
<li><strong>req_key_builder</strong>: This function is used to create a unique key based on the incoming request. The value of the key will look like <code>get:/api/v1/users:limit=20&amp;skip=0</code>.</li>
<li><strong>add</strong>: As the name suggests, add a key/value pair to Redis with the corresponding parameters.</li>
<li><strong>check_exist</strong>: Used to check whether the data exists in the cache or not.</li>
<li><strong>load_cache_data</strong>: Simply used to decode the data retrieved from the cache.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="integration-with-fastapi">Integration with FastAPI<a href="#integration-with-fastapi" class="hash-link" aria-label="Direct link to Integration with FastAPI" title="Direct link to Integration with FastAPI">​</a></h3>
<p>After all the preparations are complete, the remaining task is to integrate it into the FastAPI application seamlessly.</p>
<p>First, connect to Redis.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/main.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> FastAPI</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> contextlib </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> asynccontextmanager</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">config </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> settings</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> redis_client</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#475569">@asynccontextmanager</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">lifespan</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># start up</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:#475569">(</span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">settings</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">REDIS_URL</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">yield</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># shut down</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">disconnect</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">app </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    title</span><span class="token operator" style="color:#475569">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">PROJECT_NAME</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    openapi_url</span><span class="token operator" style="color:#475569">=</span><span class="token string-interpolation string" style="color:#64748b">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">settings</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation">API_STR</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">settings</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation">API_VERSION_STR</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">/openapi.json&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    lifespan</span><span class="token operator" style="color:#475569">=</span><span class="token plain">lifespan</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Second, let&#x27;s do a simple example. I have an API that returns user information as follows.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/api/user.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token decorator annotation punctuation" style="color:#475569">@router</span><span class="token decorator annotation punctuation" style="color:#475569">.</span><span class="token decorator annotation punctuation" style="color:#475569">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> response_model</span><span class="token operator" style="color:#475569">=</span><span class="token plain">List</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">User</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">get_pagination_cache</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    skip</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Query</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    limit</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Query</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">20</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    session</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> AsyncSession </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Depends</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">get_async_session</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    data </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> user</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">get_pagination</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">session</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> skip</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> data</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now I will implement caching logic for this API. In FastAPI, you can use <a href="https://fastapi.tiangolo.com/tutorial/background-tasks/" target="_blank" rel="noopener noreferrer">Background Tasks</a> to cache asynchronously, which reduces system load and request latency.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/api/user.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token decorator annotation punctuation" style="color:#475569">@router</span><span class="token decorator annotation punctuation" style="color:#475569">.</span><span class="token decorator annotation punctuation" style="color:#475569">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> response_model</span><span class="token operator" style="color:#475569">=</span><span class="token plain">List</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">User</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">get_pagination_cache</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    request</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    bg_tasks</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> BackgroundTasks</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    skip</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Query</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    limit</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Query</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">20</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    session</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> AsyncSession </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Depends</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">get_async_session</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    in_cache </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">check_exist</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token operator" style="color:#475569">=</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> in_cache</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">load_cache_data</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">in_cache</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    data </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> user</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">get_pagination</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">session</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> skip</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    bg_tasks</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">add_task</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">cache</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> req</span><span class="token operator" style="color:#475569">=</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> data</span><span class="token operator" style="color:#475569">=</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> expire</span><span class="token operator" style="color:#475569">=</span><span class="token number" style="color:#B5CEA8">60</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> data</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When a user calls this API, it will check the corresponding key in Redis. If this key exists, it will return the value of the key without querying the database. If the key does not exist, the system will query the database to retrieve the data as usual. Once the data is obtained, we return it and simultaneously store it in the cache with an expiration time of 60 seconds.</p>
<p>I will insert approximately 20,000 records and use the <code>/users</code> API to retrieve that information. The larger the data, the more noticeable the difference in response time will be.</p>
<p>Let&#x27;s see what changes now. In the first usage, the API response time falls around 223 ms.</p>
<p><img decoding="async" loading="lazy" alt="Test API Nocache" src="/assets/images/test-api-nocache-b807ee3e35ae6bd3e8f514336925ae12.png" width="1493" height="531" class="img_ev3q"></p>
<p>In the second usage, the response time falls around 136 ms.</p>
<p><img decoding="async" loading="lazy" alt="Test API Cached" src="/assets/images/test-api-cached-0312526561d3640715f1f3f7af6de04c.png" width="1461" height="531" class="img_ev3q"></p>
<p>If you have <a href="https://redis.io/insight/" target="_blank" rel="noopener noreferrer">Redis Insight</a> on your machine, you can connect to Redis and view the values stored within it.</p>
<p><img decoding="async" loading="lazy" alt="Redis Insight" src="/assets/images/redis-insight-f387145bfa493f325cf3fa93c745ed20.png" width="1876" height="863" class="img_ev3q"></p>
<p>Additionally, you will need to pay attention to response headers such as <code>Cache-Control</code>, <code>ETag</code>, <code>Vary</code>,…</p>
<p>Some packages that you may be interested in:</p>
<ul>
<li><a href="https://github.com/long2ice/fastapi-cache" target="_blank" rel="noopener noreferrer">long2ice/fastapi-cache (github.com)</a> (1.1k stars, 132 forks on 18/04/2024)</li>
<li><a href="https://github.com/madkote/fastapi-plugins" target="_blank" rel="noopener noreferrer">madkote/fastapi-plugins (github.com)</a> (334 stars, 19 forks on 18/04/2024)</li>
<li><a href="https://github.com/comeuplater/fastapi_cache" target="_blank" rel="noopener noreferrer">comeuplater/fastapi_cache (github.com)</a> (208 stars, 16 forks on 18/04/2024)</li>
<li><a href="https://github.com/a-luna/fastapi-redis-cache" target="_blank" rel="noopener noreferrer">a-luna/fastapi-redis-cache (github.com)</a> (143 stars, 23 forks on 18/04/2024)</li>
<li><a href="https://github.com/mailgun/expiringdict" target="_blank" rel="noopener noreferrer">mailgun/expiringdict (github.com)</a> (335 stars, 75 forks on 18/04/2024)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>Well, that’s it. I have discussed some approaches to implementing caching for APIs with FastAPI as well as some related aspects.</p>
<p>I hope this post was useful. If you need a project to run a demo on your environment, here is my <a href="https://github.com/pxuanbach/fastapi-essential-modules" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://www.ibm.com/topics/redis" target="_blank" rel="noopener noreferrer">What is Redis Explained? | IBM</a></li>
<li><a href="https://redis.io/docs/latest/develop/use/client-side-caching/" target="_blank" rel="noopener noreferrer">Client-side caching in Redis | Docs (redis.io)</a></li>
<li><a href="https://redis.io/docs/latest/develop/data-types/" target="_blank" rel="noopener noreferrer">Understand Redis data types | Docs (redis.io)</a></li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/caching">caching</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/fastapi">fastapi</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/redis">redis</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/python">python</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/essential-modules-fastapi">essential-modules-fastapi</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/destructuring-in-python"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Destructuring in Python</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/dockerizing-medusajs-for-optimized-deployment"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Dockerize MedusaJS Components: Optimize and Deploy Your Application</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#frameworklibrary-version" class="table-of-contents__link toc-highlight">Framework/Library version</a></li><li><a href="#caching" class="table-of-contents__link toc-highlight">Caching</a><ul><li><a href="#prepare-an-adapter-for-redis" class="table-of-contents__link toc-highlight">Prepare an adapter for Redis</a></li><li><a href="#implement-logic-for-caching" class="table-of-contents__link toc-highlight">Implement logic for caching</a></li><li><a href="#integration-with-fastapi" class="table-of-contents__link toc-highlight">Integration with FastAPI</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ImmersedinCode Blog</div><ul class="footer__items clean-list"><li class="footer__item"><p>Simplicity is the soul of efficiency.</p></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/pxuanbach" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="mailto:pxuanbach1412@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gmail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/pham-bach-97a389217/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Bach Pham, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>