<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://immersedincode.io.vn/blog</id>
    <title>Immersed in Code Blog</title>
    <updated>2024-09-02T10:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://immersedincode.io.vn/blog"/>
    <subtitle>Immersed in Code Blog</subtitle>
    <icon>https://immersedincode.io.vn/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Essential modules for developing applications with FastAPI (P6 - Monitoring)]]></title>
        <id>https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring</id>
        <link href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring"/>
        <updated>2024-09-02T10:00:00.000Z</updated>
        <summary type="html"><![CDATA[Hello, FastAPI and I are here to see you again. Over the past week, I started onboarding at a new company, joined a new environment, and met new people, which made me really excited.]]></summary>
        <content type="html"><![CDATA[<p>Hello, FastAPI and I are here to see you again. Over the past week, I started onboarding at a new company, joined a new environment, and met new people, which made me really excited.</p>
<p>Getting straight to today's main topic, I will introduce a module that integrates with FastAPI, which helps us track the statistics of each API in the application.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="frameworklibrary-version"><strong>Framework/Library version</strong><a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring#frameworklibrary-version" class="hash-link" aria-label="Direct link to frameworklibrary-version" title="Direct link to frameworklibrary-version">​</a></h2>
<p>This project uses <a href="https://www.python.org/" target="_blank" rel="noopener noreferrer">Python</a> 3.10 as the environment and <a href="https://python-poetry.org/" target="_blank" rel="noopener noreferrer">Poetry</a> as the package manager.</p>
<p>The code and examples in this post will use frameworks/libraries with the following versions.</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">[tool.poetry.dependencies]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">python = "^3.10"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">uvicorn = {extras = ["standard"], version = "^0.24.0.post1"}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">fastapi = "^0.109.1"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">python-multipart = "^0.0.7"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">email-validator = "^2.1.0.post1"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">passlib = {extras = ["bcrypt"], version = "^1.7.4"}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">tenacity = "^8.2.3"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">pydantic = "&gt;2.0"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">emails = "^0.6"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">gunicorn = "^21.2.0"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">jinja2 = "^3.1.2"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">alembic = "^1.12.1"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">python-jose = {extras = ["cryptography"], version = "^3.3.0"}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">httpx = "^0.25.1"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">psycopg = {extras = ["binary"], version = "^3.1.13"}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">sqlmodel = "^0.0.16"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"># Pin bcrypt until passlib supports the latest</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">bcrypt = "4.0.1"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">pydantic-settings = "^2.2.1"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">sentry-sdk = {extras = ["fastapi"], version = "^1.40.6"}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">psycopg2 = "^2.9.9"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">asyncpg = "^0.29.0"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">redis = {extras = ["hiredis"], version = "^5.0.3"}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">orjson = "^3.10.0"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">apscheduler = "^3.10.4"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">prometheus-fastapi-instrumentator = "^7.0.0"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="monitoring">Monitoring<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring#monitoring" class="hash-link" aria-label="Direct link to Monitoring" title="Direct link to Monitoring">​</a></h2>
<p>I am confident that this is one of the most important modules when you want to deploy a product to a production environment.</p>
<p>Currently, many packages can help you monitor your FastAPI app. The package I like to use the most is <a href="https://github.com/trallnag/prometheus-fastapi-instrumentator" target="_blank" rel="noopener noreferrer">Prometheus FastAPI Instrumentator</a> (919 stars, 83 forks on 03/09/2024). I often use it along with Prometheus and Grafana, creating visual dashboards from those metrics helps me easily monitor the application. I will discuss this stack in another article.</p>
<p><img decoding="async" loading="lazy" alt="fastapi-instrumentator-prometheus.jpg" src="https://immersedincode.io.vn/assets/images/fastapi-instrumentator-prometheus-450322bbbf007dac79a07d69bc05a419.jpg" width="1046" height="347" class="img_ev3q"></p>
<p>How it’s work?</p>
<ol>
<li>The API server exports an endpoint <code>/metrics</code>, which tracks the HTTP request count, request/response size in bytes, request duration, and more.</li>
<li>We register the <code>/metrics</code> endpoint and set the crawl job duration for the Prometheus service. Next, this service automatically ingests metrics data from the API server, storing the collected data for analysis.</li>
<li>Grafana acts as an admin dashboard, retrieving data from Prometheus and visualizing it in specialized graphs, such as time-series, line charts.</li>
</ol>
<p>Let's integrate this package with FastAPI and deploy Prometheus and Grafana to visualize its metrics.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="integrating-with-fastapi">Integrating with FastAPI<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring#integrating-with-fastapi" class="hash-link" aria-label="Direct link to Integrating with FastAPI" title="Direct link to Integrating with FastAPI">​</a></h3>
<p>We need to initialize an instance of the instrumentator and export it when the application starts.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/main.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> FastAPI</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> contextlib </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> asynccontextmanager</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> prometheus_fastapi_instrumentator </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> Instrumentator</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#475569">@asynccontextmanager</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">lifespan</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># start up</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    instrumentator</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">expose</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">yield</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># shut down</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">pass</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">app </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    title</span><span class="token operator" style="color:#475569">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">PROJECT_NAME</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    openapi_url</span><span class="token operator" style="color:#475569">=</span><span class="token string-interpolation string" style="color:#64748b">f"</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">settings</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation">API_STR</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">settings</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation">API_VERSION_STR</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">/openapi.json"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    generate_unique_id_function</span><span class="token operator" style="color:#475569">=</span><span class="token plain">custom_generate_unique_id</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    lifespan</span><span class="token operator" style="color:#475569">=</span><span class="token plain">lifespan</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">instrumentator </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Instrumentator</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    should_group_status_codes</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    should_ignore_untemplated</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    excluded_handlers</span><span class="token operator" style="color:#475569">=</span><span class="token punctuation" style="color:#475569">[</span><span class="token string" style="color:#64748b">".*admin.*"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"/metrics"</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After initializing and running the application, you can easily find monitoring metrics at the <code>/metrics</code> endpoint.</p>
<p><img decoding="async" loading="lazy" alt="metrics-api-result.png" src="https://immersedincode.io.vn/assets/images/metrics-api-result-cdacd4f72250ce179b21aee3bd6926bd.png#center" width="864" height="597" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-prometheus-and-grafana-services">Setting up Prometheus and Grafana services<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring#setting-up-prometheus-and-grafana-services" class="hash-link" aria-label="Direct link to Setting up Prometheus and Grafana services" title="Direct link to Setting up Prometheus and Grafana services">​</a></h3>
<p>To quickly see the results, I recommend that you simply copy and paste as instructed in this section.</p>
<p>First, create a <code>docker-compose.yaml</code> file like this:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./monitoring/docker-compose.yaml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token key atrule">services</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token key atrule">prometheus</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> prom/prometheus</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain">v2.54.0</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> ./prometheus.yaml</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain">/etc/prometheus/prometheus.yml</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain">/prometheus</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'--config.file=/etc/prometheus/prometheus.yml'</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> unless</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">stopped</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token key atrule">grafana</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> grafana/grafana</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain">10.4.7</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"3001:3000"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> grafana</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain">/var/lib/grafana</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token key atrule">prometheus-data</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  grafana</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">:</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, create a <code>prometheus.yaml</code> file in the same location.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./monitoring/prometheus.yaml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token key atrule">global</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token key atrule">scrape_interval</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> 15s</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token key atrule">scrape_configs</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> </span><span class="token key atrule">job_name</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> fastapi</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">scrape_interval</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> 15s</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">scrape_timeout</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> 10s</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">metrics_path</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'/metrics'</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">static_configs</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> </span><span class="token key atrule">targets</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token string" style="color:#64748b">'host.docker.internal:8000'</span><span class="token punctuation" style="color:#475569">]</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You might be curious about the <code>host.docker.internal</code> address. What is it?</p>
<ul>
<li>The reason for this is that Docker network works differently on Linux, Windows, and macOS.</li>
<li>On Linux, Docker uses the system's built-in networking features.</li>
<li>But on Windows and macOS, Docker runs inside a virtual machine. Because of this, Windows and macOS need a special way for containers to talk to the host machine, which is why we use <code>host.docker.internal</code>.</li>
</ul>
<p>Since my OS is Windows, I'm using it as the host for the Prometheus service so that it can call the FastAPI server, which is not containerized.</p>
<p><img decoding="async" loading="lazy" alt="connect-to-service-outside-docker-deamon" src="https://immersedincode.io.vn/assets/images/connect-to-service-outside-docker-deamon-42d1d6da75dbe641c6d5530e6027e4d2.png#center" width="503" height="443" class="img_ev3q"></p>
<p>Now, docker compose up!</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">docker compose -f ./monitoring/docker-compose.yaml up -d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="docker-compose-up-prometheus-grafana" src="https://immersedincode.io.vn/assets/images/docker-compose-up-prometheus-grafana-1fbe1ac3e7929309b8ae72b538f850af.png#center" width="553" height="191" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-grafana-dashboard">Configuring Grafana Dashboard<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring#configuring-grafana-dashboard" class="hash-link" aria-label="Direct link to Configuring Grafana Dashboard" title="Direct link to Configuring Grafana Dashboard">​</a></h3>
<p>Once the services are up and running, you will see logs for requests to the /metrics endpoint being generated every 15 seconds (the <code>scrape_interval</code> of Prometheus).</p>
<p><img decoding="async" loading="lazy" alt="prometheus-crawl-metrics-api-logs" src="https://immersedincode.io.vn/assets/images/prometheus-crawl-metrics-api-logs-e89c8d8a2dd353b7f048988d720f79c8.png#center" width="545" height="195" class="img_ev3q"></p>
<p>Next, open your browser and go to <code>127.0.0.1:3001</code>; the Grafana login page will appear. The default username and password are <strong>admin</strong>.</p>
<p>After logging in, add Prometheus as a Data source with the connection URL set to <code>http://prometheus:9090</code>.</p>
<p>Why is <code>prometheus:9090</code>?</p>
<ul>
<li>Containers with a shared Docker Compose configuration can communicate with each other using the service name as the domain.</li>
<li>9090 is the default port of the Prometheus service.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="save-and-test-prometheus-successfully" src="https://immersedincode.io.vn/assets/images/save-and-test-prometheus-successfully-63f3629489eec63e856cec8816fb9d73.png#center" width="954" height="280" class="img_ev3q"></p>
<p>Back to Home, click “Create your first dashboard” &gt; "Import a dashboard”. You will see the following screen.</p>
<p><img decoding="async" loading="lazy" alt="import-grafana-dashboard" src="https://immersedincode.io.vn/assets/images/import-grafana-dashboard-5831f7ea5268c284f186012153268809.png#center" width="1166" height="903" class="img_ev3q"></p>
<p>You can easily find the <a href="https://github.com/pxuanbach/fastapi-essential-modules/blob/module/monitoring/monitoring/dashboard.json" target="_blank" rel="noopener noreferrer"><code>dashboard.json</code></a> file in my github repository. Import that file and see the result.</p>
<p><img decoding="async" loading="lazy" alt="grafana-fastapi-dashboard" src="https://immersedincode.io.vn/assets/images/grafana-fastapi-dashboard-5c4a02c182bcde2bdec9e991a1f42293.png#center" width="1902" height="913" class="img_ev3q"></p>
<p>Niceee!!!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2>
<p>These are not all the statistics that need to be tracked. In the real world, we need to track many more statistics, such as logs, RAM usage, CPU usage, total connections used, etc. However, for the scope of this article, this is enough to show you how we can monitor a FastAPI application.</p>
<p>Additionally, I would like to mention the use of packages that help monitor the application. These packages also consume resources to monitor the system, and they can become a performance bottleneck for the application. Always use it carefully, so you don't get into a mess.</p>
<p>Furthermore, you can also refer to a few other libraries such as…</p>
<ul>
<li><a href="https://github.com/stephenhillier/starlette_exporter" target="_blank" rel="noopener noreferrer">stephenhillier/starlette_exporter</a> (310 stars, 35 forks on 03/09/2024)</li>
<li><a href="https://github.com/perdy/starlette-prometheus" target="_blank" rel="noopener noreferrer">perdy/starlette-prometheus</a> (272 stars, 31 forks on 03/09/2024)</li>
<li><a href="https://github.com/acidjunk/starlette-opentracing" target="_blank" rel="noopener noreferrer">acidjunk/starlette-opentracing</a> (66 stars, 6 forks on 03/09/2024)</li>
<li><a href="https://github.com/open-telemetry/opentelemetry-python-contrib/tree/main/instrumentation/opentelemetry-instrumentation-fastapi" target="_blank" rel="noopener noreferrer">open-telemetry/opentelemetry-instrumentation-fastapi</a> (###)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>I hope this post was useful. If you need a project to run a demo on your environment, here is my&nbsp;<a href="https://github.com/pxuanbach/fastapi-essential-modules/tree/module/monitoring" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<p>See you again!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://github.com/Kludex/fastapi-prometheus-grafana?tab=readme-ov-file" target="_blank" rel="noopener noreferrer">Kludex/fastapi-prometheus-grafana: FasAPI + Prometheus + Grafana! <!-- -->🎉<!-- --> (github.com)</a></li>
</ul>]]></content>
        <author>
            <name>Bach Pham</name>
            <uri>https://github.com/pxuanbach</uri>
        </author>
        <category label="fastapi" term="fastapi"/>
        <category label="python" term="python"/>
        <category label="monitoring" term="monitoring"/>
        <category label="grafana" term="grafana"/>
        <category label="prometheus" term="prometheus"/>
        <category label="essential-modules-fastapi" term="essential-modules-fastapi"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Essential modules for developing applications with FastAPI (P5 - Rate-limiting)]]></title>
        <id>https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting</id>
        <link href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting"/>
        <updated>2024-08-15T10:00:00.000Z</updated>
        <summary type="html"><![CDATA[Another week has passed, how was your weekend? I am planning my future journey.]]></summary>
        <content type="html"><![CDATA[<p>Another week has passed, how was your weekend? I am planning my future journey.</p>
<p>In this article, I will introduce you to a crucial module to protect your system. As the title of the article, it is about Rate-limiting. Let's explore how we can apply it to FastAPI!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="frameworklibrary-version"><strong>Framework/Library version</strong><a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#frameworklibrary-version" class="hash-link" aria-label="Direct link to frameworklibrary-version" title="Direct link to frameworklibrary-version">​</a></h2>
<p>This project uses <a href="https://www.python.org/" target="_blank" rel="noopener noreferrer">Python</a> 3.10 as the environment and <a href="https://python-poetry.org/" target="_blank" rel="noopener noreferrer">Poetry</a> as the package manager.</p>
<p>The code and examples in this post will use frameworks/libraries with the following versions.</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">[tool.poetry.dependencies]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">python = "^3.10"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">uvicorn = {extras = ["standard"], version = "^0.24.0.post1"}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">fastapi = "^0.109.1"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">python-multipart = "^0.0.7"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">email-validator = "^2.1.0.post1"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">passlib = {extras = ["bcrypt"], version = "^1.7.4"}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">tenacity = "^8.2.3"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">pydantic = "&gt;2.0"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">emails = "^0.6"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">gunicorn = "^21.2.0"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">jinja2 = "^3.1.2"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">alembic = "^1.12.1"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">python-jose = {extras = ["cryptography"], version = "^3.3.0"}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">httpx = "^0.25.1"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">psycopg = {extras = ["binary"], version = "^3.1.13"}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">sqlmodel = "^0.0.16"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"># Pin bcrypt until passlib supports the latest</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">bcrypt = "4.0.1"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">pydantic-settings = "^2.2.1"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">sentry-sdk = {extras = ["fastapi"], version = "^1.40.6"}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">psycopg2 = "^2.9.9"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">asyncpg = "^0.29.0"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">redis = {extras = ["hiredis"], version = "^5.0.3"}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">orjson = "^3.10.0"</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">apscheduler = "^3.10.4"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rate-limiting-overview">Rate-limiting Overview<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#rate-limiting-overview" class="hash-link" aria-label="Direct link to Rate-limiting Overview" title="Direct link to Rate-limiting Overview">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-exactly-is-rate-limiting">What exactly is rate-limiting?<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#what-exactly-is-rate-limiting" class="hash-link" aria-label="Direct link to What exactly is rate-limiting?" title="Direct link to What exactly is rate-limiting?">​</a></h3>
<blockquote>
<p>Rate limiting is a strategy for limiting network traffic. It puts a cap on how often someone can repeat an action within a certain timeframe – for instance, trying to log in to an account. Rate limiting can help stop certain kinds of malicious&nbsp;<a href="https://www.cloudflare.com/learning/bots/what-is-a-bot/" target="_blank" rel="noopener noreferrer">bot activity</a>. It can also reduce strain on web servers.
<a href="https://www.cloudflare.com/learning/bots/what-is-rate-limiting/" target="_blank" rel="noopener noreferrer"><em>— By Cloud Flare —</em></a></p>
</blockquote>
<p>Besides, it also offers other benefits, such as monitoring API usage, enforcing API usage policies, and even implementing some business logic to differentiate customer permission levels.</p>
<p>There are many types of rate-limiting to meet various needs, including Fixed Window Counter, Sliding Window Counter, Token Bucket, and more. Additionally, rule limiting is also a topic of concern. I will introduce Fixed Window Counter rate-limiting in this article with an IP-based limiting mechanism.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-does-it-work">How does it work?<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#how-does-it-work" class="hash-link" aria-label="Direct link to How does it work?" title="Direct link to How does it work?">​</a></h3>
<p>I'll give a few simple examples to describe how Rate-limit works; take a look at the image below:</p>
<p><img decoding="async" loading="lazy" alt="How It Work" src="https://immersedincode.io.vn/assets/images/how-it-work-7b13a0fe01410027bc8e74f6620ed664.png#center" width="531" height="491" class="img_ev3q"></p>
<p>Suppose we have a Client sending requests to a Server, and we set a rule on the Server to only accept 2 requests within 1 minute. Therefore, if more than 2 requests are sent from the Client, starting from the 3rd request, an error will occur and it will be responded to immediately.</p>
<p>Perhaps you are curious as to why the 1-minute time frame is not calculated from point <strong>(1)</strong> but rather from point <strong>(2)</strong>. To understand this, you'll need to learn about Rate-Limit algorithms. If the time were calculated from point <strong>(1)</strong> and I could successfully make 2 requests after 1 minute, that would be the Fixed Window Counter algorithm. I calculate the time from point <strong>(2)</strong> because I am applying the Sliding Window Counter algorithm.</p>
<p><strong>Fixed Window Counter algorithm</strong> can be described as follows:</p>
<p><img decoding="async" loading="lazy" alt="Fixed Window Counter Example" src="https://immersedincode.io.vn/assets/images/fixed-window-counter-example-4ac6045486f5487be115b22878994f0a.png#center" width="521" height="261" class="img_ev3q"></p>
<ul>
<li>We still use the 2 requests per minute rule.</li>
<li><strong>R1</strong> and <strong>R2</strong> belong to Frame 1, and both responded successfully. At this point, Server will count <strong>R1</strong> and <strong>R2</strong>, with count = 2.</li>
<li><strong>R3</strong> failed because Frame 1 reached limit (count = 2 = limit).</li>
<li><strong>R5</strong> and <strong>R6</strong> belong to Frame 2, and do the same with <strong>R1</strong>, <strong>R2</strong>.</li>
</ul>
<p><strong>Sliding Window Counter algorithm</strong> can be described as follows:</p>
<p><img decoding="async" loading="lazy" alt="Sliding Window Counter Example" src="https://immersedincode.io.vn/assets/images/sliding-window-counter-example-60a8886904147c3066897af1632d0bcb.png#center" width="542" height="251" class="img_ev3q"></p>
<ul>
<li><strong>R1</strong> was successful because Frame 1 had no previous requests. We store <strong>R1</strong> with time = 60.</li>
<li><strong>R2</strong> also executes successfully. Because in Frame 2, there is only 1 request, which is <strong>R1</strong> (count = 1). At this stage, we adds <strong>R2</strong> with time = 75 to cache.</li>
<li><strong>R3</strong> failed because Frame 3 reached limit. We will check how many requests have been stored from around 30 to 90. Oh, we have <strong>R1</strong> and <strong>R2</strong> with corresponding times of 60 and 75.</li>
<li><strong>R4</strong> was successful because Frame 4 only contains <strong>R2</strong> (count = 1). At this point, we will cache <strong>R2</strong> and <strong>R4</strong>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prepare-before-coding">Prepare before coding<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#prepare-before-coding" class="hash-link" aria-label="Direct link to Prepare before coding" title="Direct link to Prepare before coding">​</a></h3>
<p>In <a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching">part 3 - caching</a>, we integrated Redis into our system. So I'm going to reuse it to store some stuff.</p>
<p>Now, let's find out what we are going to do.</p>
<p>In the API Server, I usually create a rate-limit module and treat it as middleware. First, the request will pass through the Rate-limit middleware, which will check whether this request is allowed to proceed to the next middleware or the execution layer.</p>
<p><img decoding="async" loading="lazy" alt="Request to Rate-limit Middleware" src="https://immersedincode.io.vn/assets/images/request-to-rate-limit-middleware-9696d4f339085cd77c0a8268f7b78653.png#center" width="691" height="131" class="img_ev3q"></p>
<p>When working with FastAPI, we have many ways to implement this module. I can list a few methods as follows:</p>
<ol>
<li>Take advantage of the Dependencies feature in FastAPI.</li>
<li>Use Python's decorator feature.</li>
<li>Build a middleware in the FastAPI application, similar in concept to Global Dependencies.</li>
</ol>
<p>In this article, I choose option 1 for simplicity and efficiency.</p>
<blockquote>
<p>“Simplicity is the soul of efficiency.” 😁</p>
</blockquote>
<p>Next, I will create a rate-limit class. It will be responsible for connecting to Redis and executing the algorithm to filter requests. Additionally, we'll need some helper functions to process the input data. Now, let's start coding!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implement-rate-limit-module">Implement Rate-limit module<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#implement-rate-limit-module" class="hash-link" aria-label="Direct link to Implement Rate-limit module" title="Direct link to Implement Rate-limit module">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="initialize-ratelimiter-class">Initialize RateLimiter class<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#initialize-ratelimiter-class" class="hash-link" aria-label="Direct link to Initialize RateLimiter class" title="Direct link to Initialize RateLimiter class">​</a></h3>
<p>This is the core of this module. The RateLimiter class has the following constructor parameters:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/rate_limiter.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimiter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">__init__</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        rule</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        exception_message</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Too many Request!"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        exception_status</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> status</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">HTTP_429_TOO_MANY_REQUESTS</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        redis</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> RedisClient </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> redis_client</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        lua_script</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> SLIDING_WINDOW_COUNTER</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">limit</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># count requests in duration time</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">duration_in_second</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> retrieve_rule</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rule</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">exp_message </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> exception_message</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">exp_status </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> exception_status</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> redis_client</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis_client </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> redis</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lua_script </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> lua_script</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lua_sha </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">""</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>rule (str): This is the parameter that takes the filtering rule for the API. For example, <code>5/15s</code> .</li>
<li>exception_message (str): An optional parameter to customize the error message sent when a request violates the rule. Default, <code>Too many Request!</code>.</li>
<li>exception_status (int): An optional parameter to customize the error status code sent when a request violates the rule. Default, <code>429</code>.</li>
<li>redis (RedisClient): An optional parameter to change the Redis instance used.</li>
<li>lua_script (str): An optional parameter to change the script running the algorithm on the Redis server. You can find it on <a href="https://redis.io/learn/develop/dotnet/aspnetcore/rate-limiting/sliding-window#sliding-window-rate-limiter-lua-script" target="_blank" rel="noopener noreferrer">Sliding Window Rate Limiting app using ASP.NET (redis.io)</a>.</li>
</ul>
<p>There are some functions and information you might be curious about. Don’t worry, I will explain them in the next section.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ratelimiter-execution-function">RateLimiter execution function<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#ratelimiter-execution-function" class="hash-link" aria-label="Direct link to RateLimiter execution function" title="Direct link to RateLimiter execution function">​</a></h3>
<p>Since we are defining a class, it operates within Dependencies based on the <code>__call__</code> method.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/rate_limiter.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimiter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">__call__</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">not</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ping</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> RedisUnavailableException</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        key </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">req_key_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            is_valid </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">check</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">except</span><span class="token plain"> NoScriptError</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lua_sha </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">load_script</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lua_script</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            is_valid </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">check</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> is_valid </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> HTTPException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">status_code</span><span class="token operator" style="color:#475569">=</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">exp_status</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> detail</span><span class="token operator" style="color:#475569">=</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">exp_message</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this function, it performs 4 steps:</p>
<ol>
<li>
<p>In line <strong>4</strong>, ensure the server is connected to Redis.</p>
</li>
<li>
<p>In line <strong>7</strong>, create a key based on the incoming request. We will identify incoming requests based on request method, path and client IP. Example: <code>get:127.0.0.1:/api/v1/utils/limiting</code></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/rate_limiter.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimiter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#475569">@staticmethod</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">req_key_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token operator" style="color:#475569">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token string" style="color:#64748b">":"</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">method</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">host</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">url</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>From line <strong>9-13</strong>, call <code>check</code> method with key parameter created in the previous step. If the Lua script hasn't been loaded onto Redis, load it and then call <code>check</code> method again.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/rate_limiter.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimiter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">	</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">check</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token operator" style="color:#475569">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">evaluate_sha</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lua_sha</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">duration_in_second</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">limit</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It will make a call to the Redis server and get the result from executing the Lua script we loaded earlier into Redis.</p>
</li>
<li>
<p>From line <strong>15-17</strong>, get the result from the <code>check</code> method and perform the corresponding action.</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="retrieve_rule-function">retrieve_rule function<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#retrieve_rule-function" class="hash-link" aria-label="Direct link to retrieve_rule function" title="Direct link to retrieve_rule function">​</a></h3>
<p>This function simply takes a valid string and extracts the corresponding values. The desired outcome is to determine the number of requests allowed within a given time frame (in seconds).</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/rate_limiter.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">PATTERN</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Final</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"(\d+)\/((\d+)(s|m|h))+"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">retrieve_rule</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rule</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        limit </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">PATTERN</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        duration </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">PATTERN</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        period </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">PATTERN</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">4</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        limit </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">limit</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        duration </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">duration</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">except</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">re</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> AttributeError</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> ValueError</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> RetrieveRuleException</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> limit </span><span class="token operator" style="color:#475569">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">or</span><span class="token plain"> duration </span><span class="token operator" style="color:#475569">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> LimitRuleException</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    duration_in_s </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> duration    </span><span class="token comment" style="color:#6A9955"># second</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> period </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"m"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        duration_in_s </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> duration </span><span class="token operator" style="color:#475569">*</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">60</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">elif</span><span class="token plain"> period </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"h"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        duration_in_s </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> duration </span><span class="token operator" style="color:#475569">*</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">60</span><span class="token plain"> </span><span class="token operator" style="color:#475569">*</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">60</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> duration_in_s</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-use-lua-scripts">Why use Lua scripts?<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#why-use-lua-scripts" class="hash-link" aria-label="Direct link to Why use Lua scripts?" title="Direct link to Why use Lua scripts?">​</a></h3>
<p>Basically, the execution of the algorithm will be handled by Redis, which reduces the load on the API Server when there is a large number of incoming requests. Additionally, it is faster than running the algorithm on the API Server.</p>
<p>Lua scripts block everything. You can't run two Lua scripts in parallel. So it ensures atomicity for our operations.</p>
<blockquote>
<p>The trick here is that everything needs to happen atomically, we want to be able to trim the set, check its cardinality, add an item to it, and set it's expiration, all without anything changing in the interim.
<a href="https://redis.io/learn/develop/dotnet/aspnetcore/rate-limiting/sliding-window#sliding-window-rate-limiter-lua-script" target="_blank" rel="noopener noreferrer">— By Redis —</a></p>
</blockquote>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">local current_time = redis.call('TIME')</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">local trim_time = tonumber(current_time[1]) - ARGV[1]</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">redis.call('ZREMRANGEBYSCORE', KEYS[1], 0, trim_time)</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">local request_count = redis.call('ZCARD', KEYS[1])</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">if request_count &lt; tonumber(ARGV[2]) then</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    redis.call('ZADD', KEYS[1], current_time[1], current_time[1] .. current_time[2])</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    redis.call('EXPIRE', KEYS[1], ARGV[1])</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    return 0</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">end</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">return 1</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing">Testing<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#testing" class="hash-link" aria-label="Direct link to Testing" title="Direct link to Testing">​</a></h2>
<p>I created 2 APIs with Rate-limit middleware and 2 test scripts for it. The script will look like this:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./tests/rate_limiting/test_rate_limit_1.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">url </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"http://localhost:8000/api/v1/utils/limiting1"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">payload </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">""</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    now </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">now</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    response </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"GET"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> url</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> data</span><span class="token operator" style="color:#475569">=</span><span class="token plain">payload</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">now</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    time</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0.5</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># On my local machine, the request function take 2 seconds to get a response.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Rule: 5/15s</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R1 success at 2.5s, redis contains [R1]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R2 success at 5s, redis contains [R1, R2]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R3 success at 7.5s, redis contains [R1, R2, R3]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R4 success at 10s, redis contains [R1, R2, R3, R4]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R5 success at 12.5s, redis contains [R1, R2, R3, R4, R5]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R6 fails at 15s, redis contains [R1, R2, R3, R4, R5]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R7 success at 18.5s, redis contains [R2, R3, R4, R5, R7]</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, let's see the results:</p>
<p><img decoding="async" loading="lazy" alt="Test results" src="https://immersedincode.io.vn/assets/images/test-results-bbe79d181c7c7e1e219a1d150bdbaab4.png#center" width="659" height="147" class="img_ev3q"></p>
<p>API server logs:</p>
<p><img decoding="async" loading="lazy" alt="API Server Logs" src="https://immersedincode.io.vn/assets/images/api-server-logs-956ceccd09215b82def7393181e2be3f.png#center" width="661" height="237" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2>
<p>Instead of Redis, you can implement a queue/map in your application to store request values. But consider the scalability of your system—implementing in-app queues or maps like this is no longer suitable and can lead to redundancy and resource waste. Therefore, if your application has non-functional requirements for scalability, consider using shared storage solutions like <strong>Redis</strong> (<a href="https://redis.io/" target="_blank" rel="noopener noreferrer">Redis - The Real-time Data Platform</a>) or <strong>Memcached</strong> (<a href="https://memcached.org/" target="_blank" rel="noopener noreferrer">memcached - a distributed memory object caching system</a>).</p>
<p>Additionally, to implement rate-limiting as middleware in API server, we can also implement it at <strong>network layer</strong>. This is also an interesting topic, and I hope to share more about it in other posts.</p>
<p>Some packages that you may be interested in:</p>
<ul>
<li><a href="https://github.com/laurentS/slowapi" target="_blank" rel="noopener noreferrer">laurentS/slowapi: A rate limiter for Starlette and FastAPI (github.com)</a> (1.1k stars, 72 forks on 18/08/2024)</li>
<li><a href="https://github.com/long2ice/fastapi-limiter" target="_blank" rel="noopener noreferrer">long2ice/fastapi-limiter: A request rate limiter for fastapi (github.com)</a> (465 stars, 52 forks on 18/08/2024)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>We have explored some aspects of rate-limiting and how to implement it in FastAPI.</p>
<p>I hope this post was useful. If you need a project to run a demo on your environment, here is my&nbsp;<a href="https://github.com/pxuanbach/fastapi-essential-modules/tree/module/rate-limiting" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<p>See you again!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://www.cloudflare.com/learning/bots/what-is-rate-limiting/" target="_blank" rel="noopener noreferrer">What is rate limiting? | Rate limiting and bots | Cloudflare</a></li>
<li><a href="https://developers.cloudflare.com/waf/rate-limiting-rules/best-practices/" target="_blank" rel="noopener noreferrer">Rate limiting best practices · Cloudflare Web Application Firewall (WAF) docs</a></li>
<li><a href="https://redis.io/learn/develop/dotnet/aspnetcore/rate-limiting/sliding-window#sliding-window-rate-limiter-lua-script" target="_blank" rel="noopener noreferrer">How to implement Sliding Window Rate Limiting app using ASP.NET Core &amp; Redis</a></li>
<li><a href="https://blogs.halodoc.io/taming-the-traffic-redis-and-lua-powered-sliding-window-rate-limiter-in-action/" target="_blank" rel="noopener noreferrer">Redis and Lua Powered Sliding Window Rate Limiter (halodoc.io)</a></li>
</ul>]]></content>
        <author>
            <name>Bach Pham</name>
            <uri>https://github.com/pxuanbach</uri>
        </author>
        <category label="fastapi" term="fastapi"/>
        <category label="redis" term="redis"/>
        <category label="rate-limit" term="rate-limit"/>
        <category label="python" term="python"/>
        <category label="essential-modules-fastapi" term="essential-modules-fastapi"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Essential modules for developing applications with FastAPI (P4 - Job Scheduler)]]></title>
        <id>https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler</id>
        <link href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler"/>
        <updated>2024-07-28T10:00:00.000Z</updated>
        <summary type="html"><![CDATA[Welcome back!]]></summary>
        <content type="html"><![CDATA[<p>Welcome back!</p>
<p>In part 4 of our series, we delve deeper into essential tools that streamline development and enhance functionality. Let's dive in!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="frameworklibrary-version">Framework/Library version<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#frameworklibrary-version" class="hash-link" aria-label="Direct link to Framework/Library version" title="Direct link to Framework/Library version">​</a></h2>
<p>This project uses <a href="https://www.python.org/" target="_blank" rel="noopener noreferrer">Python</a> 3.10 as the environment and <a href="https://python-poetry.org/" target="_blank" rel="noopener noreferrer">Poetry</a> as the package manager.</p>
<p>The code and examples in this post will use frameworks/libraries with the following versions.</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./pyproject.toml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">[tool.poetry.dependencies]</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python = "^3.10"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">uvicorn = {extras = ["standard"], version = "^0.24.0.post1"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">fastapi = "^0.109.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python-multipart = "^0.0.7"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">email-validator = "^2.1.0.post1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">passlib = {extras = ["bcrypt"], version = "^1.7.4"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">tenacity = "^8.2.3"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">pydantic = "&gt;2.0"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">emails = "^0.6"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">gunicorn = "^21.2.0"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">jinja2 = "^3.1.2"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">alembic = "^1.12.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python-jose = {extras = ["cryptography"], version = "^3.3.0"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">httpx = "^0.25.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">psycopg = {extras = ["binary"], version = "^3.1.13"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">sqlmodel = "^0.0.16"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Pin bcrypt until passlib supports the latest</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">bcrypt = "4.0.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">pydantic-settings = "^2.2.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">sentry-sdk = {extras = ["fastapi"], version = "^1.40.6"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">psycopg2 = "^2.9.9"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">asyncpg = "^0.29.0"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">redis = {extras = ["hiredis"], version = "^5.0.3"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">orjson = "^3.10.0"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">apscheduler = "^3.10.4"</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="job-scheduler">Job Scheduler<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#job-scheduler" class="hash-link" aria-label="Direct link to Job Scheduler" title="Direct link to Job Scheduler">​</a></h2>
<p>In the real world, the Job Scheduler module stands out as a fundamental tool for automating tasks and managing scheduled activities within web applications. FastAPI, with its asynchronous capabilities, integrates seamlessly with Job Scheduler modules, allowing efficient automation of recurring tasks.</p>
<p>I will introduce a library that I am using to build this module for my applications. It offers many options, powerful features, and operates flexibly.</p>
<p>It's <a href="https://github.com/agronholm/apscheduler" target="_blank" rel="noopener noreferrer">APScheduler</a> (6k stars, 693 forks on 28/07/2024). If you are wondering why, the answer comes from a ticket in my job, which required adding a feature to schedule certain tasks during the day in the FastAPI application. Then, I wandered through various blogs, forums, and stopped at a <a href="https://github.com/tiangolo/fastapi/discussions/9143" target="_blank" rel="noopener noreferrer">discussion</a> in the FastAPI repository. Many libraries were mentioned, and then I stopped <a href="https://github.com/tiangolo/fastapi/discussions/9143#discussioncomment-5157569" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>This library supports job storage with SQLAlchemy (<code>SQLAlchemyJobStore</code>) and job scheduling with asyncio (<code>AsyncIOScheduler</code>).</p>
<p>This library has three built-in scheduling systems</p>
<ul>
<li>Cron-style scheduling (with optional start/end times)</li>
<li>Interval-based execution (runs jobs on even intervals, with optional start/end times)</li>
<li>One-off delayed execution (runs jobs once, on a set date/time)</li>
</ul>
<p>So, we can organize the module flexibly to take advantage of those benefits.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="install">Install<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#install" class="hash-link" aria-label="Direct link to Install" title="Direct link to Install">​</a></h3>
<p>First, we should install the APScheduler package.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">poetry add apscheduler   # pip install apscheduler</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prepare-before-coding">Prepare before coding<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#prepare-before-coding" class="hash-link" aria-label="Direct link to Prepare before coding" title="Direct link to Prepare before coding">​</a></h3>
<p>Because APScheduler provides flexibility in adding and removing jobs at runtime, I usually build it as a regular entity in the system. That means there will be APIs performing CRD operations for it (no need for U - Update, because we only need to delete and re-add that job back into the system).</p>
<p>We will have a separate database to store jobs, typically I will use SQLite or PostgreSQL. It's lightweight and compatible with SQLAlchemy (<code>SQLAlchemyJobStore</code>).</p>
<p>In practice, I almost exclusively work with tasks that use <code>cron</code> or <code>interval</code> triggers. I rarely use <code>date</code>. However, for the sake of completeness in this article, I will also write APIs to support it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-scheduler-instance">Create a Scheduler instance<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#create-a-scheduler-instance" class="hash-link" aria-label="Direct link to Create a Scheduler instance" title="Direct link to Create a Scheduler instance">​</a></h3>
<p>In the first steps, we just need to declare an instance representing the Scheduler.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/scheduler.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> apscheduler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">schedulers</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">asyncio </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> AsyncIOScheduler</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> apscheduler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">jobstores</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">sqlalchemy </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> SQLAlchemyJobStore</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">config </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> settings</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">jobstores </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'default'</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> SQLAlchemyJobStore</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">url</span><span class="token operator" style="color:#475569">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">JOB_DATABASE_URI</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">scheduler </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> AsyncIOScheduler</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">jobstores</span><span class="token operator" style="color:#475569">=</span><span class="token plain">jobstores</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="integration-with-fastapi">Integration with FastAPI<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#integration-with-fastapi" class="hash-link" aria-label="Direct link to Integration with FastAPI" title="Direct link to Integration with FastAPI">​</a></h3>
<p>We also use the lifespan function to manage the lifecycle of the scheduler instance.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/main.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> FastAPI</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> contextlib </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> asynccontextmanager</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">scheduler </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> scheduler</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#475569">@asynccontextmanager</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">lifespan</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># start up</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        scheduler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">start</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#0c4a6e">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain">    </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"Unable to Create Schedule Object - [%s]"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">   </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">yield</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># shut down</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    scheduler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">shutdown</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">app </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    title</span><span class="token operator" style="color:#475569">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">PROJECT_NAME</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    lifespan</span><span class="token operator" style="color:#475569">=</span><span class="token plain">lifespan</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When running the project, you will see the log printed on the console as follows:</p>
<p><img decoding="async" loading="lazy" alt="Startup Log" src="https://immersedincode.io.vn/assets/images/start-up-log-6516261ca84dd3198a132fa4c391e1b4.png" width="708" height="156" class="img_ev3q"></p>
<p>This is just the warm-up part, now let's move on to the main part.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="build-job-creation-api">Build Job Creation API<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#build-job-creation-api" class="hash-link" aria-label="Direct link to Build Job Creation API" title="Direct link to Build Job Creation API">​</a></h3>
<p>First of all, initialize an APIRouter instance and register it in the FastAPI application.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/api/jobs.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> logging</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> APIRouter</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> HTTPException</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> BackgroundTasks</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> status</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">router </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> APIRouter</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">prefix</span><span class="token operator" style="color:#475569">=</span><span class="token string" style="color:#64748b">"/jobs"</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/api/__init__.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> APIRouter</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">api </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> user</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> utils</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> jobs</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">router</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">include_router</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">jobs</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">router</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> tags</span><span class="token operator" style="color:#475569">=</span><span class="token punctuation" style="color:#475569">[</span><span class="token string" style="color:#64748b">"Job"</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, let's talk about the interesting things about job creation API. As mentioned above, we will create an API to be able to create a new job while the application is running.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="schemamodel">Schema/Model<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#schemamodel" class="hash-link" aria-label="Direct link to Schema/Model" title="Direct link to Schema/Model">​</a></h4>
<p>The payload schema would look as follows:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/models/job.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> datetime </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> datetime</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> List</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> Literal</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> Union</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> sqlmodel </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> SQLModel</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">CronArgs</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">SQLModel</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    year</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"*"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    month</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"*"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    day</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"*"</span><span class="token plain"> </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    week</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"*"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    day_of_week</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"*"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    hour</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"*"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    minute</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"*"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    second</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"5"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">IntervalArgs</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">SQLModel</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    seconds</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">10</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    minutes</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    hours</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    days</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    weeks</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">DateArgs</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">SQLModel</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    args</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> List</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">Any</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    run_date</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> datetime </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">now</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">JobCreate</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">SQLModel</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    job_id</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    from_file</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">bool</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token builtin" style="color:#0c4a6e">type</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Literal</span><span class="token punctuation" style="color:#475569">[</span><span class="token string" style="color:#64748b">'cron'</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'interval'</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'date'</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'cron'</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    args</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">Union</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">DateArgs</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> IntervalArgs</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> CronArgs</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token boolean">None</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example, the API can create all 3 types of jobs simultaneously, so I designed it as above. However, it might be beneficial to decouple these functionalities for improved maintainability and extensibility.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="api-logic">API Logic<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#api-logic" class="hash-link" aria-label="Direct link to API Logic" title="Direct link to API Logic">​</a></h4>
<p>Next, let's take a quick look at this code snippet.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/api/jobs.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token decorator annotation punctuation" style="color:#475569">@router</span><span class="token decorator annotation punctuation" style="color:#475569">.</span><span class="token decorator annotation punctuation" style="color:#475569">post</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">""</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> response_model</span><span class="token operator" style="color:#475569">=</span><span class="token plain">JobCreateDeleteResponse</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">add_job_to_scheduler</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">obj_in</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> JobCreate</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> JobCreateDeleteResponse</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># Find job folder</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    job_folder </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"app"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> settings</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">JOB_DIR</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> obj_in</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">job_id</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">not</span><span class="token plain"> path</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">job_folder</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> HTTPException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">status_code</span><span class="token operator" style="color:#475569">=</span><span class="token plain">status</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">HTTP_404_NOT_FOUND</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> detail</span><span class="token operator" style="color:#475569">=</span><span class="token string" style="color:#64748b">"Job folder not found."</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    _timers </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> obj_in</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">args</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># Get timer parameters if `.schedule` file exists</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> obj_in</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">from_file</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        _timers </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        _sched_path </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">job_folder</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">".schedule"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">not</span><span class="token plain"> path</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">_sched_path</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> HTTPException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">status_code</span><span class="token operator" style="color:#475569">=</span><span class="token plain">status</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">HTTP_404_NOT_FOUND</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> detail</span><span class="token operator" style="color:#475569">=</span><span class="token string" style="color:#64748b">"Schedule file not found"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token comment" style="color:#6A9955"># read parameters from `.schedule` file</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        sched </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> read_file_line_by_line</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">_sched_path</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#0c4a6e">in</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">range</span><span class="token punctuation" style="color:#475569">(</span><span class="token builtin" style="color:#0c4a6e">len</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">sched</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> i </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">or</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">sched</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">'#'</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">or</span><span class="token plain"> sched</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token string" style="color:#64748b">''</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">or</span><span class="token plain"> sched</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">is</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">continue</span><span class="token plain"> </span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            _interval_timer </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">sched</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"="</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            _timers</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">update</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">{</span><span class="token plain">_interval_timer</span><span class="token punctuation" style="color:#475569">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> _interval_timer</span><span class="token punctuation" style="color:#475569">[</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># Get cron-job timer parameters if type equals "cron"</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> obj_in</span><span class="token punctuation" style="color:#475569">.</span><span class="token builtin" style="color:#0c4a6e">type</span><span class="token plain"> </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"cron"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        _timers </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> CronArgs</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">model_validate</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">_timers</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># Get interval-job timer parameters if type equals "interval"</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">elif</span><span class="token plain"> obj_in</span><span class="token punctuation" style="color:#475569">.</span><span class="token builtin" style="color:#0c4a6e">type</span><span class="token plain"> </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"interval"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        _timers </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> IntervalArgs</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">model_validate</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">_timers</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># Get date-off job timer parameters if type equals "date"</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">elif</span><span class="token plain"> obj_in</span><span class="token punctuation" style="color:#475569">.</span><span class="token builtin" style="color:#0c4a6e">type</span><span class="token plain"> </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"date"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        _timers </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> DateArgs</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">model_validate</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">_timers</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># find job module in `./app/jobs` folder, </span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># register the `call` function inside the module to the scheduler with timer parameters</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    _job_module </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> importlib</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">import_module</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f"app.jobs.</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">obj_in</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation">job_id</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">.main"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        job </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> scheduler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">add_job</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            _job_module</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">call</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            obj_in</span><span class="token punctuation" style="color:#475569">.</span><span class="token builtin" style="color:#0c4a6e">type</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token builtin" style="color:#0c4a6e">id</span><span class="token operator" style="color:#475569">=</span><span class="token plain">obj_in</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">job_id</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token operator" style="color:#475569">**</span><span class="token plain">_timers</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">model_dump</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">exclude_none</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">except</span><span class="token plain"> ConflictingIdError</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f"Job </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">obj_in</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation">job_id</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b"> already exists"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> HTTPException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">status_code</span><span class="token operator" style="color:#475569">=</span><span class="token plain">status</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">HTTP_409_CONFLICT</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> detail</span><span class="token operator" style="color:#475569">=</span><span class="token string" style="color:#64748b">"Job already exists"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#0c4a6e">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f"Add job </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">obj_in</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation">job_id</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b"> - </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation builtin" style="color:#0c4a6e">str</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">(</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">)</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> HTTPException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">status_code</span><span class="token operator" style="color:#475569">=</span><span class="token plain">status</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">HTTP_400_BAD_REQUEST</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> detail</span><span class="token operator" style="color:#475569">=</span><span class="token string" style="color:#64748b">"An error occurred"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> JobCreateDeleteResponse</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">scheduled</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> job_id</span><span class="token operator" style="color:#475569">=</span><span class="token plain">job</span><span class="token punctuation" style="color:#475569">.</span><span class="token builtin" style="color:#0c4a6e">id</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>How does it work?</p>
<ol>
<li>
<p>From line <strong>4-6</strong>, to register a job, we must define the job into <code>./app/jobs</code> folder. The name of the job folder must be equal to the <code>job_id</code>. For example:</p>
<p><img decoding="async" loading="lazy" alt="Define Job in Jobs folder" src="https://immersedincode.io.vn/assets/images/define-job-in-jobs-folder-3ae89d2adb8e139035efb7b2c5808aa4.png" width="793" height="512" class="img_ev3q"></p>
</li>
<li>
<p>From line <strong>10-31</strong>, I provide 2 options to create a new job.</p>
<ol>
<li>Register with <code>.schedule</code> file, this file will be placed in the job folder.</li>
<li>Register via API payload (Schema/Model) that I mentioned above.</li>
</ol>
</li>
<li>
<p>In line <strong>35</strong>, import the module dynamically using <code>job_id</code> via the <code>importlib</code> library.</p>
</li>
<li>
<p>From line <strong>37-42</strong>, try to register the job into the scheduler's job store.</p>
</li>
</ol>
<p>We will test it later. Next I will introduce the Get all jobs API.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="get-all-jobs-api">Get All Jobs API<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#get-all-jobs-api" class="hash-link" aria-label="Direct link to Get All Jobs API" title="Direct link to Get All Jobs API">​</a></h3>
<p>This API is simpler than Job Creation API.</p>
<p>The code will look like this:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/api/jobs.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token decorator annotation punctuation" style="color:#475569">@router</span><span class="token decorator annotation punctuation" style="color:#475569">.</span><span class="token decorator annotation punctuation" style="color:#475569">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">""</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">get_scheduled_jobs</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    schedules </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> job </span><span class="token keyword" style="color:#0c4a6e">in</span><span class="token plain"> scheduler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">get_jobs</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        schedules</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token string" style="color:#64748b">"job_id"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">job</span><span class="token punctuation" style="color:#475569">.</span><span class="token builtin" style="color:#0c4a6e">id</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token string" style="color:#64748b">"run_frequency"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">job</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">trigger</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token string" style="color:#64748b">"next_run"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">job</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">next_run_time</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"total"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">len</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">schedules</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"jobs"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> schedules </span><span class="token punctuation" style="color:#475569">}</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>How does it work?</p>
<ol>
<li>It uses APScheduler’s <code>get_jobs</code> API to get all registered jobs.</li>
<li>Loop through all jobs to retrieve the necessary data.</li>
<li>Returns total number of registered jobs and job information.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="delete-job-api">Delete Job API<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#delete-job-api" class="hash-link" aria-label="Direct link to Delete Job API" title="Direct link to Delete Job API">​</a></h3>
<p>Using the <code>job_id</code> as a unique identifier, we will invoke the APScheduler’s <code>remove_job</code> API to delete the corresponding job from the job store.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/api/jobs.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token decorator annotation punctuation" style="color:#475569">@router</span><span class="token decorator annotation punctuation" style="color:#475569">.</span><span class="token decorator annotation punctuation" style="color:#475569">delete</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"/{job_id}"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> response_model</span><span class="token operator" style="color:#475569">=</span><span class="token plain">JobCreateDeleteResponse</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">remove_job_from_scheduler</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">job_id</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> JobCreateDeleteResponse</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        scheduler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">remove_job</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">job_id</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#0c4a6e">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f"Delete job </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">job_id</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b"> - </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation builtin" style="color:#0c4a6e">str</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">(</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">)</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> HTTPException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">status_code</span><span class="token operator" style="color:#475569">=</span><span class="token plain">status</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">HTTP_400_BAD_REQUEST</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> mdetail</span><span class="token operator" style="color:#475569">=</span><span class="token string" style="color:#64748b">"Job deleted failed"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> JobCreateDeleteResponse</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">scheduled</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> job_id</span><span class="token operator" style="color:#475569">=</span><span class="token plain">job_id</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lets-see-the-results">Let's see the results<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#lets-see-the-results" class="hash-link" aria-label="Direct link to Let's see the results" title="Direct link to Let's see the results">​</a></h2>
<p>I created some scripts in <code>./tests</code> folder for testing.</p>
<p>For instance, a script will look like:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./tests/job_scheduler/get_list_jobs.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> requests</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">url </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"http://localhost:8000/api/v1/jobs"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">payload </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">""</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">headers </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"Content-Type"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"application/json"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">response </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"GET"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> url</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> data</span><span class="token operator" style="color:#475569">=</span><span class="token plain">payload</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> headers</span><span class="token operator" style="color:#475569">=</span><span class="token plain">headers</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let's see how our job scheduler looks like.</p>
<p><img decoding="async" loading="lazy" alt="Test Create A New Cron-job" src="https://immersedincode.io.vn/assets/images/test-create-cron-job-f119bb8ad0592714b93e96b809bfb9fb.png" width="1388" height="428" class="img_ev3q"></p>
<p>First, I create a cron-job and look at the logs. As you can see, the job has been successfully registered in the job store and runs every 10 seconds.</p>
<p>Now, delete it using the <code>delete_job.py</code> script and create an interval job.</p>
<p><img decoding="async" loading="lazy" alt="Test Delete, Create A New Interval Job, Get Jobs" src="https://immersedincode.io.vn/assets/images/test-delete-create-get-jobs-45470fa5a5cad132893fa0c9ec57b85f.png" width="1406" height="407" class="img_ev3q"></p>
<p>Wow, it’s work. Then test the Get all jobs API using <code>get_list_jobs.py</code> script. We can see it prints to the console that we have a total of 1 job in the job store.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2>
<p>In addition to the benefits it brings, we also need to pay attention to a few other things:</p>
<ul>
<li>The use of an in-app scheduler can lead to higher resource consumption by the application, and it generates a larger amount of logs, which can make error tracking more challenging. To address this issue, you can separate it into a dedicated application specifically for executing scheduled jobs. Your main application can call the job scheduler app via HTTP, GRPC, etc., to register jobs into the job store.</li>
<li>Beyond <code>AsyncIOScheduler</code>, APScheduler offers a variety of job schedulers and storage options. Explore the documentation to select the optimal tool for your system. <a href="https://apscheduler.readthedocs.io/en/3.x/userguide.html#choosing-the-right-scheduler-job-store-s-executor-s-and-trigger-s" target="_blank" rel="noopener noreferrer">https://apscheduler.readthedocs.io/en/3.x/userguide.html#choosing-the-right-scheduler-job-store-s-executor-s-and-trigger-s</a></li>
<li>To avoid your scheduler consuming a lot of database connections, try to limit the number of concurrent executions. <a href="https://apscheduler.readthedocs.io/en/3.x/userguide.html#limiting-the-number-of-concurrently-executing-instances-of-a-job" target="_blank" rel="noopener noreferrer">https://apscheduler.readthedocs.io/en/3.x/userguide.html#limiting-the-number-of-concurrently-executing-instances-of-a-job</a></li>
</ul>
<p>Some packages that you may be interested in:</p>
<ul>
<li><a href="https://github.com/celery/celery" target="_blank" rel="noopener noreferrer">celery/celery: Distributed Task Queue (development branch) (github.com)</a> (24.2k stars, 4.6k forks on 28/07/2024)</li>
<li><a href="https://github.com/samuelcolvin/arq" target="_blank" rel="noopener noreferrer">samuelcolvin/arq (github.com)</a> (2k stars, 170 forks on 28/07/2024) - <em>The author is the creator of <a href="https://github.com/pydantic/pydantic" target="_blank" rel="noopener noreferrer">Pydantic</a>, an important module integrated with FastAPI.</em></li>
<li><a href="https://github.com/dmontagu/fastapi-utils" target="_blank" rel="noopener noreferrer">dmontagu/fastapi-utils (github.com)</a> (1.8k stars, 163 forks on 28/07/2024)</li>
<li><a href="https://github.com/aio-libs/aiojobs" target="_blank" rel="noopener noreferrer">aio-libs/aiojobs (github.com)</a> (821 stars, 66 forks on 28/07/2024)</li>
<li><a href="https://github.com/madkote/fastapi-plugins" target="_blank" rel="noopener noreferrer">madkote/fastapi-plugins (github.com)</a> (355 stars, 19 forks on 28/07/2024)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>I hope this post was useful. If you need a project to run a demo on your environment, here is my&nbsp;<a href="https://github.com/pxuanbach/fastapi-essential-modules" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<p>Have a great weekend!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://apscheduler.readthedocs.io/en/3.x/userguide.html" target="_blank" rel="noopener noreferrer">https://apscheduler.readthedocs.io/en/3.x/userguide.html</a></li>
<li><a href="https://github.com/tiangolo/fastapi/discussions/9143" target="_blank" rel="noopener noreferrer">how can i run scheduling tasks using fastapi's · tiangolo/fastapi · Discussion #9143 (github.com)</a></li>
</ul>]]></content>
        <author>
            <name>Bach Pham</name>
            <uri>https://github.com/pxuanbach</uri>
        </author>
        <category label="fastapi" term="fastapi"/>
        <category label="apscheduler" term="apscheduler"/>
        <category label="job-scheduler" term="job-scheduler"/>
        <category label="python" term="python"/>
        <category label="essential-modules-fastapi" term="essential-modules-fastapi"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Asynchronous Request Batching Design Pattern in Node.js]]></title>
        <id>https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs</id>
        <link href="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs"/>
        <updated>2024-07-18T10:00:00.000Z</updated>
        <summary type="html"><![CDATA[Hello, This is the first post when I migrated from Wordpress to Docusaurus.]]></summary>
        <content type="html"><![CDATA[<p>Hello, This is the first post when I migrated from Wordpress to Docusaurus.</p>
<p>Recently, I have been researching some design patterns in Node.js to apply to my team's project. Are you a fan of Node.js?</p>
<p>I have discovered some interesting patterns that can be applied to my project. Today, I will introduce the <strong>Asynchronous Request Batching Design Pattern</strong>. I'm really excited to share it with you.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="define-the-problem">Define the Problem<a href="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs#define-the-problem" class="hash-link" aria-label="Direct link to Define the Problem" title="Direct link to Define the Problem">​</a></h2>
<p>In reality, a large number of systems are expected to face issues with high throughput and large workloads. And the projects I have been assigned to are no exception 😁. So… what is the solution? At that time, I imagined a lot of solutions like caching, scaling, partitioning,…</p>
<p>Caching seems quite efficient. However, it comes with the challenge of invalidating cached data. Is there a similar approach to caching that doesn't involve worrying about data invalidation? Is there any simpler way?</p>
<p>The Asynchronous Request Batching Design Pattern appears. This design pattern is really appealing to me at the moment.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-asynchronous-request-batching">Introduction to Asynchronous Request Batching<a href="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs#introduction-to-asynchronous-request-batching" class="hash-link" aria-label="Direct link to Introduction to Asynchronous Request Batching" title="Direct link to Introduction to Asynchronous Request Batching">​</a></h2>
<p>Let's say I export an API and the Client makes multiple requests to that API at the same time. The server receives those requests and processes them concurrently. Please look at the image below.</p>
<div class="text--center"><p><img decoding="async" loading="lazy" alt="Normal Async Request" src="https://immersedincode.io.vn/assets/images/normal-async-request-fde198fd5d30185c2c43b3cd4f4db3a6.png" width="541" height="291" class="img_ev3q"></p></div>
<p>In the example above, both Client 1 and Client 2 make requests to the server. Each request is considered an async operation. As the number of requests increases, the number of asynchronous operations that need to be executed also grows.</p>
<p>Now, let's talk about batching.</p>
<div class="text--center"><p><img decoding="async" loading="lazy" alt="Async Request Batching" src="https://immersedincode.io.vn/assets/images/async-request-batching-98383fcadb78102b51d34bf1dfb76a92.png" width="421" height="301" class="img_ev3q"></p></div>
<p>Still using the example with Client 1 and Client 2, but this time, their requests are batched together and processed in just one async operation. By doing this, when the operation completes, both clients are notified, even though the&nbsp;async operation is actually executed only once.</p>
<p>This approach offers a remarkably simple yet powerful way to optimize the load of an application. It avoids the complexity of caching mechanisms, which often require robust memory management and invalidation strategies.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="normal-api-server">Normal API server<a href="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs#normal-api-server" class="hash-link" aria-label="Direct link to Normal API server" title="Direct link to Normal API server">​</a></h2>
<p>Let's consider an API server that manages the sales of an e-commerce company. Its task is to retrieve quantity information for hundreds of thousands of products from the database.</p>
<p>The schema used for this example is a simple table with three fields.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">TABLE</span><span class="token plain"> sales </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  id </span><span class="token keyword" style="color:#0c4a6e">INTEGER</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">KEY</span><span class="token plain"> AUTOINCREMENT</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  product </span><span class="token keyword" style="color:#0c4a6e">varchar</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">255</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  quantity </span><span class="token keyword" style="color:#0c4a6e">bigint</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The data processing operation is straightforward. It involves retrieving all records with the corresponding product and calculating their total quantity. The algorithm is intentionally slow as we want to highlight the effect of batching and caching later on. The routine would look as follows (file&nbsp;<code>totalQuantity.js</code>):</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./totalQuantity.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword module" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token imports">db</span><span class="token plain"> </span><span class="token keyword module" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'./database.js'</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword module" style="color:#0c4a6e">export</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">function</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">totalQuantity</span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> now </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:#0ea5e9">Date</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">now</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">let</span><span class="token plain"> sql </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#64748b">`</span><span class="token template-string string" style="color:#64748b">SELECT product, quantity FROM sales WHERE product=?</span><span class="token template-string template-punctuation string" style="color:#64748b">`</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">let</span><span class="token plain"> total </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Promise</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation" style="color:#475569">,</span><span class="token parameter"> reject</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    db</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">all</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">sql</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">err</span><span class="token parameter punctuation" style="color:#475569">,</span><span class="token parameter"> rows</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#475569">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">reject</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      rows</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">forEach</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">row</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#475569">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        total </span><span class="token operator" style="color:#475569">+=</span><span class="token plain"> row</span><span class="token punctuation" style="color:#475569">.</span><span class="token property-access">quantity</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token console class-name" style="color:#0ea5e9">console</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">log</span><span class="token punctuation" style="color:#475569">(</span><span class="token template-string template-punctuation string" style="color:#64748b">`</span><span class="token template-string string" style="color:#64748b">totalQuantity() took: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#475569">${</span><span class="token template-string interpolation known-class-name class-name" style="color:#0ea5e9">Date</span><span class="token template-string interpolation punctuation" style="color:#475569">.</span><span class="token template-string interpolation method function property-access" style="color:#0e7490">now</span><span class="token template-string interpolation punctuation" style="color:#475569">(</span><span class="token template-string interpolation punctuation" style="color:#475569">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#475569">-</span><span class="token template-string interpolation"> now</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#475569">}</span><span class="token template-string string" style="color:#64748b">ms</span><span class="token template-string template-punctuation string" style="color:#64748b">`</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token function" style="color:#0e7490">resolve</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">total</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, I will expose the <code>totalQuantity</code> API through a simple <a href="https://expressjs.com/" target="_blank" rel="noopener noreferrer">Express.js</a> server (the <code>server.js</code> file):</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./server.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword module" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token imports">express</span><span class="token plain"> </span><span class="token keyword module" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'express'</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword module" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#475569">{</span><span class="token imports"> totalQuantity </span><span class="token imports punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'./totalQuantity.js'</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> app </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">express</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">PORT</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">8000</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">app</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">'/'</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#475569">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#475569">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  res</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">send</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">'Hello World!'</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">app</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">'/total-quantity'</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#475569">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#475569">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"> product </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#475569">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> total </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#0c4a6e">await</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">totalQuantity</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  res</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">status</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">200</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">json</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    product</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    total</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">app</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">listen</span><span class="token punctuation" style="color:#475569">(</span><span class="token constant" style="color:#0f172a">PORT</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#475569">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token console class-name" style="color:#0ea5e9">console</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">log</span><span class="token punctuation" style="color:#475569">(</span><span class="token template-string template-punctuation string" style="color:#64748b">`</span><span class="token template-string string" style="color:#64748b">Example app listening on PORT </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#475569">${</span><span class="token template-string interpolation constant" style="color:#0f172a">PORT</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#475569">}</span><span class="token template-string template-punctuation string" style="color:#64748b">`</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Before starting the server, we will generate some sample data. Leveraging SQLite's lightweight and efficient nature, I've chosen it as the database for this example. Furthermore, I have prepared a script to populate the sales table with 200,000 rows (the Github repository can be found in the conclusion section).</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">npm run populate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After seeding data:</p>
<p><img decoding="async" loading="lazy" alt="After Seeding Data" src="https://immersedincode.io.vn/assets/images/after-seeding-data-63b73ddc739568126e114f1a6c36694f.png" width="698" height="257" class="img_ev3q"></p>
<p>Let's start the server now.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">npm start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="test-scenario">Test scenario<a href="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs#test-scenario" class="hash-link" aria-label="Direct link to Test scenario" title="Direct link to Test scenario">​</a></h2>
<p>To clearly illustrate the difference between a server without batching and one with a batching pattern, we will create a scenario with more than one request. So, we will use a script named <code>loadTest.js</code>, which sends 20 requests at intervals of 20ms. The request sending interval should be lower than the <code>totalQuantity</code> function's processing duration.</p>
<p>To run the test, just execute the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">node loadTest.js</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note the total time taken for the test.</p>
<p><img decoding="async" loading="lazy" alt="Test Normal API Server" src="https://immersedincode.io.vn/assets/images/test-normal-api-server-df24c9a3be02b90d9a64fb304b28fc3a.png" width="697" height="466" class="img_ev3q"></p>
<p>The results of 3 test runs are 994ms, 954ms, 957ms ~ avg <strong>968ms</strong>.</p>
<p>Let's move on to the exciting part of today's discussion: optimizing asynchronous request processing using the batching pattern.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="async-request-batching-server">Async request batching server<a href="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs#async-request-batching-server" class="hash-link" aria-label="Direct link to Async request batching server" title="Direct link to Async request batching server">​</a></h2>
<p>Now, we need to introduce an additional processing layer on top of the <code>totalQuantity</code> function. This is where we implement the mechanism of the batching pattern.</p>
<p>Now, imagine working with caching without worrying about cache invalidation. That makes it much easier to understand.</p>
<p>We will use a memory space to store the promises that need to be processed (it could be an array, map, dict, etc.). And we will differentiate them based on the input of the request. New requests with the same input will reference the promises stored in the memory space. When the promises complete, they will return results to all the requests referencing them, and then we will remove them from the memory space.</p>
<p>Now it's time to code.</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./totalQuantityBatch.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword module" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#475569">{</span><span class="token imports"> totalQuantity </span><span class="token imports keyword module" style="color:#0c4a6e">as</span><span class="token imports"> totalQuantityRaw </span><span class="token imports punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"./totalQuantity.js"</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> requestsQueue </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Map</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword module" style="color:#0c4a6e">export</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">function</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">totalQuantity</span><span class="token punctuation" style="color:#475569">(</span><span class="token parameter">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">requestsQueue</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">has</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token console class-name" style="color:#0ea5e9">console</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">log</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"Batching..."</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#0c4a6e">return</span><span class="token plain"> requestsQueue</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">const</span><span class="token plain"> promise </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">totalQuantityRaw</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  requestsQueue</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">set</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> promise</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  promise</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword control-flow" style="color:#0c4a6e">finally</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#475569">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    requestsQueue</span><span class="token punctuation" style="color:#475569">.</span><span class="token method function property-access" style="color:#0e7490">delete</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">product</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#0c4a6e">return</span><span class="token plain"> promise</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>totalQuantity</code> function of <code>totalQuantityBatch</code> module can be considered a proxy for <code>totalQuantityRaw</code> function of <code>totalQuantity</code> module, let's see how it works:</p>
<ol>
<li>In <strong>line 3</strong>, I define the variable <code>requestsQueue</code> as a Map to serve as temporary memory.</li>
<li>From <strong>line 6-8</strong>, we check if a request with the input “product” already exists in the temporary memory. If it does, we return the stored promises.</li>
<li>From <strong>line 11-14</strong>, If the input “product” does not exist, we start executing the <code>totalQuantityRaw</code> function and store it in the temporary memory. One nice thing is that we can leverage <code>.finally</code> to attach a callback that removes the promise from the temporary memory.</li>
<li>In <strong>line 16</strong>, return running promise.</li>
</ol>
<p>After completing the logic in the <code>totalQuantityBatch</code> module, we need to update the <code>server.js</code> to incorporate the new logic.</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./server.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword module" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token imports">express</span><span class="token plain"> </span><span class="token keyword module" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'express'</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955">// import { totalQuantity } from './totalQuantity.js';</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword module" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#475569">{</span><span class="token imports"> totalQuantity </span><span class="token imports punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'./totalQuantityBatch.js'</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token spread operator" style="color:#475569">...</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Restart the server and let's see how the results change.</p>
<div class="text--center"><p><img decoding="async" loading="lazy" alt="Restart Server" src="https://immersedincode.io.vn/assets/images/restart-server-b24e101342a2910b8a93a580cfd7a6a5.png" width="501" height="631" class="img_ev3q"></p></div>
<p>Let’s run the <code>loadTest.js</code> script:</p>
<p><img decoding="async" loading="lazy" alt="Test Async Request Batching" src="https://immersedincode.io.vn/assets/images/test-async-request-batching-43726a2ba63910e1b231a035d738df6b.png" width="688" height="463" class="img_ev3q"></p>
<p>The results of 3 test runs are 624ms, 648ms, 592ms ~ avg <strong>621ms</strong>.</p>
<p>We can clearly see that the processing time for all requests has been significantly reduced. To observe even greater efficiency, you can increase the number of records in the database to extend the processing time of the <code>totalQuantity</code> function.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2>
<p>When implementing in a real-world project, we will use more advanced techniques to ensure the application operates reliably and smoothly.</p>
<ul>
<li>We will need a more optimized temporary memory space. A large number of requests to the server with different inputs later could cause the memory to expand significantly. You might consider using <strong>LRU (Least Recently Used)</strong> or <strong>FIFO (First In, First Out)</strong> methods for data management.</li>
<li>You can also apply caching to enhance the effectiveness of this technique and standardize the stored data for easier sharing. Of course, you will need to address the issue of cache invalidation.</li>
<li>When the application is distributed across multiple processes and instances, storing data in memory in different locations can lead to inconsistent results and become redundant. The solution is to use a shared storage. Common caching solutions include <strong>Redis</strong> (<a href="https://redis.io/" target="_blank" rel="noopener noreferrer">Redis - The Real-time Data Platform</a>) and <strong>Memcached</strong> (<a href="https://memcached.org/" target="_blank" rel="noopener noreferrer">memcached - a distributed memory object caching system</a>).</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>I hope this post was useful. If you need a project to run a demo on your environment, here is my&nbsp;<a href="https://github.com/pxuanbach/nodejs-design-pattern" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<p>See you again!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://immersedincode.io.vn/blog/asynchronous-request-batching-design-pattern-in-nodejs#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://blog.gogroup.co/asynchronous-request-batching-caching-in-node-js-b724c8a92562" target="_blank" rel="noopener noreferrer">Asynchronous Request Batching &amp; Caching in Node.js | by Maharshi Shah | GoGroup Tech Blog</a></li>
<li><a href="https://www.nodejsdesignpatterns.com/" target="_blank" rel="noopener noreferrer">Node.js Design Patterns Third Edition by Mario Casciaro and Luciano Mammino (nodejsdesignpatterns.com)</a></li>
</ul>]]></content>
        <author>
            <name>Bach Pham</name>
            <uri>https://github.com/pxuanbach</uri>
        </author>
        <category label="nodejs" term="nodejs"/>
        <category label="batching" term="batching"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Destructuring in Python]]></title>
        <id>https://immersedincode.io.vn/blog/destructuring-in-python</id>
        <link href="https://immersedincode.io.vn/blog/destructuring-in-python"/>
        <updated>2024-06-08T10:00:00.000Z</updated>
        <summary type="html"><![CDATA[Hello, are you learning Python? Does your job involve using Python? If so, you will find this article quite interesting 😉.]]></summary>
        <content type="html"><![CDATA[<p>Hello, are you learning Python? Does your job involve using Python? If so, you will find this article quite interesting 😉.</p>
<p>This article is largely inspired by the destructuring assignment in JavaScript. While working with JavaScript, I became greatly fascinated with the destructuring assignment syntax in JavaScript, and I needed it in my Python code.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-destructuring-in-python">What is Destructuring in Python?<a href="https://immersedincode.io.vn/blog/destructuring-in-python#what-is-destructuring-in-python" class="hash-link" aria-label="Direct link to What is Destructuring in Python?" title="Direct link to What is Destructuring in Python?">​</a></h2>
<p>Destructuring syntax is an extremely useful feature in Python that breaks down values from lists, tuples, or dictionary attributes into individual variables. It helps us write clean and readable code.</p>
<p><img decoding="async" loading="lazy" alt="Destructuring Dictionary Example" src="https://immersedincode.io.vn/assets/images/destructuring-dict-example-ce36481babb43a46850ce7decfe4a0a3.png" width="1880" height="660" class="img_ev3q"></p>
<p>Now, let’s explore it!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="destructuring-with-lists-and-tuples">Destructuring with Lists and Tuples<a href="https://immersedincode.io.vn/blog/destructuring-in-python#destructuring-with-lists-and-tuples" class="hash-link" aria-label="Direct link to Destructuring with Lists and Tuples" title="Direct link to Destructuring with Lists and Tuples">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="standard-concept">Standard concept<a href="https://immersedincode.io.vn/blog/destructuring-in-python#standard-concept" class="hash-link" aria-label="Direct link to Standard concept" title="Direct link to Standard concept">​</a></h3>
<p>We can easily unpack Lists or Tuples using the following syntax:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token comment" style="color:#6A9955"># list</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">first</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> second</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> third </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">6</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">8</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain">  </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">first</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 3</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">second</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">   </span><span class="token comment" style="color:#6A9955"># 6</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">third</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 8</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># tuple</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">one</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> two</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> three </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">2</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">one</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">      </span><span class="token comment" style="color:#6A9955"># 1</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">two</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">      </span><span class="token comment" style="color:#6A9955"># 2</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">three</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 3</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These are just the standard concepts for destructuring lists or tuples. At this point, we should be concerned with the order and number of elements of a list or a tuple.</p>
<ul>
<li>Using the wrong order will lead to incorrect data flow in the system. This can become a major issue for your system, where high data consistency is essential.</li>
<li>If the number of variables to be unpacked is not equal to the length of the object. It will raise a <code>ValueError</code> exception. For example:</li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">try</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    first</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> second</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> third</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> four </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">6</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">8</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain">  </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">except</span><span class="token plain"> ValueError </span><span class="token keyword" style="color:#0c4a6e">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"ValueError -"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># ValueError - not enough values to unpack (expected 4, got 3)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ignoring-values">Ignoring values<a href="https://immersedincode.io.vn/blog/destructuring-in-python#ignoring-values" class="hash-link" aria-label="Direct link to Ignoring values" title="Direct link to Ignoring values">​</a></h3>
<p>In practice, there are many cases where we just want to unpack some values in a list or a tuple. How can we do that? Luckily, we have some syntax to make this more convenient.</p>
<p>With an <code>_</code> character In place of a variable name. We can skip the unused element and move on to the next element in the list or tuple.</p>
<p>Code example:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">one</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> three</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> _ </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">2</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">4</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">5</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">one</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> three</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">   </span><span class="token comment" style="color:#6A9955"># 1 3</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="assign-the-remaining-values">Assign the remaining values<a href="https://immersedincode.io.vn/blog/destructuring-in-python#assign-the-remaining-values" class="hash-link" aria-label="Direct link to Assign the remaining values" title="Direct link to Assign the remaining values">​</a></h3>
<p>In some cases, we still want to use the remaining values. The <code>*</code> operator will help us do it. In Python, we can use the&nbsp;<code>*</code>&nbsp;operator to collect leftover values when performing a destructuring assignment.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">a</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token operator" style="color:#475569">*</span><span class="token plain">re </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token string" style="color:#64748b">"a"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"b"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"c"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"d"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"e"</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># a</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># b</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">re</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">   </span><span class="token comment" style="color:#6A9955"># ['c', 'd', 'e']</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token operator" style="color:#475569">*</span><span class="token plain">start</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> end </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"dog"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"cat"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"frog"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"crab"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">start</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># ['dog', 'cat', 'frog']</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">end</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">      </span><span class="token comment" style="color:#6A9955"># crab</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can use the <code>_</code> character and the <code>*</code> operator together to ignore the remaining values.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">a</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token operator" style="color:#475569">*</span><span class="token plain">_ </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token string" style="color:#64748b">"a"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"b"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"c"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"d"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"e"</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># a</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">start</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token operator" style="color:#475569">*</span><span class="token plain">_</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> end </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"a"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"b"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"c"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"d"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"e"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">start</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># a</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">end</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">      </span><span class="token comment" style="color:#6A9955"># e</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="destructuring-in-loops">Destructuring in loops<a href="https://immersedincode.io.vn/blog/destructuring-in-python#destructuring-in-loops" class="hash-link" aria-label="Direct link to Destructuring in loops" title="Direct link to Destructuring in loops">​</a></h2>
<p>We are familiar with the syntax of <code>for</code> loops. We can access each element in a list directly instead of using an index like in some other languages. This makes our code more Pythonic.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">users </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Bach"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"HCM"</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">2</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Nam"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"HN"</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Trung"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"NT"</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> user </span><span class="token keyword" style="color:#0c4a6e">in</span><span class="token plain"> users</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">user</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># (1, 'Bach', 'HCM')</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># (2, 'Nam', 'HN')</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># (3, 'Trung', 'NT')</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With destructuring syntax, we can access individual attributes inside an element in for loops. We can write clearer and more readable code. For example:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">users </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Bach"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"HCM"</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">2</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Nam"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"HN"</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Trung"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"PR-TC"</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">id</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> city </span><span class="token keyword" style="color:#0c4a6e">in</span><span class="token plain"> users</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"Id:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">id</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"- Name:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"- City:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> city</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Id: 1 - Name: Bach - City: HCM</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Id: 2 - Name: Nam - City: HN</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Id: 3 - Name: Trung - City: PR-TC</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Or you can even get the index of the element with the <code>enumerate</code> object.</p>
<blockquote>
<p>The enumerate object yields pairs containing a count (from start, which defaults to zero) and a value yielded by the iterable argument.
— <a href="https://docs.python.org/2/library/functions.html?highlight=enumerate#enumerate" target="_blank" rel="noopener noreferrer">Python Docs</a> —</p>
</blockquote>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">users </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Bach"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"HCM"</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">2</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Nam"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"HN"</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Trung"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"PR-TC"</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> index</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token builtin" style="color:#0c4a6e">id</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> city</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">in</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">enumerate</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">users</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"Index:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"- Id:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">id</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"- Name:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"- City:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> city</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Index: 0 - Id: 1 - Name: Bach - City: HCM</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Index: 1 - Id: 2 - Name: Nam - City: HN</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Index: 2 - Id: 3 - Name: Trung - City: PR-TC</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Furthermore, we can combine the use of the ignore values syntax and collect the remaining values.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">users </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">[</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Bach"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"HCM"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Python"</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">[</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">2</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Nam"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"HN"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"JavaScript"</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">[</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Trung"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"PR-TC"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"TypeScript"</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">id</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token operator" style="color:#475569">*</span><span class="token plain">values </span><span class="token keyword" style="color:#0c4a6e">in</span><span class="token plain"> users</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"Id:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">id</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"- Value:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> values</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Id: 1 - Value: ['HCM', 'Python']</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Id: 2 - Value: ['HN', 'JavaScript']</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Id: 3 - Value: ['PR-TC', 'TypeScript']</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="destructuring-dictionaries">Destructuring dictionaries<a href="https://immersedincode.io.vn/blog/destructuring-in-python#destructuring-dictionaries" class="hash-link" aria-label="Direct link to Destructuring dictionaries" title="Direct link to Destructuring dictionaries">​</a></h2>
<p>In my work, I often encounter situations where I need to handle objects/dictionaries with many key-value pairs.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="standard-concept-1">Standard concept<a href="https://immersedincode.io.vn/blog/destructuring-in-python#standard-concept-1" class="hash-link" aria-label="Direct link to Standard concept" title="Direct link to Standard concept">​</a></h3>
<p>Let's evaluate the example below.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">customer </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"first_name"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"John"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"last_name"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Cena"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"age"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">23</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"email"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"johncena@gmail.com"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">one</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> two</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> three</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> four </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> customer</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f"One '</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">one</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">', two '</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">two</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">', three '</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">three</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">', four '</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">four</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">'"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># One 'first_name', two 'last_name', three 'age', four 'email'</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">one</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> two</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> three</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> four </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> customer</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">values</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f"One '</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">one</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">', two '</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">two</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">', three '</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">three</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">', four '</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">four</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">'"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># One 'John', two 'Cena', three '23', four 'johncena@gmail.com'</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example, when we try to get the variables <code>one</code>, <code>two</code>, <code>three</code>, and <code>four</code>, these variables will receive the corresponding values of the keys from the <code>customer</code> dictionary. Or we can get the list of values of the keys in that order by using the <code>.values()</code> method of the dictionary.</p>
<p>Instead of using the above approach, we can directly get the values from the dictionary using their keys.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f"Customer email </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">customer</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">[</span><span class="token string-interpolation interpolation string" style="color:#64748b">'email'</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">]</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">, age </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">customer</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">[</span><span class="token string-interpolation interpolation string" style="color:#64748b">'age'</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">]</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Customer email johncena@gmail.com, age 23</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you access an unknown key, it will throw a <code>KeyError</code> exception.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="advanced-techniques">Advanced techniques<a href="https://immersedincode.io.vn/blog/destructuring-in-python#advanced-techniques" class="hash-link" aria-label="Direct link to Advanced techniques" title="Direct link to Advanced techniques">​</a></h3>
<p>The above approaches are completely fine, and you can get the job done quickly without much effort.</p>
<p>But maintaining or reading that code is a nightmare. Imagine you have a dictionary with hundreds of keys (or even more), each part where you access a key of the dictionary and perform logic with it. After a few weeks or months, you get a task related to that code. That's where the nightmare begins.</p>
<p>To solve that problem, we should group the declarations of the variables we need to use together. And I found a way to do that while keeping our code clean and readable.</p>
<p>We can use&nbsp;<a href="https://docs.python.org/3/library/operator.html" target="_blank" rel="noopener noreferrer"><code>operator</code></a>&nbsp;module from the standard library as follows:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> operator </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> itemgetter</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">current_user </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"id"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"username"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"pxuanbach"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"email"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"pxuanbach@gmail.com"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"phone"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"832819201"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"full_name"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Bach Pham"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"gender"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"Male"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"website"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"immersedincode.io.vn"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token builtin" style="color:#0c4a6e">id</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> email</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> gender</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> username </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> itemgetter</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">'id'</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'email'</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'gender'</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'username'</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">current_user</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"Id:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">id</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"- Email:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> email</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"- Gender:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> gender</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"- Username:"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> username</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Id: 1 - Email: pxuanbach@gmail.com - Gender: Male - Username: pxuanbach</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the example above, the value of each variable will correspond to the order of keys in the <code>itemgetter</code> function. Additionally, If you access an unknown key, the function will throw a <code>KeyError</code> exception.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://immersedincode.io.vn/blog/destructuring-in-python#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>So we've covered destructuring lists, tuples, for loops, and dictionaries. I hope this article is helpful to you.</p>
<p>If you need a project to run a demo on your environment, here is my&nbsp;<a href="https://github.com/pxuanbach/Destructuring-in-Python" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://immersedincode.io.vn/blog/destructuring-in-python#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://blog.teclado.com/destructuring-in-python/" target="_blank" rel="noopener noreferrer">Destructuring in Python (teclado.com)</a></li>
<li><a href="https://stackoverflow.com/a/63600600/22865115" target="_blank" rel="noopener noreferrer">Destructuring dicts and objects in Python (stackoverflow.com)</a></li>
</ul>]]></content>
        <author>
            <name>Bach Pham</name>
            <uri>https://github.com/pxuanbach</uri>
        </author>
        <category label="python" term="python"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Essential modules for developing applications with FastAPI (P3 - Caching)]]></title>
        <id>https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching</id>
        <link href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching"/>
        <updated>2024-04-20T10:00:00.000Z</updated>
        <summary type="html"><![CDATA[Hello, we meet again!]]></summary>
        <content type="html"><![CDATA[<p>Hello, we meet again!</p>
<p>In the previous post, I introduced two quite important modules in a project, which are Migration and Logging. In this article, I will introduce the Caching module.</p>
<p>I hope you enjoy it!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="frameworklibrary-version">Framework/Library version<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching#frameworklibrary-version" class="hash-link" aria-label="Direct link to Framework/Library version" title="Direct link to Framework/Library version">​</a></h2>
<p>This project uses <a href="https://www.python.org/" target="_blank" rel="noopener noreferrer">Python</a> 3.10 as the environment and <a href="https://python-poetry.org/" target="_blank" rel="noopener noreferrer">Poetry</a> as the package manager.</p>
<p>The code and examples in this post will use frameworks/libraries with the following versions.</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./pyproject.toml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">[tool.poetry.dependencies]</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python = "^3.10"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">uvicorn = {extras = ["standard"], version = "^0.24.0.post1"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">fastapi = "^0.109.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python-multipart = "^0.0.7"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">email-validator = "^2.1.0.post1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">passlib = {extras = ["bcrypt"], version = "^1.7.4"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">tenacity = "^8.2.3"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">pydantic = "&gt;2.0"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">emails = "^0.6"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">gunicorn = "^21.2.0"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">jinja2 = "^3.1.2"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">alembic = "^1.12.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python-jose = {extras = ["cryptography"], version = "^3.3.0"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">httpx = "^0.25.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">psycopg = {extras = ["binary"], version = "^3.1.13"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">sqlmodel = "^0.0.16"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Pin bcrypt until passlib supports the latest</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">bcrypt = "4.0.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">pydantic-settings = "^2.2.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">sentry-sdk = {extras = ["fastapi"], version = "^1.40.6"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">psycopg2 = "^2.9.9"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">asyncpg = "^0.29.0"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">redis = {extras = ["hiredis"], version = "^5.0.3"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">orjson = "^3.10.0"</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="caching">Caching<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching#caching" class="hash-link" aria-label="Direct link to Caching" title="Direct link to Caching">​</a></h2>
<p>We will explore integrating a caching module into FastAPI. This caching module will automatically store the results of previous API requests, thereby improving response times and reducing server load. There are many other places where you can cache data, such as In-memory, Redis, DynamoDB,… This section will implement a simple Redis caching solution for APIs.</p>
<p>First, we should install the <a href="https://github.com/redis/redis-py" target="_blank" rel="noopener noreferrer">Redis</a> package.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">poetry add redis   # pip install redis</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prepare-an-adapter-for-redis">Prepare an adapter for Redis<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching#prepare-an-adapter-for-redis" class="hash-link" aria-label="Direct link to Prepare an adapter for Redis" title="Direct link to Prepare an adapter for Redis">​</a></h3>
<p>When working with Redis, we must manage connecting and disconnecting to Redis as necessary. Additionally, certain features require additional logic to integrate with the system seamlessly.</p>
<p>So, I define some functions that I want to use such as…</p>
<ul>
<li>Connect.</li>
<li>Disconnect.</li>
<li>Add a key to Redis.</li>
<li>Check the key exists in Redis.</li>
</ul>
<p>Let’s build it.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/redis.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> Dict</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> Tuple</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">asyncio </span><span class="token keyword" style="color:#0c4a6e">as</span><span class="token plain"> aioredis</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> logging</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">utils </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> ORJsonCoder</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RedisClient</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">connect</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> redis_url</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">pool </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> aioredis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ConnectionPool</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">from_url</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">redis_url</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> aioredis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">Redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">from_pool</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">pool</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ping</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"Redis connected"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"Cannot connect to Redis"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">add_to_cache</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Dict</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> expire</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">bool</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        response_data </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            response_data </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> ORJsonCoder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">except</span><span class="token plain"> TypeError</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            message </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#64748b">f"Object of type </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation builtin" style="color:#0c4a6e">type</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">(</span><span class="token string-interpolation interpolation">value</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">)</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b"> is not JSON-serializable"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        cached </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token builtin" style="color:#0c4a6e">set</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">name</span><span class="token operator" style="color:#475569">=</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> value</span><span class="token operator" style="color:#475569">=</span><span class="token plain">response_data</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> ex</span><span class="token operator" style="color:#475569">=</span><span class="token plain">expire</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> cached</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f"</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">key</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b"> added to cache"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># pragma: no cover</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f"Failed to cache key </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">key</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> cached</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">check_cache</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> Tuple</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        pipe </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">pipeline</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        ttl</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> in_cache </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> pipe</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ttl</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> in_cache</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string-interpolation string" style="color:#64748b">f"Key </span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">key</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b"> found in cache"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">ttl</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> in_cache</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">disconnect</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ping</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">aclose</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"Redis disconnected"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">redis_client </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> RedisClient</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this class, you might wonder about the <code>ORJsonCoder</code> module. Where is it? What can it do?</p>
<p>This module provides methods to perform JSON encoding and decoding using the <a href="https://github.com/ijl/orjson" target="_blank" rel="noopener noreferrer">orjson</a> library, aimed at increasing speed and performance compared to standard JSON libraries in Python.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/utils/orjson_coder.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> Union</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">encoders </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> jsonable_encoder</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> orjson</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ORJsonCoder</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">encode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">cls</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">bytes</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> orjson</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            value</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            default</span><span class="token operator" style="color:#475569">=</span><span class="token plain">jsonable_encoder</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            option</span><span class="token operator" style="color:#475569">=</span><span class="token plain">orjson</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">OPT_NON_STR_KEYS </span><span class="token operator" style="color:#475569">|</span><span class="token plain"> orjson</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">OPT_SERIALIZE_NUMPY</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">decode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">cls</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Union</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">bytes</span><span class="token plain"> </span><span class="token operator" style="color:#475569">|</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> orjson</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implement-logic-for-caching">Implement logic for caching<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching#implement-logic-for-caching" class="hash-link" aria-label="Direct link to Implement logic for caching" title="Direct link to Implement logic for caching">​</a></h3>
<p>Next, we will create a module to provide caching features based on <code>RedisClient</code>. To clarify what we need, let's explore the concept of Redis a bit.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-redis">What is Redis?<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching#what-is-redis" class="hash-link" aria-label="Direct link to What is Redis?" title="Direct link to What is Redis?">​</a></h4>
<blockquote>
<p>Redis (<strong>RE</strong>mote&nbsp;<strong>DI</strong>ctionary&nbsp;<strong>S</strong>erver) is an open source, in-memory, NoSQL&nbsp;key/value store that is used primarily as an application cache or quick-response database.
<a href="https://www.ibm.com/topics/redis" target="_blank" rel="noopener noreferrer"><em>— By IBM —</em></a></p>
</blockquote>
<p>So, to effectively use Redis as a cache, we need an efficient strategy for creating keys and values. Fortunately, Redis now supports various <a href="https://redis.io/docs/latest/develop/data-types/" target="_blank" rel="noopener noreferrer">data types</a> such as strings, hashes, lists, sets, sorted sets, and JSON…</p>
<p>Another thing to keep in mind is what to cache and how long to keep it in cache.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-to-cache">What to cache?<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching#what-to-cache" class="hash-link" aria-label="Direct link to What to cache?" title="Direct link to What to cache?">​</a></h4>
<blockquote>
<p>We don't want to cache many keys that change continuously.
We don't want to cache many keys that are requested very rarely.
We want to cache keys that are requested often and change at a reasonable rate. For an example of key not changing at a reasonable rate, think of a global counter that is continuously&nbsp;<a href="https://redis.io/docs/latest/commands/incr/" target="_blank" rel="noopener noreferrer">INCR</a>emented.
<a href="https://redis.io/docs/latest/develop/use/client-side-caching/#what-to-cache" target="_blank" rel="noopener noreferrer">— By Redis Docs —</a></p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="how-long-to-keep-it">How long to keep it?<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching#how-long-to-keep-it" class="hash-link" aria-label="Direct link to How long to keep it?" title="Direct link to How long to keep it?">​</a></h4>
<p>This is a question that you need to answer for yourself; everything depends on the logic of your system.</p>
<p>Some systems use Redis to implement a whitelist strategy for their authorization tokens, so the time to keep that key in the cache memory could be the token's lifespan.</p>
<p>They also implement data caching for high-traffic APIs with large response data, where the data returned from these APIs has minimal changes. The time to keep the key in the cache memory could be either the time it takes for a change to occur or just enough time to ensure users aren't stuck with outdated data for too long.</p>
<p>Suppose you have complex computational tasks that are time-consuming or require significant computational resources. In that case, you can use cron jobs (schedule jobs) to precompute the results and store them in the cache to optimize user experience and system resource utilization.</p>
<p>Next, let's take a quick look at this code snippet.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/cache.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> Any</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> urllib</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">parse </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> urlencode</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> Request</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">datastructures </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> QueryParams</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> redis_client</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">utils </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> ORJsonCoder</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">query_params_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">params</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> QueryParams</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    sorted_query_params </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">sorted</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">params</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> urlencode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">sorted_query_params</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> doseq</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">req_key_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token operator" style="color:#475569">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token string" style="color:#64748b">":"</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        req</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">method</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        req</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">url</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        query_params_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">query_params</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">add</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> expire</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">60</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain">   </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    cached </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">add_to_cache</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req_key_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> expire</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">not</span><span class="token plain"> cached</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">check_exist</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    key </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> req_key_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    ttl</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> in_cache </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">check_cache</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> in_cache</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">load_cache_data</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> ORJsonCoder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><strong>query_params_builder</strong>: The order of sent query parameters may be inconsistent. Therefore, we need a function to ensure consistency for the query parameters.</li>
<li><strong>req_key_builder</strong>: This function is used to create a unique key based on the incoming request. The value of the key will look like <code>get:/api/v1/users:limit=20&amp;skip=0</code>.</li>
<li><strong>add</strong>: As the name suggests, add a key/value pair to Redis with the corresponding parameters.</li>
<li><strong>check_exist</strong>: Used to check whether the data exists in the cache or not.</li>
<li><strong>load_cache_data</strong>: Simply used to decode the data retrieved from the cache.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="integration-with-fastapi">Integration with FastAPI<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching#integration-with-fastapi" class="hash-link" aria-label="Direct link to Integration with FastAPI" title="Direct link to Integration with FastAPI">​</a></h3>
<p>After all the preparations are complete, the remaining task is to integrate it into the FastAPI application seamlessly.</p>
<p>First, connect to Redis.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/main.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> FastAPI</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> contextlib </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> asynccontextmanager</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">config </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> settings</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> redis_client</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#475569">@asynccontextmanager</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">lifespan</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># start up</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:#475569">(</span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">settings</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">REDIS_URL</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">yield</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># shut down</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">disconnect</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">app </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    title</span><span class="token operator" style="color:#475569">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">PROJECT_NAME</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    openapi_url</span><span class="token operator" style="color:#475569">=</span><span class="token string-interpolation string" style="color:#64748b">f"</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">settings</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation">API_STR</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">settings</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation">API_VERSION_STR</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">/openapi.json"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    lifespan</span><span class="token operator" style="color:#475569">=</span><span class="token plain">lifespan</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Second, let's do a simple example. I have an API that returns user information as follows.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/api/user.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token decorator annotation punctuation" style="color:#475569">@router</span><span class="token decorator annotation punctuation" style="color:#475569">.</span><span class="token decorator annotation punctuation" style="color:#475569">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">""</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> response_model</span><span class="token operator" style="color:#475569">=</span><span class="token plain">List</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">User</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">get_pagination_cache</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    skip</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Query</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    limit</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Query</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">20</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    session</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> AsyncSession </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Depends</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">get_async_session</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    data </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> user</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">get_pagination</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">session</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> skip</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> data</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now I will implement caching logic for this API. In FastAPI, you can use <a href="https://fastapi.tiangolo.com/tutorial/background-tasks/" target="_blank" rel="noopener noreferrer">Background Tasks</a> to cache asynchronously, which reduces system load and request latency.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/api/user.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token decorator annotation punctuation" style="color:#475569">@router</span><span class="token decorator annotation punctuation" style="color:#475569">.</span><span class="token decorator annotation punctuation" style="color:#475569">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">""</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> response_model</span><span class="token operator" style="color:#475569">=</span><span class="token plain">List</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">User</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">get_pagination_cache</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    request</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    bg_tasks</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> BackgroundTasks</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    skip</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Query</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    limit</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Query</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">20</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    session</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> AsyncSession </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Depends</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">get_async_session</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    in_cache </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">check_exist</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token operator" style="color:#475569">=</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> in_cache</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">load_cache_data</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">in_cache</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    data </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> user</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">get_pagination</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">session</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> skip</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    bg_tasks</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">add_task</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">cache</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> req</span><span class="token operator" style="color:#475569">=</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> data</span><span class="token operator" style="color:#475569">=</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> expire</span><span class="token operator" style="color:#475569">=</span><span class="token number" style="color:#B5CEA8">60</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> data</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When a user calls this API, it will check the corresponding key in Redis. If this key exists, it will return the value of the key without querying the database. If the key does not exist, the system will query the database to retrieve the data as usual. Once the data is obtained, we return it and simultaneously store it in the cache with an expiration time of 60 seconds.</p>
<p>I will insert approximately 20,000 records and use the <code>/users</code> API to retrieve that information. The larger the data, the more noticeable the difference in response time will be.</p>
<p>Let's see what changes now. In the first usage, the API response time falls around 223 ms.</p>
<p><img decoding="async" loading="lazy" alt="Test API Nocache" src="https://immersedincode.io.vn/assets/images/test-api-nocache-b807ee3e35ae6bd3e8f514336925ae12.png" width="1493" height="531" class="img_ev3q"></p>
<p>In the second usage, the response time falls around 136 ms.</p>
<p><img decoding="async" loading="lazy" alt="Test API Cached" src="https://immersedincode.io.vn/assets/images/test-api-cached-0312526561d3640715f1f3f7af6de04c.png" width="1461" height="531" class="img_ev3q"></p>
<p>If you have <a href="https://redis.io/insight/" target="_blank" rel="noopener noreferrer">Redis Insight</a> on your machine, you can connect to Redis and view the values stored within it.</p>
<p><img decoding="async" loading="lazy" alt="Redis Insight" src="https://immersedincode.io.vn/assets/images/redis-insight-f387145bfa493f325cf3fa93c745ed20.png" width="1876" height="863" class="img_ev3q"></p>
<p>Additionally, you will need to pay attention to response headers such as <code>Cache-Control</code>, <code>ETag</code>, <code>Vary</code>,…</p>
<p>Some packages that you may be interested in:</p>
<ul>
<li><a href="https://github.com/long2ice/fastapi-cache" target="_blank" rel="noopener noreferrer">long2ice/fastapi-cache (github.com)</a> (1.1k stars, 132 forks on 18/04/2024)</li>
<li><a href="https://github.com/madkote/fastapi-plugins" target="_blank" rel="noopener noreferrer">madkote/fastapi-plugins (github.com)</a> (334 stars, 19 forks on 18/04/2024)</li>
<li><a href="https://github.com/comeuplater/fastapi_cache" target="_blank" rel="noopener noreferrer">comeuplater/fastapi_cache (github.com)</a> (208 stars, 16 forks on 18/04/2024)</li>
<li><a href="https://github.com/a-luna/fastapi-redis-cache" target="_blank" rel="noopener noreferrer">a-luna/fastapi-redis-cache (github.com)</a> (143 stars, 23 forks on 18/04/2024)</li>
<li><a href="https://github.com/mailgun/expiringdict" target="_blank" rel="noopener noreferrer">mailgun/expiringdict (github.com)</a> (335 stars, 75 forks on 18/04/2024)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>Well, that’s it. I have discussed some approaches to implementing caching for APIs with FastAPI as well as some related aspects.</p>
<p>I hope this post was useful. If you need a project to run a demo on your environment, here is my&nbsp;<a href="https://github.com/pxuanbach/fastapi-essential-modules" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://www.ibm.com/topics/redis" target="_blank" rel="noopener noreferrer">What is Redis Explained? | IBM</a></li>
<li><a href="https://redis.io/docs/latest/develop/use/client-side-caching/" target="_blank" rel="noopener noreferrer">Client-side caching in Redis | Docs (redis.io)</a></li>
<li><a href="https://redis.io/docs/latest/develop/data-types/" target="_blank" rel="noopener noreferrer">Understand Redis data types | Docs (redis.io)</a></li>
</ul>]]></content>
        <author>
            <name>Bach Pham</name>
            <uri>https://github.com/pxuanbach</uri>
        </author>
        <category label="caching" term="caching"/>
        <category label="fastapi" term="fastapi"/>
        <category label="redis" term="redis"/>
        <category label="python" term="python"/>
        <category label="essential-modules-fastapi" term="essential-modules-fastapi"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Dockerize MedusaJS Components: Optimize and Deploy Your Application]]></title>
        <id>https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment</id>
        <link href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment"/>
        <updated>2024-04-14T10:00:00.000Z</updated>
        <summary type="html"><![CDATA[Today, I say "Hi Medusa!”.]]></summary>
        <content type="html"><![CDATA[<p>Today, I say "Hi Medusa!”.</p>
<p>Recently, I received a request from my director. It involves developing an e-commerce product for a retail business client group. They require a customized solution for self-deployment in their environment.</p>
<p>The requirement is for an e-commerce source code that I and teammates can customize, and add features to meet the needs of each customer. After researching through various open-source platforms such as WooCommerce, Vendure, Saleor,... we decided to choose MedusaJS.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-medusajs">What is MedusaJS?<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#what-is-medusajs" class="hash-link" aria-label="Direct link to What is MedusaJS?" title="Direct link to What is MedusaJS?">​</a></h3>
<p>MedusaJS is a set of commerce modules and tools that allow you to build rich, reliable, and performant commerce applications without reinventing core commerce logic. The modules can be customized and used to build advanced e-commerce stores, marketplaces, or any product that needs foundational commerce primitives. All modules are open-source and freely available on npm.</p>
<p>Learn more about&nbsp;<a href="https://docs.medusajs.com/development/fundamentals/architecture-overview" target="_blank" rel="noopener noreferrer">Medusa’s architecture</a>&nbsp;and&nbsp;<a href="https://docs.medusajs.com/modules/overview" target="_blank" rel="noopener noreferrer">commerce modules</a>&nbsp;in the Docs.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-containerize-medusa-applications">Why containerize Medusa applications?<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#why-containerize-medusa-applications" class="hash-link" aria-label="Direct link to Why containerize Medusa applications?" title="Direct link to Why containerize Medusa applications?">​</a></h3>
<p>The benefits of dockerizing an application, specifically Medusa, are manifold:</p>
<ol>
<li>Set up development environments swiftly: With Docker Compose, you can set up your development environment with just a few commands. For instance, cloning source code, creating a <code>.env</code> file, and running <code>docker-compose up -d</code>.</li>
<li>Deploy easily in the cloud or on-premises: Once you build your Docker images, you can run them consistently on any server environment. It also helps you automate your application deployment and version management.</li>
<li>Ensure scalability and flexibility: Dockerized applications are easier to scale and expand. By using Docker Swarm or Kubernetes, you can automatically scale the number of application containers to meet user demand without the need to reconfigure infrastructure.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h2>
<p>Some packages we need to install before proceeding further in this post.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker--docker-compose">Docker &amp; Docker Compose<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#docker--docker-compose" class="hash-link" aria-label="Direct link to Docker &amp; Docker Compose" title="Direct link to Docker &amp; Docker Compose">​</a></h3>
<p>Visit the official link below and download the version that corresponds to your environment.</p>
<p><a href="https://www.docker.com/products/docker-desktop/" target="_blank" rel="noopener noreferrer">Docker Desktop: The #1 Containerization Tool for Developers | Docker</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="node-or-nvm">Node or NVM<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#node-or-nvm" class="hash-link" aria-label="Direct link to Node or NVM" title="Direct link to Node or NVM">​</a></h3>
<p>Visit the official link below and download the version that corresponds to your environment.</p>
<p><a href="https://nodejs.org/en/download" target="_blank" rel="noopener noreferrer">Node.js — Download Node.js® (nodejs.org)</a></p>
<p>I suggest you install version 18 or greater because:</p>
<ul>
<li>Backend Admin needs Node v16+</li>
<li>Storefront needs Node v18+</li>
</ul>
<p><strong>Or</strong> install <a href="https://github.com/nvm-sh/nvm?tab=readme-ov-file#installing-and-updating" target="_blank" rel="noopener noreferrer">nvm</a> instead to install any version of NodeJS</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"># Or</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If your environment is Windows, you may like this one</p>
<p><a href="https://github.com/coreybutler/nvm-windows?tab=readme-ov-file" target="_blank" rel="noopener noreferrer">coreybutler/nvm-windows: A node.js version management utility for Windows. Ironically written in Go. (github.com)</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="git">Git<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#git" class="hash-link" aria-label="Direct link to Git" title="Direct link to Git">​</a></h3>
<p>Visit the official link below and download the version that corresponds to your environment.</p>
<p><a href="https://git-scm.com/downloads" target="_blank" rel="noopener noreferrer">Git - Downloads (git-scm.com)</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="medusa-cli">Medusa CLI<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#medusa-cli" class="hash-link" aria-label="Direct link to Medusa CLI" title="Direct link to Medusa CLI">​</a></h3>
<p>To install the Medusa backend, you need Medusa's CLI tool.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">npm install -g @medusajs/medusa-cli</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once done, check the version using this command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">medusa --version</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Medusa CLI Version" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAeMAAAAkCAYAAAC67VKAAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAsFSURBVHhe7Z3Pix3HEcf15/iQhMQYEhByhAJJdDFGYOKcLEd2EAl79NUH7yIQGHzwzUgscm4LWl1zctBGAR/2D9D/4L/Ap05XV/dMVXV1z8zuvB/S+x4+7Htd3dXV1Y/6Ts++nb1x76+fBeKdX7wHAAAAgB1ww2sEAAAAwPaAGAMAAAA7BmIMAAAA7Ji3UoxPzi/Dy9OHrm2fQJweD8PTi+3mZRvre1P2+qqcnX0cfnryO9cGJEfhi+/Owzdfnzg2cMi4Yvyrv/wh3Dz7W/j9f/+RoNfU5vVlHofnl5fhUnL+uGt//kiO7/DohRh3EZ4+cPpYHjwLLy+ehfu2Pfl6EU6m2rZFK84C2Wndso/KBzMU+dxfFn0SAVpfETl3bJlH7hnNU+bt5tPxZ/stYlqMVxe2qX1YAYgxYCDGwKcS4988+HN4/z8Pw+3//VNBbb/+5I+q7wiL7SiwufCn4n71k87904tY4KUAR1/nc4omz1kJ/r6JcSvODK3/5enj2EfkwMYrBTgJaBwziGrcF3qv1ufsR/IR+12IfslXyfXMfMpYZL9FOPEZ1he2/j6swcbFmPZCXQBvF4gxANdDi/G7vw03//VJJcQFslEfNSZhxTiSC3Up9LNOtArHZ0U+cXtFSImJaLPCq9q4KI8nvVrEBpuYsxRavnhg+xh3z2fEizMxCgSLci7knTWkn/Fi5WkR1fj++SPKkbmgiX6VMKQ9ehGe2nlkXPZ9aWvEwm3tnLXzYuPLexztMr8KefEh29XFBOVA2p24vfWlfFL/OP4RX2xov8VfpLu+siZul5/rtK5hrB0n4zQ2FW+22TX0OL4bfj67E1798HH4+ccPw6vjO+GnH+PrH+6E49yHbZmzW2q8skWKGFP76+Ox3/GTD9VYPe5uOMvtlU3EsToffRu++e7b8EGz7V74/Ot4gqVTLPHl0dDvgy/Pw1dH98LNo+8H+xcfFT9mnJhD9pf+mHxiLgwnZ/L3ffj8trSbuMFbgRLjX/7p/XDr3393hZggG/WRYxgucq4YDwVkoSB7hb4iF1dVBKXNzOn5FG26KGpIcG3BLIKRbCKO5CcXxZ5PxomTyAKZYqUYS5H11pAveJItzkVz0l6cnFM/61/HrueKfeU8qrDPzKe4+OrlrJ0X2Y/mNLFG/FOmXRe/5znyaxG/jo1orY8/17zHOp+99Vn/Y8zcryXGvc/L/dN4wTTEZ9fLjHGObU1IjKPokXDSyZaF8VZ4TcL8aW4zIloE19rkybgnxlaYJcdP7qZ5y3s53/qwuI0imsUyiyQJ7iiYLLAkwIONRDHb07gsntJHi7qP9j8IeupTxJ0E2esL3hY2JMZ1EU1FhgTLKa4uXqFfSFXYPJ+ijWP05qT1OOOyWKUCKIVLCGnb54hXgHWbEAo3L2wfxtD8UYifp/FibOrrFHERL60l7aNYX+lXxdmJZSpn7byU+J7F8f5nZRQ20e7FktflCeDs9Yk95jmn1yfzWWzj+Bli7OalpopXtqs9b0BinE+fUkyLGL82p9bS/51P6QStbYvE2Ppt0BPuNdCiSCJXBI+E2jk1Z8FNYix/53v7JHyV+yefEyfXSoy9U3r2WcS3ddEA3h5WvU1dxLYruKlQxT5OEVF4xXUptih6Pk1bEla7hhKzpSrUwq/A9SmpinddsIc5vDWk8UKM1Xh6PV+M02vykYVFilUVZycW/ilyVRA+/bxwfNzuC4qb7068Xj7bsZv1VXucxbizvsqPGl/HYkXVz0vEm7Mpxr5N0RFjFtx8u1hyTTEufYs/dfL15pwjxkm48mnV3sadtOX39LoIbDUmI8S4dzIdTs4Rr58rxlLciRwbxPhwqL7ARV/Suv4XuPqkYmELpyUXnrk+W6jC7RRJt4gneE1prDdO4IqDi/BpbHWcpugSVOgdEeHiy79TrX3b4j8hxskeRfDUz4uKsxPLVM40Mi9jfMWX9eHm2xPX3OYJYGvfq/XlPmO7FOPG+hzbOL6OJa3TFU6Zl/qz442jebycuUyKceMEe00xlrwWgixfE5s+GUuhI4EbhFOKtMOUGI/wrXDbd9bJOLdBjA+HSoyJq/5p0zzh5GI0edUeqQtLHKu+Tc3zdn2pomvjHAt/NU7Z+jGrAt6lM5+M0xOKVOCjCJBN5iS95zWtI8aR6PNlFGRPrKo4G7FM5UwjY9Lxpc+AiSOJUBWbFava55iDWtgG7Pry63GPaSzdpu6tT3/O+KJCxzLMnXPm+5F9zWc37Zke5+Wqy8RtahLVnogWweVbz1qMB1GlOTonXNlX+hxOyRsV4yLCR1HwpBiyALYEb74Ys59JMa5EW46DGB8KrhgvxxQKSSk2klkFmmFBLtjbljxv358pxKWIFYaxubi6Nt9eCmpbjKd81n0pTt8f2+t8jjnpjvNiiaT+1Uku59Ut7GOcvVhkX9mH43NiMfswrqP0lb7N+GFsjrvhc2iP1HkqcN9hfQ0x5lg6fmVuYhzqQkl+BqP/k+GEW/sb1zCKOsPffh/sNJ/oO4sJMabXSZBJFDOVyGbBJEEebPJ2c/R/Jk641p8U2yLqzN3wauMnYyJ/S7kStyzI+XazvOXcFuN6zOjXsSl7jqNqhxgfCiuJ8Z4jiqpr3xcQ54YQAuvaDW/c+gAAbzqHIcbgwFkoxgAAsGUgxuAAgBgDAPYbiDEAAACwYyDGAAAAwI6BGAMAAAA7BmIMAAAA7Ji9E+P23+yCdej9DTEAAIBdsI4Y54cYSBElUZ39WD7BzsWY/sZ0eLCCeNBE829PnQc1RPb3gmKfxHh5LPy5Gpn9DWnzsBc1rmcDAIAtsI4YJ6G6mPin9vPYpRjzE47Mk57K4zcnHwTBooxT/UzSRU9+itRVLwySiNqnfnnQ3pgLK/UUrZYNAAC2w3pi3P2n9ub0qB7bZ2wRFjRul6eUJJbDWDtOCr+xzSr2fEprnopojWuKcSr65mJFtZk1iJyVCxb5eMQx7nZe1OMUq0cn5lNqYVgr+aN9lHYTdxlb+WwR+2f/KaarinGa9yrCyfH6e92zAQDAZlhRjNv/1D7dWjQiWkRL2+TJmPvJoijFWL62zPkn7BWeOErWFmOn6Ms1TeZMiJ8UtF5eCnUfGzu/5z75tbmw0uvktUzN6yFj9+xdJvekBcQYALBfrCLGQ3Gn24bmn9rzTyNyuYjybUZtWyTGPfEU1OLjsHUxtnHR+CJ47ZzR/EmMZSwij3PyUuXDW3v2ObUP1yX5WiSoHE85wV9FNKv8zbQBAMCmWFeMVeFmceGiPhbPgVjwriPGpW/xp0TQm3NKPHYgxmr99Lr47+SM7GOOhC9BMy8ZV4zt2nJsc/bhOiwXY8nynKf5GvvcswEAwCZZTYzrgsiFUgmOxbEtEeMRvrXI4+TrqXGCLIDNk9YmxFisUeWwl7PIlBiP1Lkgqnx4FyK5bdk+LCf5urIYL4sl9W38jrlnAwCATbN5Mc4/eyJaCj0XxCIeRtySOLT8yL7aZxHZOQWbT5RSlKLfDX+bmnP3OI418zZztkSM/ZhSnpVvK9pyHL/uizGPn5NjS/Ll5bXsWzfnZq+Jxjj+bEGIAQD7ySpi7IuDLOJZXKhIZob+RWSJWMypMA62UliJWFxX+SfsE7AgF0SBlnEWYkxuLJE6Hy1aQtbOWVuMe3nx4xztOY6qncetK8aNWKSAuqJaj1NC3Bxn1lZI+9e2tS8CAABgXVYRYwAAAABcHYgxAAAAsGMgxgAAAMCOgRgDAAAAOwZiDMCBEi5vNPH6AwA2xXvh/7gGiB03Se3IAAAAAElFTkSuQmCC" width="483" height="36" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-medusa-backend">Create Medusa Backend<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#create-medusa-backend" class="hash-link" aria-label="Direct link to Create Medusa Backend" title="Direct link to Create Medusa Backend">​</a></h3>
<p>We can easily create the backend with the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">npx create-medusa-app --skip-db</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I use the <code>—skip-db</code> option because I will have a different setup later.</p>
<p>Now wait a moment…</p>
<p><img decoding="async" loading="lazy" alt="Create Medusa App" src="https://immersedincode.io.vn/assets/images/create-medusa-app-daaf0cf6aff936479aebf907c10bfadd.png" width="903" height="424" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-medusa-storefront">Create Medusa Storefront<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#create-medusa-storefront" class="hash-link" aria-label="Direct link to Create Medusa Storefront" title="Direct link to Create Medusa Storefront">​</a></h3>
<p>Create a new Next.js project using the&nbsp;<a href="https://github.com/medusajs/nextjs-starter-medusa" target="_blank" rel="noopener noreferrer">Medusa starter Storefront</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">npx create-next-app -e https://github.com/medusajs/nextjs-starter-medusa storefront</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="containerize-medusa-application">Containerize Medusa application<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#containerize-medusa-application" class="hash-link" aria-label="Direct link to Containerize Medusa application" title="Direct link to Containerize Medusa application">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="backend">Backend<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#backend" class="hash-link" aria-label="Direct link to Backend" title="Direct link to Backend">​</a></h3>
<p>First, create the <code>develop.sh</code> file with this content and place it in the <code>/backend</code> folder.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./backend/develop.sh</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">#!/bin/bash</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">medusa migrations run</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">medusa $1</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, create a <code>Dockerfile</code> with this content in the same directory as in the previous step.</p>
<div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./backend/Dockerfile</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">### Dependencies ###</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">FROM node:20-alpine as deps</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">WORKDIR /app/</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Copy backend package package.json and yarn.lock from /backend</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY ./package*.json .</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY ./yarn.lock? .</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Install deps</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">RUN yarn install --frozen-lockfile</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">### Build ###</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">FROM node:20-alpine as builder</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">WORKDIR /app/</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Copy cached node_modules from deps</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY --from=deps /app/node_modules /app/node_modules</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Install python and medusa-cli</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">RUN apk update</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">RUN apk add python3</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">RUN yarn global add @medusajs/medusa-cli@latest</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Copy app source code</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY . /app</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Build the app</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">RUN yarn build</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Start the image with a shell script</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">ENTRYPOINT ["/bin/sh", "./develop.sh", "start"]</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The result:</p>
<p><img decoding="async" loading="lazy" alt="Container Medusa Application Backend Result" src="https://immersedincode.io.vn/assets/images/containerize-medusa-app-backend-result-962331292fe40bda0c13eb185c260391.png" width="1228" height="976" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="admin-ui">Admin UI<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#admin-ui" class="hash-link" aria-label="Direct link to Admin UI" title="Direct link to Admin UI">​</a></h3>
<p>According to the announcement, the admin UI source code has been moved into the core repository since version 1.8. So, we won't have the source code to build the Docker image anymore.</p>
<p>Wait, hold on…</p>
<p>When you run the command <code>medusa develop</code>, the admin UI will build static javascript and HTML files into the <code>/backend/build</code> directory, so we need to copy it and serve it with nginx.</p>
<p><em>A small note is that if you deploy it in production, you can configure it not to build the admin UI. Splitting it into two separate Docker images is the approach I'm currently taking. Check <a href="https://docs.medusajs.com/admin/configuration#in-development---disabled-serve" target="_blank" rel="noopener noreferrer">this one</a>.</em></p>
<p>First, create the <code>admin.nginx.conf</code> file with this content and place it in the <code>/backend</code> folder.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./backend/admin.nginx.conf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">server {</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    listen 80 default_server;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    server_name localhost;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    charset utf-8;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    root /usr/share/nginx/html;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    location / {</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        try_files $uri $uri/ /index.html =404;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    }</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">}</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, create a <code>Dockerfile</code> with this content in the same directory as in the previous step.</p>
<div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./backend/Dockerfile.admin</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">### Build ###</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">FROM node:20-alpine as builder</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">WORKDIR /app</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">ENV NODE_ENV=production</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">ENV NODE_OPTIONS=--openssl-legacy-provider</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Copy medusa package.json and yarn.lock from /backend</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY ./package*.json .</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY ./yarn.lock? .</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Install deps</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">RUN yarn install --frozen-lockfile</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Copy app source code</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY . /app</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">RUN yarn build:admin:prod</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">### Runner ###</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">FROM nginx:1.16.0-alpine as runner</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Copy nginx.conf from /backend</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY admin.nginx.conf /etc/nginx/conf.d/default.conf</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">RUN apk add --no-cache bash</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">EXPOSE 80 </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Copy static files from Build stage</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY --from=builder /app/build /usr/share/nginx/html</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Image entrypoint</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">ENTRYPOINT ["nginx", "-g", "daemon off;"]</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The result:</p>
<p><img decoding="async" loading="lazy" alt="Container Medusa Application Admin UI Result" src="https://immersedincode.io.vn/assets/images/containerize-medusa-app-adminui-result-80d9ffdfc55a7cf8bcc8b419c32361ec.png" width="1223" height="980" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="storefront">Storefront<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#storefront" class="hash-link" aria-label="Direct link to Storefront" title="Direct link to Storefront">​</a></h3>
<p>Similar to the components above, we will have the following <code>Dockerfile</code>.</p>
<div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./storefront/Dockerfile</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">### Dependencies ###</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">FROM node:20-alpine as deps</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">WORKDIR /app</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Copy storefront package.json and yarn.lock from /storefront</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY ./package*.json .</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY ./yarn.lock? .</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Install deps and launch patch-package</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">RUN yarn install --frozen-lockfile</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">### Build ###</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">FROM node:20-alpine as builder</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">WORKDIR /app</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Copy cached root and package node_modules from deps</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY --from=deps /app/node_modules /app/node_modules</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Copy app source code</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COPY . /app</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Build the app</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">RUN yarn build</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Run the builded app</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">ENTRYPOINT [ "yarn", "start" ]</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="manage-containers">Manage containers<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#manage-containers" class="hash-link" aria-label="Direct link to Manage containers" title="Direct link to Manage containers">​</a></h2>
<p>With the above sections, we are ready to build and deploy the Docker image. Next, I will introduce how I manage the containers and configure them for deployment using Docker Compose.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="manage-environment-variables">Manage environment variables<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#manage-environment-variables" class="hash-link" aria-label="Direct link to Manage environment variables" title="Direct link to Manage environment variables">​</a></h3>
<p>Firstly, we should provide some environment variables for the app. In <code>/backend</code>, create a <code>.env</code> file and paste this content:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">JWT_SECRET=something</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">COOKIE_SECRET=something</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">POSTGRES_USER=postgres</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">POSTGRES_PASSWORD=CHANGE_ME</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">POSTGRES_DB=medusa</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">DATABASE_TYPE="postgres"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">REDIS_URL=redis://redis</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">DATABASE_URL=postgres://postgres:CHANGE_ME@postgres:5432/medusa</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">STORE_CORS=/http://.+/</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">ADMIN_CORS=/http://.+/</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">AUTH_CORS=/http://.+/</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Check out the documentation <a href="https://docs.medusajs.com/development/backend/configurations#environment-variables" target="_blank" rel="noopener noreferrer">https://docs.medusajs.com/development/backend/configurations#environment-variables</a>.</li>
</ul>
<p>Next, in <code>/storefront</code>, make a copy of <code>.env.template</code> to <code>.env.local</code>. Then change the value of <code>NEXT_PUBLIC_MEDUSA_BACKEND_URL</code> variable to <code>http://host.docker.internal:9000</code>, if you use Windows.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker-compose-configuration">Docker Compose configuration<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#docker-compose-configuration" class="hash-link" aria-label="Direct link to Docker Compose configuration" title="Direct link to Docker Compose configuration">​</a></h3>
<p>Let’s create a <code>docker-compose.yml</code> file at the same level as the <code>/backend</code> and <code>/storefront</code> directories.</p>
<p>I declare configurations for the database and Redis as follows:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./docker-compose.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token key atrule">version</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"3.8"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token key atrule">postgres</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> postgres</span><span class="token punctuation" style="color:#475569">:</span><span class="token number" style="color:#B5CEA8">12</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"54322:5432"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">env_file</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> ./backend/.env</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">db</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain">/var/lib/postgresql/data</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain">cached</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token key atrule">redis</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> redis</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">expose</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">6379</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  app</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">db</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">:</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These are the services that must be ready before the application container is initialized and connected to them.</p>
<p>Now I will define the backend and admin UI services.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./docker-compose.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token punctuation" style="color:#475569">...</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token key atrule">backend</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">build</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token key atrule">context</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> ./backend</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token key atrule">dockerfile</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Dockerfile</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> pxuanbach/medusa</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">backend</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">depends_on</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> postgres</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> redis</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">env_file</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> ./backend/.env</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"9000:9000"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token key atrule">admin</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">build</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token key atrule">context</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> ./backend</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token key atrule">dockerfile</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Dockerfile.admin</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> pxuanbach/medusa</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">backend</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">admin</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">depends_on</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> postgres</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> redis</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"7001:80"</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The last service is <code>storefront</code>, it needs to be initialized after the backend service. So, here is its configuration:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./docker-compose.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token punctuation" style="color:#475569">...</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token key atrule">storefront</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">build</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token key atrule">context</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> ./storefront</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token key atrule">dockerfile</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Dockerfile.prod</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> pxuanbach/medusa</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">storefront</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">depends_on</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> backend</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"8000:8000"</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="launch-all-services">Launch all services<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#launch-all-services" class="hash-link" aria-label="Direct link to Launch all services" title="Direct link to Launch all services">​</a></h3>
<p>After configuring the <code>docker-compose.yml</code> file, we will run it to see how it operates.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">docker-compose up -d --build postgres redis backend admin</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"># waiting...</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"># init seed data (Optional)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">docker-compose exec backend yarn seed</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"># wait...</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">docker-compose up -d --build storefront</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the above command, I run <code>backend</code> before <code>storefront</code>. Because the storefront needs to fetch the region from the backend to build successfully.</p>
<p>Once done, check the results:</p>
<ul>
<li>
<p>Admin Panel: <a href="http://localhost:7001/" target="_blank" rel="noopener noreferrer">http://localhost:7001</a></p>
<p><img decoding="async" loading="lazy" alt="Medusa Admin UI" src="https://immersedincode.io.vn/assets/images/medusa-adminui-23799872eae7d4f26f9adb1ae5f64e66.png" width="940" height="484" class="img_ev3q"></p>
</li>
<li>
<p>Backend: <a href="http://localhost:9000/store/products" target="_blank" rel="noopener noreferrer">http://localhost:9000/store/products</a></p>
<p><img decoding="async" loading="lazy" alt="Medusa Backend API" src="https://immersedincode.io.vn/assets/images/medusa-backend-api-2198368348e0205458c1cb38866826ef.png" width="946" height="424" class="img_ev3q"></p>
</li>
<li>
<p>Storefront: <a href="http://localhost:8000/" target="_blank" rel="noopener noreferrer">http://localhost:8000</a></p>
<p><img decoding="async" loading="lazy" alt="Medusa Storefront UI" src="https://immersedincode.io.vn/assets/images/medusa-storefront-ui-fc00ac45461d1e4875e6e55fb9ccf4d5.png" width="950" height="385" class="img_ev3q"></p>
</li>
</ul>
<p><em>Notes:</em></p>
<ul>
<li><em>If you cannot connect to the Admin Panel or Storefront via Docker container, try changing the default host of each to <code>0.0.0.0</code>.</em></li>
<li><em>Storefront needs to fetch the regions from the Backend. So, you should initialize your Backend data first.</em></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>I hope this post was useful. If you need a project to run a demo on your environment, here is my&nbsp;<a href="https://github.com/pxuanbach/medusa-ecommerce" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<p>In this repository, I have separated into 2 compose configurations. The configuration of this post is equivalent to <code>prod</code> configuration in the repos. Additionally, I created a script called <code>start-up.sh</code> in the demo repository. It will help us to start all services automatically.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://immersedincode.io.vn/blog/dockerizing-medusajs-for-optimized-deployment#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://github.com/medusajs/docker-medusa/pull/13" target="_blank" rel="noopener noreferrer">feat: update backend and storefront dockerfiles by mickeiik · Pull Request #13 · medusajs/docker-medusa (github.com)</a></li>
<li><a href="https://docs.medusajs.com/development/backend/install" target="_blank" rel="noopener noreferrer">Install Medusa Backend | Medusa (medusajs.com)</a></li>
</ul>]]></content>
        <author>
            <name>Bach Pham</name>
            <uri>https://github.com/pxuanbach</uri>
        </author>
        <category label="deployment" term="deployment"/>
        <category label="docker" term="docker"/>
        <category label="open-source" term="open-source"/>
        <category label="medusajs" term="medusajs"/>
        <category label="nodejs" term="nodejs"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Essential modules for developing applications with FastAPI (P2 - Logging)]]></title>
        <id>https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging</id>
        <link href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging"/>
        <updated>2024-04-01T10:00:00.000Z</updated>
        <summary type="html"><![CDATA[Back to FastAPI again.]]></summary>
        <content type="html"><![CDATA[<p>Back to FastAPI again.</p>
<p>This post comes with Logging module that you will want to have in your project.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="frameworklibrary-version">Framework/Library version<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging#frameworklibrary-version" class="hash-link" aria-label="Direct link to Framework/Library version" title="Direct link to Framework/Library version">​</a></h2>
<p>This project uses <a href="https://www.python.org/" target="_blank" rel="noopener noreferrer">Python</a> 3.10 as the environment and <a href="https://python-poetry.org/" target="_blank" rel="noopener noreferrer">Poetry</a> as the package manager.</p>
<p>The code and examples in this post will use frameworks/libraries with the following versions.</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./pyproject.toml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">[tool.poetry.dependencies]</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python = "^3.10"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">uvicorn = {extras = ["standard"], version = "^0.24.0.post1"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">fastapi = "^0.109.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python-multipart = "^0.0.7"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">email-validator = "^2.1.0.post1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">passlib = {extras = ["bcrypt"], version = "^1.7.4"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">tenacity = "^8.2.3"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">pydantic = "&gt;2.0"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">emails = "^0.6"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">gunicorn = "^21.2.0"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">jinja2 = "^3.1.2"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">alembic = "^1.12.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python-jose = {extras = ["cryptography"], version = "^3.3.0"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">httpx = "^0.25.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">psycopg = {extras = ["binary"], version = "^3.1.13"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">sqlmodel = "^0.0.16"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Pin bcrypt until passlib supports the latest</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">bcrypt = "4.0.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">pydantic-settings = "^2.2.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">sentry-sdk = {extras = ["fastapi"], version = "^1.40.6"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">psycopg2 = "^2.9.9"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">asyncpg = "^0.29.0"</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="logging">Logging<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging#logging" class="hash-link" aria-label="Direct link to Logging" title="Direct link to Logging">​</a></h2>
<p>This module plays an important role in recording information, warnings, and errors during execution.</p>
<p>Log messages can provide information about system activities, input and output data, important events, and any issues that arise to aid in locating and fixing errors.</p>
<p>Let's dive deeper into this module.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="log-level">Log Level<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging#log-level" class="hash-link" aria-label="Direct link to Log Level" title="Direct link to Log Level">​</a></h3>
<p>In Python, log level refers to the importance level of a log message and is used to specify the type of that message.</p>
<p><img decoding="async" loading="lazy" alt="Log level" src="https://immersedincode.io.vn/assets/images/log-level-811d6c4471c26845e34d0f56297f3266.png" width="539" height="120" class="img_ev3q"></p>
<ol>
<li><strong>DEBUG</strong>: Log level for debug messages, typically used to record detailed information for debugging and development purposes.</li>
<li><strong>INFO</strong>: Log level for informational messages, often used to record normal operations in the application.</li>
<li><strong>WARNING</strong>: Log level for warning messages, usually used to record unexpected or potential situations that do not affect the application's operation.</li>
<li><strong>ERROR</strong>: Log level for error messages, typically used to record situations that cause errors during application execution.</li>
<li><strong>CRITICAL</strong>: Log level for critical error messages, commonly used to log fatal errors that may prevent the application from continuing.</li>
</ol>
<p>In my experience, I often use DEBUG log level in the development environment. When the application is moved to production, I will hide the DEBUG level. Typically, only logs from INFO level or higher are allowed to be printed.</p>
<p>To get more knowledge about this part, you can refer to this <a href="https://stackoverflow.com/questions/2031163/when-to-use-the-different-log-levels" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/2031163/when-to-use-the-different-log-levels</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="log-format">Log Format<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging#log-format" class="hash-link" aria-label="Direct link to Log Format" title="Direct link to Log Format">​</a></h3>
<p>By default, the log format looks very simple. The problem is that this simplicity makes it lack information and become difficult to read.</p>
<p><img decoding="async" loading="lazy" alt="Log before format" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASgAAAB5CAYAAACKorz/AAAT4UlEQVR4Ae2dQY7juA6G5ziz6GUfaIC36YMMBphDDBp9gJ45Q9c6d8qDRJGmJEpmYsehXf+i4CSWJUr8+Yl2Rcpvv3/5escfxgAagAYiauC3iEbBJgQLNAANJA0AUMggkUFDA2E1AEBBnGHFiSwKWRQABUABUNBAWA0AUBBnWHEig0IGBUABUAAUNBBWAwAUxBlWnMigkEEBUAAUAAUNhNUAAAVxhhUnMihkUAAUAAVAQQNhNQBAQZxhxYkMChnUBkD9ff95u91vzd/Pv5pB/eu/rky+5uPH/Y8Chz//7eu5qfO/f6G2urrL57++f6uCrKvv37+r8+GE/78f91+3273vXzOWIWD6mC+2jfVV24ro15g2bQZUFVQl0G4aCBlQH/d//jcegAwUA0hLPV6hUrkabl/vf3z/iB38ANRgAvH6fawtPyCPbGsPez9HHfsCKs3wJWMScD0FKILK7fbf/c+cNfjE04PuJE4EoACoENlxvHjZH1Dltkuyny2AkqzKAahHg7yAVOzUAsnnEhy/3f/5ULefOjNUMJbbXLFXOZrb4VthVSZldnItn5cjw9moq7VD2/7y1w5fsA1t32XCUX3isubxqm15+49yLwBUCWoOxCzSB2/xCmyWZ0sOoTraqdJ9Dh4r2Pnc7XYXGxoAElx0vxhmC1g8ZbJNTd2VnTpw2S7LZl3upa8dvkjtpz5Vdja6cNl41bYAnqHGG10cBCiVhXCGoMTbPdROZdR5z0PyDgYczKU9ueVsBsAcqHJtfQ0FCwFLv1Ziq0DjKVOura5T9XlsPbwM9WuU+QnQDbvIRwvAzbGvrrtqW9F9HMe+1wGKAZODXWcafef7Z0dtNkJCrYGR6lEQGLYzura3QwJmWFe5JgPF6hPZnYPUU4aD8YSAmvqi9MuceB66zRv5Tvn9lG1NtMeawDE/l3wBoBrxrAX7l6/3HlDlFkH+9e4Q6jDIR9dORLJmswc+njIswqHtExv52sOPo/Gs/U5wqiH+bAa1BsPztRXRrzFt2h1Q9q1WLVTJVEpwjQHF19Xil+srCJSsizM3CdxRQE0csgYonblJOzZUu1seC0bWZ7reUK9H46l9ZPviNYA6Y1sT7YXy9fvt3BVQJED1YDkN9mqwWxlUER0/aP/Sfu0gDVxfhr/i4Hp+le1qn3UVh3htvjFAbXv6md2wOQuSgru22xDHzObDhO0BVO9T1sby1RGjf10fzt2W9FnpWCbX0te9yrT1XuX9ZkDVD0uNB6AcVPxwnI/KaRTIzYP0LhNiSKlyRhl+LuW2y6rDAagkABEX98moy1Mmi6lkUYvdk7E02jlOkD5odH5I/s7javSrAxPD69xtia6V1ls/7VWmrfcq7zcAikWE41XEgH5Ay9E0AEANZ2+INZpYYc/n0yQABUANlpl8vmAAAOP5HIACoAAoaCCsBgAoiDOsOJHRxMtojvYJAAVAAVDQQFgNAFAQZ1hxHj1bo714GRsABUABUNBAWA0AUBBnWHEio4mX0RztEwAKgAKgoIGwGtgEqG4ZBy/5kK/201KFW7VmLc0KzRIGx3KYTO52OYi0E3imudxC4L3GutGAQII+7xZZy/ln2j+yrWfswzWjzGwToJZKVwTw8bHsTJmF1pT3rH3ryowW3gZzNgA1mJ0bDQiA6HMAKpiOxT/H2nUMoL7/uP+sNiprxNnBpx2EkWhHn7fXv/E9AAVAvSm4lwTijfrf2PeDAPUtb0q3bDz2IKAmAMurwdvV/bn8bCuVtKK+ZGB8Wzqqg89bt5PcjlFmePubyxor+rmu1o6NDn5MpI1fpG1jImB7ue/VBOQJiKu25ek7ynh1eRig8ib6EuSNOLPY9d5KtQMp2I2gHu3GycFjBTufww8iGJlN45cRoFJWWI3tM7fbV22r1q43EFHOHrfjAJUzFoZQI04FjWU/pGXjuxmg8jkBn93JyvmlrSWbS9eQPfTcQ79W9VW3ap4y5drqOlWfBH+kz6hf2gf69ey50MxH1fhLv6/aViR/nt+WAwFVNnjLMy+JUyCRocHw6gd1Jv58i/cwoMZt5Uyv+69jsomyhBykGTpWHaoMB+IJASV+4T5UACf/yEZrcouXNhK0s9wZoK7XVq9fu/8o5xmXQwFFmUoS8WOAGm8bXG4tqtuNFcevwBCAuhk/E0/+4gyK4FQDejaJ2EJsNDCA4fnaWtGf9BPlbF3U43IwoGiv6p9/NeJcg4Yxg+fOPZOd7NJWHbAy0JY91mdhRdr4RezU/bUnhdcA6oxt1QEm2pCxxPlHxuRwQNEvzv53/yk/KeX7YQUKAD1r2+LNnc8Qmv0XT9fTC6aftUtb6lbSU4YcQcGNH0Rox9kDw7g/vkB6vN1vShNt4O1Vpq33M73fBChxQPUcQjtNz7ws0BLsDwIqOaVrb3RrtxFQ3rbc9pQsanngbDyrmdl82Ozrgwb/U0H6k4I022/0a2j7uduiCUprnfW9HPcq85mA1PZ1E6DayvB+ESfGAmMBDWzXAAA1nOG3Dy4EijGEBrZpAIACoIwvbG4TFYIS47eXBgAoAAqAggbCagCAgjjDinOvWRj1nDejA6AAKAAKGgirAQAK4gwrTmQ+58189vIdAAVAAVDQQFgNAFAQZ1hx7jULo57zZmIAFAAFQEEDYTXwNKDy1/hH65CMZQ+yLMS4Rs7pJTPVMhZaFrH24wtmPalOadNXD8+4slSB7apsCjgrXW5h8l5j7F1Ws0d7R7a1h72x63gaUBkGEvhNJxOgqnO0/u7n9x/3X8ZeS11dvHZNgEBO/7X24wsyE66IZLUeur7uA60F7PcvavouNrzhcwBqkAms6OH7t8F1z/jwyLaese9c12wD1GCDMhs4aQcBAhXvK8SZSle+28qXnP5r7ccXBA5rIpn/iMM0O5Q2AjoagBqAZk0PABTHYrTj04CiTeTs1estcPR7/ZoHw/qshgQDauXHFwQe64JM9S/ZkCr/aJDPdiGQW91lB4e8A4BkhgVyXAffSlbZ53qZPH58bXc0fMTttXbI+B0BXzXmVbuLr1kfpLW0Yyf/GX2q6mjtv2pbbT+v934nQNUCyAEj4m+ypgyAej+mDlAlgJZMS4k2XS8BXLcrgm537BTxOurJbdf2LfUaApgFO5/DDzQYmc3cd+L75G/RUhr/AnvRgOET8Tefu2pb3L/rHjcCqgRyyTp4U7ac/bCoOiApSBQh9RlACwh9TRIon58Lb8mQ2IHr9ZAtXD9vpsczt866uM7JsQCqtkPboF+resp40nWeMuXa6jpVXxewEc5Rv5asaBnj9JkAyrCdfPRIFnXVtiL48bU2PA8oBZ4kGHoATqJJgGKBWWKqb9/KRnQ8I5YgY9hR9lIHaa4zA5A+rwGQBmz+eWVbW88wgxrVOXHQsK5yjRrDOktTWaenDAdxGbt+PCY28rWHH0fjSZ+zj9K4ZL3I7R2D7HFA9eNy9rYi+nVfm3YAFGc0FFRJBAug6DN7llyylAwcBpTsnLmcZ+Asok3CSgKdi3xdkEY9wyAftTVxCABl3NrxeI3Gkz5nXxOctBZ4Z9X9AXW+tngsr3t8HlAMh/TVgQIXymx+3P/5KBnUSrCzCFtAMZCWLKoWLc+q3Y8vSBbgE79dT4Eq36Ku1jkRxxqgyhjyOEgWVY1b3/dcripTbLA+E/sndr6ljMdHti+yXgb/QZYxrPp01bai+XR/ezYDqvpuUgmQlDHl7CUHqDXTFeFpsKkMisGxfDHTCNLU1r/Njy+IKD2CVEHd1pPtbn90YVCnWbbUvQoovn3RGUI9Nv1YpLr7MhSYZOMC9oFgZjbLGA6u3e38YDwbaOesRmmD4JRu8yxdjWw+d1vSZzUOLYj3KtPW++73GwBVgoRhlIVbf9aKS3eWBpQCM79uB7/AjrILElidadRtpbrFSe3zCqnbVw/ZSWXr21MjKGbB7gCUaXeXvRl9M8pku9UkQbY/aPNuABrBgj/3QUOyafZp8mUeV6NfQ9vP3RbdeuoVETyGy3GvMqT9pd53v98AqDidePcgon1oARp4jQYAqOGs+5oBh5AxrtCAXwMAFAA1+U+bX0gIOozVKzQAQAFQABQ0EFYDABTEGVacr5iRUee5Mj0ACoACoKCBsBoAoCDOsOJEtnOubOcV/gKgACgAChoIqwEACuIMK85XzMio81xZGQAFQAFQ0EBYDWwDFC/z4GUIfJSlJcYSjVSmWaZhLlFpyuSZr13GodpJ5931RBNk6Ve/+0LE2c67bGQP26/a1h5j8znq2AFQeqFrP2jdOjuGjAKQpwxt+6rb6hfMuuqJBqdkDwA1mMEBqM9+S3o8oHgDMpX9dGDpypBQ68XCCYb15+v19AANIQAACoCKOHEGsOkcgJrsCpBXcZds7CFA8e2pyuQEVrJaftkxIe8M0JblOoxb27ou3gWyXpGe7eVru6OxWp/ba+04VEgPZDVsr/TN6NPU9qu2FXSinPriPTYfD6giWp0NdWBpylAg2+LWW7qs1SPQSI7g4LGCnc/pvbGbLIdsMm451T5FnjLZpqbuyk4tGrbLslmXe+lrJzRSnyo7+1vyYT/F/qu29Z5gXx/veHbtACiVHfBMqYRJQarL6KCmAVkrQ+dtQOVz5XZxrR63gwoI6ofWFCzj/anaZ0m6vHK8BSPrMwlSdW2Iz6hf9T5Zi3/1xNOO98yPbVl6f9W2ovk0rj07AKoHjhabBgg/DDb/i8fPpEqw6jIzYQ8zKKMebdf0dQbUpF+5bus8ZQk5SD1lGDjF1hqIUUVD0Oht7YEsm6jxxJWP9kRj++OqbUX1bTy7jgWUfBWgDu4KYlaZITDKbUPJ2FbrYSCsHYftFQd64OMpw3ZcEFAEJ8PP6hbYhpIOEh+gzteW7iNez3RwOKD4P29dhsQZVA5aEuZSpp+dc6eawG4BZbU1Gww5twao5r+Hcl1lj89mqx9SHwMs1NEDjXri4P7MMmEuUx+v2hagVPt5PB5vAFT/QwE9WAZlbnpG7oPAU48MTIZQ/6XRfH4VUL191g8Z9DN7sbmCcXIOBeIC5IHDZjYfBjEPNMr4qH4SnNKzqv1v8fI4B2xL+qxsE/0Vf+1Vpq33Ku93ANTygFQenCqHWNDgZ1H8QNVTJg24OJOfaaiH8XJetZ2dVLIabkscNwt2B6CkPbYlHRt7vGW0nTKGViDPbA4GKIEuj0/yS7Z/f0BFbYsmqPqrJaK/4q+9yrT1XuX9NkAdFhSDjALtD77giPG6SoB+9n4AUIAcIAcNhNUAAAVxhhXnZ88e0P+vdwAKgAKgoIGwGgCgIM6w4kQGgWeJABQABUBBA2E1AEBBnGHFiQwKGRQABUABUNBAWA0AUBBnWHEig0IGBUABUAAUNBBWA7sASr6uX5Y16GUl3fIUY0mIWSaV42UrvMSDl020R72bQXtO16OEOLOZZ26xi+1Q1/Pyin7bkeCzXrWgObitZY1iP8a0HlDrjH32/NG3xvD5+vVYH9mWbvd8rzcCigZaQFICOAU2iyoHuQ7wEiDWujVf0I+cqwd/VmbdZhIhLez9+f3H/Ve1SJnbmbXBZQIeAahBtjDyJ31+XhgG1GA10c/t2wQoykLmiz87QHU/iKANHIlkvzIemzOgciCn3RMIVL1APbZqu4O8BqAAqAcAsU/G+Lz2NwDKN7PEApTP5uQUbbd+vTjsAUDxLaqx2wHtjZ4gX7Zi4VvUtizXwed1VsqCm5TJfeBru6MxyXBdrR3c1iHH0RgbfmR7pW9Gn6Y2X7Wt5+GwaP19dTwPKOdM3AV3EVKfkaRBGIlED9CGMk6beW8nsVGyqUftKOU5eKxg53P4gQYjsxn5mj6v/FON7WjfLe2/9vVV22r7ea73xwBKZrW0d5TedK4drJFIdLkNZbyA6oDUBESeiT12aLsHrwug+JkdzVq6Pf1a1VH1xVOmXFtdp+qbZhfvKkf9WvbIqvceE0AZtlPG+EgWddW23uW7fdo9BlB8O1KCw35AnjpEIqmDte3ohjLO4LTEnZ9dcT92B9QE2tlm67x6NuYpw0HsHIMI6f1YD6QBDaj2v7IEtccB1Wvv7G218XOu988DqsBEi8QSdXuLR8FvBdwBgHLZ3DwLGmZ/HlA6xJAzqNF48E9ZWecBKNYewakeI2uSsfS5fDbyZw2o87Xl0CBPXgGPGwDF+3LPZ6kWUDwr2lnUSCR6kLeVIYFNbB5mGLVQuR/9jKttdbxeA9QIqpWdrW2l3arM5LOAwiRwjHyt+1smlOoZFG8PPfFz1+ertuXQYDcWca7ZBCjeW/yh70Hx1wzMZ1EjkegB21imBO3Q5gwMS9glEOQ2z2NHsbs8ZzKhvAoongh0htDa4iujg960RQt1ZrMu99LXozGmz6sMSvzCcMIPNCzZIemQskr1BWjDd54ybb2vfL8NULmDJVjUrRALJxneZ1B823K7czkZFFVHfoagRLcMwki0Wpj1w9QWRvxfOv3wlW3JGZbZLtfPoCA7dB30ms8rqM6C3QEoGUc9Pk3G4C2Tx5EhLfUZQJ7ZbAh78Y/q9+ZyI1/XgOJsVnyR/JftN/o1tOncbdGdwRw+e5V5ja9t3ewAKLviIzuBtuADaOCaGgCghjPqNR2OQIZfz6QBAAqAMr4giSA+UxBf2VYACoACoKCBsBoAoCDOsOK8cmaAvvmydAAKgAKgoIGwGgCgIM6w4kSW4csyrjxOABQABUBBA2E1AEBBnGHFeeXMAH3zZYcAFAAFQEEDYTUAQEGcYcWJLMOXZVx5nAAoAAqAggbCagCAgjjDivPKmQH65ssOASgACoCCBsJq4P8Tuy56D/hp/wAAAABJRU5ErkJggg==" width="296" height="121" class="img_ev3q"></p>
<p>Let's say you put a log inside a function and it's used multiple times. The special thing is that when the system is operating, you can't always sit next to the screen to check whether that function records errors or not? And at what point does the error occur? Ha ha… a classic example.</p>
<p>To solve that problem, log formatting is the key solution. It helps you and your system get through the darkest days.</p>
<p>For example, I have different formats for files and consoles.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/logger.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">console_msg_format </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"%(asctime)s %(levelname)s: %(message)s"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Create the root logger.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logger </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">getLogger</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logger</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">setLevel</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">DEBUG</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Set up logging to the console.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">stream_handler </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">StreamHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">stream_formatter </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">Formatter</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">console_msg_format</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">stream_handler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">setFormatter</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">stream_formatter</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logger</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">addHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">stream_handler</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The logs will look like</p>
<p><img decoding="async" loading="lazy" alt="Log after format" src="https://immersedincode.io.vn/assets/images/log-after-format-be02caa2e90a129a2fe3990aab86adeb.png" width="846" height="378" class="img_ev3q"></p>
<p>Even though the log format has been changed, it still doesn't seem easy to follow. Next, what we're going to do to improve it is add color to the log. At this point, I offer a simple solution to make the log better.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/logger.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ColoredFormatter</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">Formatter</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    COLOR_CODES </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token string" style="color:#64748b">'DEBUG'</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'\033[94m'</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># blue</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token string" style="color:#64748b">'INFO'</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'\033[92m'</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain">   </span><span class="token comment" style="color:#6A9955"># green</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token string" style="color:#64748b">'WARNING'</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'\033[93m'</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># yellow</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token string" style="color:#64748b">'ERROR'</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'\033[91m'</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># red</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token string" style="color:#64748b">'CRITICAL'</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'\033[41m\033[97m'</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># red background color and white text</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    RESET_CODE </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'\033[0m'</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># called to return to standard terminal text color</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">format</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> record</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token comment" style="color:#6A9955"># Get the color corresponding to the log level</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        color </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">COLOR_CODES</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">levelname</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">''</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token comment" style="color:#6A9955"># Add color to log messages and reset color at the end</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        formatted_message </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#64748b">f"</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">color</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation builtin" style="color:#0c4a6e">super</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">(</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">)</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation builtin" style="color:#0c4a6e">format</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">(</span><span class="token string-interpolation interpolation">record</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">)</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation">RESET_CODE</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> formatted_message</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">console_msg_format </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"%(asctime)s %(levelname)s: %(message)s"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Create the root logger.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logger </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">getLogger</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logger</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">setLevel</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">DEBUG</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Set up logging to the console.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">stream_handler </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">StreamHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">stream_formatter </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> ColoredFormatter</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">console_msg_format</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">stream_handler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">setFormatter</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">stream_formatter</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logger</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">addHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">stream_handler</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The result ^_^:</p>
<p><img decoding="async" loading="lazy" alt="Log after color format" src="https://immersedincode.io.vn/assets/images/log-after-color-format-f83ee03080912e0e4c49fb9f0e7fb22a.png" width="777" height="107" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="logging-to-multiple-sources">Logging to Multiple Sources<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging#logging-to-multiple-sources" class="hash-link" aria-label="Direct link to Logging to Multiple Sources" title="Direct link to Logging to Multiple Sources">​</a></h3>
<p>We have customized the log format for printing to the console in the above sections. If we only print to the console, when we restart the application, the logs on the console will be reset... We have lost all the old logs.</p>
<p>So, we need to store logs to multiple sources. As far as I know, we can store locations like files, databases, or online log services.</p>
<p>You can integrate with other tools like <a href="https://www.elastic.co/elastic-stack" target="_blank" rel="noopener noreferrer">Elasticsearch, Logstash, Kibana (ELK Stack)</a>.</p>
<p><img decoding="async" loading="lazy" alt="ELK Stack" src="https://immersedincode.io.vn/assets/images/elk-stack-f7aeaa3db5976184f807559892635028.png" width="875" height="314" class="img_ev3q"></p>
<p>Or <a href="https://grafana.com/docs/loki/latest/" target="_blank" rel="noopener noreferrer">Promtail, Loki and Grafana</a> for simpler setup.</p>
<p><img decoding="async" loading="lazy" alt="Promtail, Loki and Grafana" src="https://immersedincode.io.vn/assets/images/promtail-grafana-loki-7acece030148c5a7d3e70e7da5d15e9b.png" width="2000" height="733" class="img_ev3q"></p>
<p>In this post, we will discuss how to log into a file and some considerations to remember regarding this process.</p>
<p>With just a few lines of code, you can log into a specific file anywhere you want.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/logger.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token comment" style="color:#6A9955"># Create the root logger.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logger </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">getLogger</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logger</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">setLevel</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">DEBUG</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">basicConfig</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">level</span><span class="token operator" style="color:#475569">=</span><span class="token plain">logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">DEBUG</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Set up logging to the file.</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">file_handler </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">FileHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">'app.log'</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token comment" style="color:#6A9955"># &lt;--- File location</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">file_handler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">setLevel</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">DEBUG</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">formatter </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">Formatter</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">'%(asctime)s - %(levelname)s - %(message)s'</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">file_handler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">setFormatter</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">formatter</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logger</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">addHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">file_handler</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let’s see the results.</p>
<p><img decoding="async" loading="lazy" alt="Logging to Multiple Sources Result" src="https://immersedincode.io.vn/assets/images/logging-to-multiple-sources-result-e85178779650f2f71214dbfbba47f2e9.png" width="801" height="253" class="img_ev3q"></p>
<p>As you can see, <code>app.log</code> automatically creates and contains all the logs we print. However, that's not enough. We cannot simply dump all the system logs into a single file and monitor the logs from there. It is terrible! (＃°Д°)</p>
<p>To avoid that, what we need is a log rotation. It helps us manage file size, the maximum number of backup files if the file size exceeds the threshold.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/logger.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token comment" style="color:#6A9955"># Define default logfile format.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">file_name_format </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"{year:04d}{month:02d}{day:02d}.log"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Define the default logging message formats.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">file_msg_format </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"%(asctime)s %(levelname)-8s: %(message)s"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">console_msg_format </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"%(levelname)s: %(message)s"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Define the log rotation criteria.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">max_bytes </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1024</span><span class="token operator" style="color:#475569">**</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">   </span><span class="token comment" style="color:#6A9955"># ~ 1MB</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">backup_count </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">100</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Create the root logger.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logger </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">getLogger</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logger</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">setLevel</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">DEBUG</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Validate the given directory.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token builtin" style="color:#0c4a6e">dir</span><span class="token operator" style="color:#475569">=</span><span class="token string" style="color:#64748b">"log"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token builtin" style="color:#0c4a6e">dir</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">normpath</span><span class="token punctuation" style="color:#475569">(</span><span class="token builtin" style="color:#0c4a6e">dir</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Create a folder for the logfiles.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">not</span><span class="token plain"> os</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:#475569">(</span><span class="token builtin" style="color:#0c4a6e">dir</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    os</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">makedirs</span><span class="token punctuation" style="color:#475569">(</span><span class="token builtin" style="color:#0c4a6e">dir</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Construct the name of the logfile.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">t </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">now</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">file_name </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> file_name_format</span><span class="token punctuation" style="color:#475569">.</span><span class="token builtin" style="color:#0c4a6e">format</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    year</span><span class="token operator" style="color:#475569">=</span><span class="token plain">t</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">year</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    month</span><span class="token operator" style="color:#475569">=</span><span class="token plain">t</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">month</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    day</span><span class="token operator" style="color:#475569">=</span><span class="token plain">t</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">day</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">file_name </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#475569">(</span><span class="token builtin" style="color:#0c4a6e">dir</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> file_name</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Set up logging to the logfile.</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">file_handler </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">handlers</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">RotatingFileHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    filename</span><span class="token operator" style="color:#475569">=</span><span class="token plain">file_name</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> maxBytes</span><span class="token operator" style="color:#475569">=</span><span class="token plain">max_bytes</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> backupCount</span><span class="token operator" style="color:#475569">=</span><span class="token plain">backup_count</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">file_handler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">setLevel</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">DEBUG</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">file_formatter </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">Formatter</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">file_msg_format</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">file_handler</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">setFormatter</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">file_formatter</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">logger</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">addHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">file_handler</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you're not familiar with how this module works, the <code>RotatingFileHandler</code> class has the following description:</p>
<blockquote>
<p>Rollover occurs whenever the current log file is nearly maxBytes in length. If backupCount is &gt;= 1, the system will successively create new files with the same pathname as the base file, but with extensions ".1", ".2" etc. appended to it. For example, with a backupCount of 5 and a base file name of "app.log", you would get "app.log", "app.log.1", "app.log.2", ... through to "app.log.5". The file being written to is always "app.log" - when it gets filled up, it is closed and renamed to "app.log.1", and if files "app.log.1", "app.log.2" etc. exist, then they are renamed to "app.log.2", "app.log.3" etc. respectively.</p>
</blockquote>
<blockquote>
<p>If maxBytes is zero, rollover never occurs.</p>
</blockquote>
<p>In the example, I set the <code>maxBytes</code> value to 1MB, so if the size of the log file reaches 1MB, it will be moved to a backup file (<code>20240405.log.1</code>, <code>20240405.log.2</code>), and new logs will continue to be written to the current file (<code>20240405.log</code>).</p>
<p><img decoding="async" loading="lazy" alt="Logging to Multiple Sources Rotation Example" src="https://immersedincode.io.vn/assets/images/logging-to-multiple-sources-rotation-example-d7ee2979e161a55730a77f1c1c1d6f1c.png" width="833" height="288" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="performance">Performance<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance">​</a></h3>
<p>Logging in the system may seem lightweight, but in reality, it still consumes time and a certain amount of system resources, especially when performing concurrent logging from multiple threads or processes.</p>
<p>Specifying log levels, optimizing log structure, and configuring rotation also significantly reduce the burden on the system. Additionally, we can consider asynchronous logging and reduce the number of logging operations to reduce the load on the storage system, especially when handling large log volumes.</p>
<p>In FastAPI, you can use <a href="https://fastapi.tiangolo.com/tutorial/background-tasks/" target="_blank" rel="noopener noreferrer">Background Tasks</a> to log asynchronously, which reduces system load and request latency.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> Any</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> fastapi </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> BackgroundTasks</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> logging</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#475569">@self</span><span class="token decorator annotation punctuation" style="color:#475569">.</span><span class="token decorator annotation punctuation" style="color:#475569">router</span><span class="token decorator annotation punctuation" style="color:#475569">.</span><span class="token decorator annotation punctuation" style="color:#475569">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token string" style="color:#64748b">"/something"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">handle_something</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    bg_task</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> BackgroundTasks</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    bg_task</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">add_task</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#64748b">f"This is log"</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"something"</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">}</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="integration-with-fastapi">Integration with FastAPI<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging#integration-with-fastapi" class="hash-link" aria-label="Direct link to Integration with FastAPI" title="Direct link to Integration with FastAPI">​</a></h3>
<p>In my experience, you should wrap up all configurations into a function and call it when initializing the FastAPI application. In the new FastAPI version, <a href="https://fastapi.tiangolo.com/advanced/events/#lifespan" target="_blank" rel="noopener noreferrer">Lifespan Events</a> will help you do that.</p>
<p>For instance:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/main.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> contextlib </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> asynccontextmanager</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">logger </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> setup </span><span class="token keyword" style="color:#0c4a6e">as</span><span class="token plain"> setup_logging</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">config </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> settings</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#475569">@asynccontextmanager</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">lifespan</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># start up</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    setup_logging</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">minLevel</span><span class="token operator" style="color:#475569">=</span><span class="token plain">logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">DEBUG</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">yield</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># shut down</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">pass</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">app </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    title</span><span class="token operator" style="color:#475569">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">PROJECT_NAME</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    openapi_url</span><span class="token operator" style="color:#475569">=</span><span class="token string-interpolation string" style="color:#64748b">f"</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">settings</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation">API_STR</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">{</span><span class="token string-interpolation interpolation">settings</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">.</span><span class="token string-interpolation interpolation">API_VERSION_STR</span><span class="token string-interpolation interpolation punctuation" style="color:#475569">}</span><span class="token string-interpolation string" style="color:#64748b">/openapi.json"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    lifespan</span><span class="token operator" style="color:#475569">=</span><span class="token plain">lifespan</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="to-sum-up">To sum up<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging#to-sum-up" class="hash-link" aria-label="Direct link to To sum up" title="Direct link to To sum up">​</a></h2>
<p>We discussed an essential module in developing applications with FastAPI: Logging. By carefully and effectively using this module, we can build and maintain powerful and flexible FastAPI applications. Hopefully, this article has given you the overview and knowledge needed to use this important module in your projects.</p>
<p>If you need a project to run a demo on your environment, here are my&nbsp;<a href="https://github.com/pxuanbach/fastapi-essential-modules" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<p>See you again!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://github.com/borntyping/python-colorlog" target="_blank" rel="noopener noreferrer">borntyping/python-colorlog: A colored formatter for the python logging module (github.com)</a></li>
<li><a href="https://github.com/acschaefer/duallog/tree/master" target="_blank" rel="noopener noreferrer">acschaefer/duallog: Python package to enable simultaneous logging to console and logfile (github.com)</a></li>
</ul>]]></content>
        <author>
            <name>Bach Pham</name>
            <uri>https://github.com/pxuanbach</uri>
        </author>
        <category label="logging" term="logging"/>
        <category label="fastapi" term="fastapi"/>
        <category label="python" term="python"/>
        <category label="essential-modules-fastapi" term="essential-modules-fastapi"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Essential modules for developing applications with FastAPI (P1 - Migration)]]></title>
        <id>https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration</id>
        <link href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration"/>
        <updated>2024-03-31T10:00:00.000Z</updated>
        <summary type="html"><![CDATA[Today, I say “Hi FastAPI”.]]></summary>
        <content type="html"><![CDATA[<p>Today, I say “Hi FastAPI”.</p>
<p>Recently, <a href="https://fastapi.tiangolo.com/" target="_blank" rel="noopener noreferrer">FastAPI</a> has become increasingly popular, partly driven by the current trend of AI innovation. In my opinion, being modern, robust, fast, and micro is what makes me fall in love with this framework.</p>
<p>This post comes with some modules that you will want to have in your project.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="frameworklibrary-version">Framework/Library version<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration#frameworklibrary-version" class="hash-link" aria-label="Direct link to Framework/Library version" title="Direct link to Framework/Library version">​</a></h2>
<p>This project uses <a href="https://www.python.org/" target="_blank" rel="noopener noreferrer">Python</a> 3.10 as the environment and <a href="https://python-poetry.org/" target="_blank" rel="noopener noreferrer">Poetry</a> as the package manager.</p>
<p>The code and examples in this post will use frameworks/libraries with the following versions.</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./pyproject.toml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">[tool.poetry.dependencies]</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python = "^3.10"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">uvicorn = {extras = ["standard"], version = "^0.24.0.post1"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">fastapi = "^0.109.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python-multipart = "^0.0.7"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">email-validator = "^2.1.0.post1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">passlib = {extras = ["bcrypt"], version = "^1.7.4"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">tenacity = "^8.2.3"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">pydantic = "&gt;2.0"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">emails = "^0.6"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">gunicorn = "^21.2.0"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">jinja2 = "^3.1.2"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">alembic = "^1.12.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">python-jose = {extras = ["cryptography"], version = "^3.3.0"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">httpx = "^0.25.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">psycopg = {extras = ["binary"], version = "^3.1.13"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">sqlmodel = "^0.0.16"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Pin bcrypt until passlib supports the latest</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">bcrypt = "4.0.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">pydantic-settings = "^2.2.1"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">sentry-sdk = {extras = ["fastapi"], version = "^1.40.6"}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">psycopg2 = "^2.9.9"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">asyncpg = "^0.29.0"</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migration">Migration<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration#migration" class="hash-link" aria-label="Direct link to Migration" title="Direct link to Migration">​</a></h2>
<p>If you work with SQL databases, these are important components you need to set up. What I want to talk about is Alembic.</p>
<p><a href="https://alembic.sqlalchemy.org/" target="_blank" rel="noopener noreferrer">Alembic</a>&nbsp;is a lightweight database migration tool for usage with the&nbsp;<a href="https://www.sqlalchemy.org/" target="_blank" rel="noopener noreferrer">SQLAlchemy</a>&nbsp;Database Toolkit for Python.</p>
<p>To add or initialize a module, you can use the following commands:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">poetry add alembic  # pip install alembic</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">alembic init migrations</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>Note that “migrations” is the name of the directory where you want to store your migration versions.</em></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="directory-structure">Directory structure<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration#directory-structure" class="hash-link" aria-label="Direct link to Directory structure" title="Direct link to Directory structure">​</a></h3>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">Project/</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">├── app/</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">│   └── ...</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">├── migrations/</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">│   ├── versions/</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">│   │   └── ...</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">│   ├── README</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">│   ├── env.py</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">│   └── script.py.mako</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">├── alembic.ini</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">├── pyproject.toml</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">├── poetry.lock</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">├── README.md</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">└── ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="alembicini">alembic.ini<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration#alembicini" class="hash-link" aria-label="Direct link to alembic.ini" title="Direct link to alembic.ini">​</a></h3>
<p>I will use its default configuration. Or go to this link <a href="https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file" target="_blank" rel="noopener noreferrer">https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file</a> to get more details.</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./alembic.ini</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># A generic, single database configuration.</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">[alembic]</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># path to migration scripts</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">script_location = migrations</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># template used to generate migration files</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># file_template = %%(rev)s_%%(slug)s</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># sys.path path, will be prepended to sys.path if present.</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># defaults to the current working directory.</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">prepend_sys_path = .</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">...</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="envpy">env.py<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration#envpy" class="hash-link" aria-label="Direct link to env.py" title="Direct link to env.py">​</a></h3>
<p>In this version of FastAPI, <a href="https://sqlmodel.tiangolo.com/" target="_blank" rel="noopener noreferrer">SQLModel</a> appears as an integrated version of SQLAlchemy and Pydantic and is recommended for use in the official documentation.</p>
<p>So instead of using <code>DeclarativeMeta</code>, we will use <code>SQLModel.metadata</code> in Alembic’s env.</p>
<p>After completing the steps above, the <code>env.py</code>  will look like this.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./migrations/env.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">config </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> fileConfig</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> sqlalchemy </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> engine_from_config</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> sqlalchemy </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> pool</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> alembic </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> context</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">db </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> SQLModel       </span><span class="token comment" style="color:#6A9955"># &lt;--- CHANGE HERE</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">config </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> settings   </span><span class="token comment" style="color:#6A9955"># &lt;--- CHANGE HERE</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># this is the Alembic Config object, which provides</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># access to the values within the .ini file in use.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">config </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">config</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Interpret the config file for Python logging.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># This line sets up loggers basically.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> config</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">config_file_name </span><span class="token keyword" style="color:#0c4a6e">is</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    fileConfig</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">config_file_name</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># add your model's MetaData object here</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># for 'autogenerate' support</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># from myapp import mymodel</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># target_metadata = mymodel.Base.metadata</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">target_metadata </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> SQLModel</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">metadata    </span><span class="token comment" style="color:#6A9955"># &lt;--- CHANGE HERE</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># other values from the config, defined by the needs of env.py,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># can be acquired:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># my_important_option = config.get_main_option("my_important_option")</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># ... etc.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">config</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">set_section_option</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">"alembic"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"sqlalchemy.url"</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">settings</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">SQLALCHEMY_DATABASE_URI</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># &lt;--- CHANGE HERE</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">run_migrations_offline</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>One note is that to achieve the Alembic <code>—autogenerate</code> option, you must import the entity representing your table where you import SQLModel into env. For example <code>app/core/db.py</code>:</em></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/db.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> sqlalchemy</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ext</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">asyncio </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> AsyncSession</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> create_async_engine</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> sqlalchemy</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ext</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">declarative </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> declarative_base</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> sqlalchemy</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">orm </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> sessionmaker</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> sqlmodel </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> SQLModel</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> create_engine</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">config </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> settings</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">async_engine </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> create_async_engine</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">settings</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">SQLALCHEMY_DATABASE_URI_ASYNC</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">async_session_maker </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> sessionmaker</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    async_engine</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    class_</span><span class="token operator" style="color:#475569">=</span><span class="token plain">AsyncSession</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    expire_on_commit</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    autocommit</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    autoflush</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># We still have a second old style sync SQLAlchemy engine for shell and alembic</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">engine </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> create_engine</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">settings</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">SQLALCHEMY_DATABASE_URI</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> future</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">SessionLocal </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> sessionmaker</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">bind</span><span class="token operator" style="color:#475569">=</span><span class="token plain">engine</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> autocommit</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> autoflush</span><span class="token operator" style="color:#475569">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">Base </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> declarative_base</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">SQLModel</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">metadata </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> Base</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">metadata</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># import all models to automatically create migration through Alembic</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">modules</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">users</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">model </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> UserInDb</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>Alternatively, if you organize your database models within a directory, you can leverage the <code>__init__.py</code> file to gather all the models you want Alembic to create migrations automatically. For instance <code>app/models/__init__.py</code>:</em></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/models/__init__.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">db </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> SQLModel</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">user </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> UserInDb</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">item </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> ItemInDb</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And <code>migrations/env.py</code>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./migrations/env.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">config </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> fileConfig</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> sqlalchemy </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> engine_from_config</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> sqlalchemy </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> pool</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> alembic </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> context</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> app</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">models </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> SQLModel       </span><span class="token comment" style="color:#6A9955"># &lt;--- CHANGE HERE</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scriptpymako">script.py.mako<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration#scriptpymako" class="hash-link" aria-label="Direct link to script.py.mako" title="Direct link to script.py.mako">​</a></h3>
<p>To make things go smoothly, don't forget to import the <code>sqlmodel</code> into this file.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./migrations/script.py.mako</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token triple-quoted-string string" style="color:#64748b">"""${message}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token triple-quoted-string string" style="display:inline-block;color:#64748b"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token triple-quoted-string string" style="color:#64748b">Revision ID: ${up_revision}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token triple-quoted-string string" style="color:#64748b">Revises: ${down_revision | comma,n}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token triple-quoted-string string" style="color:#64748b">Create Date: ${create_date}</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token triple-quoted-string string" style="display:inline-block;color:#64748b"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token triple-quoted-string string" style="color:#64748b">"""</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> Sequence</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> Union</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">from</span><span class="token plain"> alembic </span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> op</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> sqlalchemy </span><span class="token keyword" style="color:#0c4a6e">as</span><span class="token plain"> sa</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> sqlmodel             </span><span class="token comment" style="color:#6A9955"># &lt;--- CHANGE HERE</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">$</span><span class="token punctuation" style="color:#475569">{</span><span class="token plain">imports </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> imports </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token string" style="color:#64748b">""</span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-use">How to use?<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration#how-to-use" class="hash-link" aria-label="Direct link to How to use?" title="Direct link to How to use?">​</a></h3>
<p><img decoding="async" loading="lazy" alt="How to use migration" src="https://immersedincode.io.vn/assets/images/how-to-use-migration-9682a2c5aba69503ba37bce6f766bb1b.png" width="994" height="221" class="img_ev3q"></p>
<ul>
<li>
<p>To create a new revision:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">alembic revision --autogenerate -m "message"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>To migrate:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">alembic upgrade head</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>To undo the latest migration:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">alembic downgrade -1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>To roll back to a specific revision:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">alembic downgrade &lt;&lt;revision_id&gt;&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>We discussed an essential module in developing applications with FastAPI: Migration. By carefully and effectively using this module, we can build and maintain powerful and flexible FastAPI applications. Hopefully, this article has given you the overview and knowledge needed to use this important module in your projects.</p>
<p>If you need a project to run a demo on your environment, here are my&nbsp;<a href="https://github.com/pxuanbach/fastapi-essential-modules" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<p>See you again!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://stackoverflow.com/questions/68932099/how-to-get-alembic-to-recognise-sqlmodel-database-model" target="_blank" rel="noopener noreferrer">How to get Alembic to recognise SQLModel database model?</a></li>
<li><a href="https://alembic.sqlalchemy.org/en/latest/tutorial.html" target="_blank" rel="noopener noreferrer">Tutorial — Alembic 1.13.2 documentation (sqlalchemy.org)</a></li>
</ul>]]></content>
        <author>
            <name>Bach Pham</name>
            <uri>https://github.com/pxuanbach</uri>
        </author>
        <category label="alembic" term="alembic"/>
        <category label="migration" term="migration"/>
        <category label="fastapi" term="fastapi"/>
        <category label="python" term="python"/>
        <category label="essential-modules-fastapi" term="essential-modules-fastapi"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Zero-downtime Deployments with Docker Compose & Nginx]]></title>
        <id>https://immersedincode.io.vn/blog/zero-downtime-deployment-with-docker-compose-nginx</id>
        <link href="https://immersedincode.io.vn/blog/zero-downtime-deployment-with-docker-compose-nginx"/>
        <updated>2024-03-24T10:00:00.000Z</updated>
        <summary type="html"><![CDATA[Hey, welcome to my blog!]]></summary>
        <content type="html"><![CDATA[<p>Hey, welcome to my blog!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="https://immersedincode.io.vn/blog/zero-downtime-deployment-with-docker-compose-nginx#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>A few months ago, I worked on a project that utilized Docker and Nginx to deploy the product on Digital Ocean’s VPS. Everything at that time was quite primitive, I had to set up everything from scratch. From containerizing the application to creating a CI/CD pipeline to build, manage, and deploy different Docker image versions.</p>
<p>Docker is a great tool and I love using it in my workflow. I define the Docker services in the configuration file, then pull, up and down the containers to make sure they are up to date. But we have a problem: the time between when I down the container and when I up it. It took&nbsp;<strong>2 minutes</strong>&nbsp;of downtime in total. That’s unacceptable for a product deployed for end-users.</p>
<p><img decoding="async" loading="lazy" alt="Featured Image" src="https://immersedincode.io.vn/assets/images/blue-green-deployment-with-nginx-282b1b50b039dd50add056db6bf70e5a.png" width="703" height="397" class="img_ev3q"></p>
<p>So I implemented a Zero downtime deployment strategy for that project. The BLUE-GREEN strategy is a basic deployment process, but it’s great when simplicity gets the job done.</p>
<p>Now, let’s talk about some stuff.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-before-applying">Configuration before applying<a href="https://immersedincode.io.vn/blog/zero-downtime-deployment-with-docker-compose-nginx#configuration-before-applying" class="hash-link" aria-label="Direct link to Configuration before applying" title="Direct link to Configuration before applying">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker-compose">Docker Compose<a href="https://immersedincode.io.vn/blog/zero-downtime-deployment-with-docker-compose-nginx#docker-compose" class="hash-link" aria-label="Direct link to Docker Compose" title="Direct link to Docker Compose">​</a></h3>
<p>I have a configuration file like this:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./docker-compose.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token key atrule">services</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token key atrule">api</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> pxuanbach/simple</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">app</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'8000:8000'</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> on</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">failure</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginx">Nginx<a href="https://immersedincode.io.vn/blog/zero-downtime-deployment-with-docker-compose-nginx#nginx" class="hash-link" aria-label="Direct link to Nginx" title="Direct link to Nginx">​</a></h3>
<p>The <code>nginx.conf</code> configuration will look like this:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./nginx.conf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">server {</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    listen 80 default_server;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    server_name api.app.com;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    location / {</span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        proxy_pass http://localhost:8000;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        proxy_set_header Host $host;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        proxy_http_version 1.1;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        proxy_set_header Upgrade $http_upgrade;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        proxy_set_header Connection "upgrade";</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        client_max_body_size 64M;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    }</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">}</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployment-process">Deployment process<a href="https://immersedincode.io.vn/blog/zero-downtime-deployment-with-docker-compose-nginx#deployment-process" class="hash-link" aria-label="Direct link to Deployment process" title="Direct link to Deployment process">​</a></h3>
<p>It was very easy, and I just followed the steps…</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">docker compose pull</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">docker compose down</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># ---DOWNTIME HERE---</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">docker compose up</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Old Deployment Flow" src="https://immersedincode.io.vn/assets/images/old-deployment-flow-6e13ae744f8af1e014dee53c9e1c141d.png" width="696" height="141" class="img_ev3q"></p>
<p>Now let's move on to the BLUE-GREEN strategy.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-configuration">New configuration<a href="https://immersedincode.io.vn/blog/zero-downtime-deployment-with-docker-compose-nginx#new-configuration" class="hash-link" aria-label="Direct link to New configuration" title="Direct link to New configuration">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker-compose-1">Docker Compose<a href="https://immersedincode.io.vn/blog/zero-downtime-deployment-with-docker-compose-nginx#docker-compose-1" class="hash-link" aria-label="Direct link to Docker Compose" title="Direct link to Docker Compose">​</a></h3>
<p>To apply the BLUE-GREEN strategy, I need to update this configuration file a bit. I use the&nbsp;<strong>Anchors and aliases</strong>&nbsp;features to have a blue and green service with the same configuration. I only change the port number for the green service.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./docker-compose.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token key atrule">services</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token key atrule">api_blue</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token important">&amp;api</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> pxuanbach/simple</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">app</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> </span><span class="token string" style="color:#64748b">'8000:8000'</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> on</span><span class="token punctuation" style="color:#475569">-</span><span class="token plain">failure</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token key atrule">api_green</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">&lt;&lt;</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token important">*api</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#475569">-</span><span class="token plain"> </span><span class="token string" style="color:#64748b">"8001:8000"</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginx-1">Nginx<a href="https://immersedincode.io.vn/blog/zero-downtime-deployment-with-docker-compose-nginx#nginx-1" class="hash-link" aria-label="Direct link to Nginx" title="Direct link to Nginx">​</a></h3>
<p>Create a copy of the nginx configuration corresponding to the service name and port. For example&nbsp;<code>api_green.conf</code>:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./api_green.conf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">server {</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    listen 80 default_server;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    server_name api.app.com;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    location / {</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        proxy_pass http://localhost:8001;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        ...</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    }</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">}</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="zero-downtime-deployment">Zero Downtime Deployment<a href="https://immersedincode.io.vn/blog/zero-downtime-deployment-with-docker-compose-nginx#zero-downtime-deployment" class="hash-link" aria-label="Direct link to Zero Downtime Deployment" title="Direct link to Zero Downtime Deployment">​</a></h3>
<p>To achieve the goal, I must use the Bash/Shell script. This script will make use of the Docker command line as well as the Nginx. Its goal is to implement the BLUE-GREEN strategy by identifying which service, BLUE or GREEN, is currently active and then standing up the inactive environment in parallel. To avoid downtime, I will update the Nginx configuration before stopping the old container.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./pull.run-service.sh</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">#!/bin/bash</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Step 1</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">BLUE_SERVICE="api_blue"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">BLUE_SERVICE_PORT=8000</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">GREEN_SERVICE="api_green"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">GREEN_SERVICE_PORT=8001</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">TIMEOUT=60  # Timeout in seconds</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">SLEEP_INTERVAL=5  # Time to sleep between retries in seconds</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">MAX_RETRIES=$((TIMEOUT / SLEEP_INTERVAL))</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Step 2</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">if docker ps --format "{{.Names}}" | grep -q "$BLUE_SERVICE"; then</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  ACTIVE_SERVICE=$BLUE_SERVICE</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  INACTIVE_SERVICE=$GREEN_SERVICE</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">elif docker ps --format "{{.Names}}" | grep -q "$GREEN_SERVICE"; then</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  ACTIVE_SERVICE=$GREEN_SERVICE</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  INACTIVE_SERVICE=$BLUE_SERVICE</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">else</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  ACTIVE_SERVICE=""</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  INACTIVE_SERVICE=$BLUE_SERVICE</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">fi</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">echo "Starting $INACTIVE_SERVICE container"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">docker compose pull $INACTIVE_SERVICE</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">docker compose up -d $INACTIVE_SERVICE</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Step 3</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Wait for the new environment to become healthy</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">echo "Waiting for $INACTIVE_SERVICE to become healthy..."</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">sleep 10</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">i=0</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">while [ "$i" -le $MAX_RETRIES ]; do</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  HEALTH_CHECK_URL="http://localhost:8000/health"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  if [ "$INACTIVE_SERVICE" = "$BLUE_SERVICE" ]; then</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    HEALTH_CHECK_URL="http://localhost:$BLUE_SERVICE_PORT/health"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  else</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    HEALTH_CHECK_URL="http://localhost:$GREEN_SERVICE_PORT/health"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  fi</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  response=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_CHECK_URL)</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  # Check the HTTP status code</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  if [ $response -eq 200 ]; then</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      echo "$INACTIVE_SERVICE is healthy"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      break</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  else</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      echo "Health check failed. API returned HTTP status code: $response"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  fi</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  i=$(( i + 1 ))</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  sleep "$SLEEP_INTERVAL"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">done</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Step 4</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># update Nginx config</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">echo "Update Nginx config to $INACTIVE_SERVICE"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">cp ./$INACTIVE_SERVICE.conf /your/config/path/api.conf</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># restart nginx</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">nginx -s reload;</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">sleep 5</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># Step 5</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># remove OLD CONTAINER</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">echo "Remove OLD CONTAINER: $ACTIVE_SERVICE"</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">docker compose rm -fsv $ACTIVE_SERVICE</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"># remove unused images</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">(docker images -q --filter 'dangling=true' -q | xargs docker rmi) || true</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let’s walk through the script step by step:</p>
<ol>
<li>I define the name and port of the blue and green services. And the maximum retry time to check the status of the container. The value depends on your container initialization time.
Sau đó tiến hành pull phiên bản mới của Docker image về.</li>
<li>Execute the docker command to find the inactive service and start it.</li>
<li>Check the status of the newly initialized container.</li>
<li>Update Nginx configuration and reload it. Using&nbsp;<code>nginx -s reload</code>&nbsp;to reload Nginx&nbsp;<strong>usually does not cause downtime</strong>. This is because the command only tells Nginx to reload its configuration, it does not restart the entire process.</li>
<li>Clean up some unused stuff (old docker image, old container).</li>
</ol>
<p>In some cases the command&nbsp;<code>docker compose rm -fsv</code>&nbsp;may not work. Easily change it to:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">docker compose stop $ACTIVE_SERVICE</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">docker compose rm -f $ACTIVE_SERVICE</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To deploy the new version, simply run the created script.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">./pull.run-service.sh</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Conclusion</h1>
<p>As you can see, we can automate the deployment process with just 1 Bash script. The primary objective is to redirect the proxy to the newest container and then remove the old one.</p>
<p>If you need a project to run a demo on your environment, here are my <a href="https://github.com/pxuanbach/demo-blue-green-deployment" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<h1>References</h1>
<ul>
<li><a href="https://www.maxcountryman.com/articles/zero-downtime-deployments-with-docker-compose" target="_blank" rel="noopener noreferrer">Zero-Downtime Deployments with Docker Compose – Max Countryman</a></li>
<li><a href="https://docs.docker.com/reference/cli/docker/compose/rm/" target="_blank" rel="noopener noreferrer">docker compose rm | Docker Docs</a></li>
</ul>]]></content>
        <author>
            <name>Bach Pham</name>
            <uri>https://github.com/pxuanbach</uri>
        </author>
        <category label="automation" term="automation"/>
        <category label="deployment" term="deployment"/>
        <category label="docker" term="docker"/>
        <category label="nginx" term="nginx"/>
        <category label="shell script" term="shell script"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Welcome]]></title>
        <id>https://immersedincode.io.vn/blog/welcome</id>
        <link href="https://immersedincode.io.vn/blog/welcome"/>
        <updated>2024-03-15T10:00:00.000Z</updated>
        <summary type="html"><![CDATA[Hello world!]]></summary>
        <content type="html"><![CDATA[<p>Hello world!</p>
<p>Like many other software engineers, I have a passion for writing code and exploring new technologies and techniques in the industry.  That's why I created this blog to share the knowledge and experience I've gained throughout my work and studies.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-will-this-blog-be-about">What will this blog be about?<a href="https://immersedincode.io.vn/blog/welcome#what-will-this-blog-be-about" class="hash-link" aria-label="Direct link to What will this blog be about?" title="Direct link to What will this blog be about?">​</a></h2>
<p>Currently, my primary focus is on back-end development. I also manage the product deployment process and front-end web maintenance.</p>
<p>Therefore, the main content of this blog will revolve around back-end and DevOps topics 😅.</p>]]></content>
        <author>
            <name>Bach Pham</name>
            <uri>https://github.com/pxuanbach</uri>
        </author>
        <category label="hello world" term="hello world"/>
    </entry>
</feed>