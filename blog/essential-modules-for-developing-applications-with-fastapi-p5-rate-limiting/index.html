<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Essential modules for developing applications with FastAPI (P5 - Rate-limiting) | Immersed in Code</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Essential modules for developing applications with FastAPI (P5 - Rate-limiting) | Immersed in Code"><meta data-rh="true" name="description" content="Another week has passed, how was your weekend? I am planning my future journey."><meta data-rh="true" property="og:description" content="Another week has passed, how was your weekend? I am planning my future journey."><meta data-rh="true" property="og:image" content="https://immersedincode.io.vn/img/09_essential-modules-for-developing-applications-with-fastapi-p5/featured.png"><meta data-rh="true" name="twitter:image" content="https://immersedincode.io.vn/img/09_essential-modules-for-developing-applications-with-fastapi-p5/featured.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-08-15T10:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/pxuanbach"><meta data-rh="true" property="article:tag" content="fastapi,redis,rate-limit,python,essential-modules-fastapi"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting"><link data-rh="true" rel="alternate" href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting" hreflang="en"><link data-rh="true" rel="alternate" href="https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting","mainEntityOfPage":"https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting","url":"https://immersedincode.io.vn/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting","headline":"Essential modules for developing applications with FastAPI (P5 - Rate-limiting)","name":"Essential modules for developing applications with FastAPI (P5 - Rate-limiting)","description":"Another week has passed, how was your weekend? I am planning my future journey.","datePublished":"2024-08-15T10:00:00.000Z","author":{"@type":"Person","name":"Bach Pham","description":"Software Engineer","url":"https://github.com/pxuanbach","image":"https://avatars.githubusercontent.com/u/55500268?v=4"},"image":{"@type":"ImageObject","@id":"https://immersedincode.io.vn/img/09_essential-modules-for-developing-applications-with-fastapi-p5/featured.png","url":"https://immersedincode.io.vn/img/09_essential-modules-for-developing-applications-with-fastapi-p5/featured.png","contentUrl":"https://immersedincode.io.vn/img/09_essential-modules-for-developing-applications-with-fastapi-p5/featured.png","caption":"title image for the blog post: Essential modules for developing applications with FastAPI (P5 - Rate-limiting)"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://immersedincode.io.vn/blog","name":"My Awesome Blog"}}</script><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2VH0PJCNSH"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2VH0PJCNSH",{anonymize_ip:!0})</script>




<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Immersed in Code RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Immersed in Code Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e64f082f.css">
<script src="/assets/js/runtime~main.575d6e22.js" defer="defer"></script>
<script src="/assets/js/main.cea25d15.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Immersed in Code Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Immersed in Code Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Immersed in Code</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/about">About</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/pxuanbach" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">My GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/happy-new-year-2025">Happy New Year 2025</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring">Essential modules for developing applications with FastAPI (P6 - Monitoring)</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting">Essential modules for developing applications with FastAPI (P5 - Rate-limiting)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler">Essential modules for developing applications with FastAPI (P4 - Job Scheduler)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/asynchronous-request-batching-design-pattern-in-nodejs">Asynchronous Request Batching Design Pattern in Node.js</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/destructuring-in-python">Destructuring in Python</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching">Essential modules for developing applications with FastAPI (P3 - Caching)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/dockerizing-medusajs-for-optimized-deployment">Dockerize MedusaJS Components: Optimize and Deploy Your Application</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p2-logging">Essential modules for developing applications with FastAPI (P2 - Logging)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/essential-modules-for-developing-applications-with-fastapi-p1-migration">Essential modules for developing applications with FastAPI (P1 - Migration)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/zero-downtime-deployment-with-docker-compose-nginx">Zero-downtime Deployments with Docker Compose &amp; Nginx</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/welcome">Welcome</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">Essential modules for developing applications with FastAPI (P5 - Rate-limiting)</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-08-15T10:00:00.000Z">August 15, 2024</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/pxuanbach" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/55500268?v=4" alt="Bach Pham"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/pxuanbach" target="_blank" rel="noopener noreferrer"><span>Bach Pham</span></a></div><small class="avatar__subtitle">Software Engineer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Another week has passed, how was your weekend? I am planning my future journey.</p>
<p>In this article, I will introduce you to a crucial module to protect your system. As the title of the article, it is about Rate-limiting. Let&#x27;s explore how we can apply it to FastAPI!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="frameworklibrary-version"><strong>Framework/Library version</strong><a href="#frameworklibrary-version" class="hash-link" aria-label="Direct link to frameworklibrary-version" title="Direct link to frameworklibrary-version">​</a></h2>
<p>This project uses <a href="https://www.python.org/" target="_blank" rel="noopener noreferrer">Python</a> 3.10 as the environment and <a href="https://python-poetry.org/" target="_blank" rel="noopener noreferrer">Poetry</a> as the package manager.</p>
<p>The code and examples in this post will use frameworks/libraries with the following versions.</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">[tool.poetry.dependencies]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">python = &quot;^3.10&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">uvicorn = {extras = [&quot;standard&quot;], version = &quot;^0.24.0.post1&quot;}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">fastapi = &quot;^0.109.1&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">python-multipart = &quot;^0.0.7&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">email-validator = &quot;^2.1.0.post1&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">passlib = {extras = [&quot;bcrypt&quot;], version = &quot;^1.7.4&quot;}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">tenacity = &quot;^8.2.3&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">pydantic = &quot;&gt;2.0&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">emails = &quot;^0.6&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">gunicorn = &quot;^21.2.0&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">jinja2 = &quot;^3.1.2&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">alembic = &quot;^1.12.1&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">python-jose = {extras = [&quot;cryptography&quot;], version = &quot;^3.3.0&quot;}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">httpx = &quot;^0.25.1&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">psycopg = {extras = [&quot;binary&quot;], version = &quot;^3.1.13&quot;}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">sqlmodel = &quot;^0.0.16&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"># Pin bcrypt until passlib supports the latest</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">bcrypt = &quot;4.0.1&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">pydantic-settings = &quot;^2.2.1&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">sentry-sdk = {extras = [&quot;fastapi&quot;], version = &quot;^1.40.6&quot;}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">psycopg2 = &quot;^2.9.9&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">asyncpg = &quot;^0.29.0&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">redis = {extras = [&quot;hiredis&quot;], version = &quot;^5.0.3&quot;}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">orjson = &quot;^3.10.0&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">apscheduler = &quot;^3.10.4&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rate-limiting-overview">Rate-limiting Overview<a href="#rate-limiting-overview" class="hash-link" aria-label="Direct link to Rate-limiting Overview" title="Direct link to Rate-limiting Overview">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-exactly-is-rate-limiting">What exactly is rate-limiting?<a href="#what-exactly-is-rate-limiting" class="hash-link" aria-label="Direct link to What exactly is rate-limiting?" title="Direct link to What exactly is rate-limiting?">​</a></h3>
<blockquote>
<p>Rate limiting is a strategy for limiting network traffic. It puts a cap on how often someone can repeat an action within a certain timeframe – for instance, trying to log in to an account. Rate limiting can help stop certain kinds of malicious <a href="https://www.cloudflare.com/learning/bots/what-is-a-bot/" target="_blank" rel="noopener noreferrer">bot activity</a>. It can also reduce strain on web servers.
<a href="https://www.cloudflare.com/learning/bots/what-is-rate-limiting/" target="_blank" rel="noopener noreferrer"><em>— By Cloud Flare —</em></a></p>
</blockquote>
<p>Besides, it also offers other benefits, such as monitoring API usage, enforcing API usage policies, and even implementing some business logic to differentiate customer permission levels.</p>
<p>There are many types of rate-limiting to meet various needs, including Fixed Window Counter, Sliding Window Counter, Token Bucket, and more. Additionally, rule limiting is also a topic of concern. I will introduce Fixed Window Counter rate-limiting in this article with an IP-based limiting mechanism.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-does-it-work">How does it work?<a href="#how-does-it-work" class="hash-link" aria-label="Direct link to How does it work?" title="Direct link to How does it work?">​</a></h3>
<p>I&#x27;ll give a few simple examples to describe how Rate-limit works; take a look at the image below:</p>
<p><img decoding="async" loading="lazy" alt="How It Work" src="/assets/images/how-it-work-7b13a0fe01410027bc8e74f6620ed664.png#center" width="531" height="491" class="img_ev3q"></p>
<p>Suppose we have a Client sending requests to a Server, and we set a rule on the Server to only accept 2 requests within 1 minute. Therefore, if more than 2 requests are sent from the Client, starting from the 3rd request, an error will occur and it will be responded to immediately.</p>
<p>Perhaps you are curious as to why the 1-minute time frame is not calculated from point <strong>(1)</strong> but rather from point <strong>(2)</strong>. To understand this, you&#x27;ll need to learn about Rate-Limit algorithms. If the time were calculated from point <strong>(1)</strong> and I could successfully make 2 requests after 1 minute, that would be the Fixed Window Counter algorithm. I calculate the time from point <strong>(2)</strong> because I am applying the Sliding Window Counter algorithm.</p>
<p><strong>Fixed Window Counter algorithm</strong> can be described as follows:</p>
<p><img decoding="async" loading="lazy" alt="Fixed Window Counter Example" src="/assets/images/fixed-window-counter-example-4ac6045486f5487be115b22878994f0a.png#center" width="521" height="261" class="img_ev3q"></p>
<ul>
<li>We still use the 2 requests per minute rule.</li>
<li><strong>R1</strong> and <strong>R2</strong> belong to Frame 1, and both responded successfully. At this point, Server will count <strong>R1</strong> and <strong>R2</strong>, with count = 2.</li>
<li><strong>R3</strong> failed because Frame 1 reached limit (count = 2 = limit).</li>
<li><strong>R5</strong> and <strong>R6</strong> belong to Frame 2, and do the same with <strong>R1</strong>, <strong>R2</strong>.</li>
</ul>
<p><strong>Sliding Window Counter algorithm</strong> can be described as follows:</p>
<p><img decoding="async" loading="lazy" alt="Sliding Window Counter Example" src="/assets/images/sliding-window-counter-example-60a8886904147c3066897af1632d0bcb.png#center" width="542" height="251" class="img_ev3q"></p>
<ul>
<li><strong>R1</strong> was successful because Frame 1 had no previous requests. We store <strong>R1</strong> with time = 60.</li>
<li><strong>R2</strong> also executes successfully. Because in Frame 2, there is only 1 request, which is <strong>R1</strong> (count = 1). At this stage, we adds <strong>R2</strong> with time = 75 to cache.</li>
<li><strong>R3</strong> failed because Frame 3 reached limit. We will check how many requests have been stored from around 30 to 90. Oh, we have <strong>R1</strong> and <strong>R2</strong> with corresponding times of 60 and 75.</li>
<li><strong>R4</strong> was successful because Frame 4 only contains <strong>R2</strong> (count = 1). At this point, we will cache <strong>R2</strong> and <strong>R4</strong>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prepare-before-coding">Prepare before coding<a href="#prepare-before-coding" class="hash-link" aria-label="Direct link to Prepare before coding" title="Direct link to Prepare before coding">​</a></h3>
<p>In <a href="/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching">part 3 - caching</a>, we integrated Redis into our system. So I&#x27;m going to reuse it to store some stuff.</p>
<p>Now, let&#x27;s find out what we are going to do.</p>
<p>In the API Server, I usually create a rate-limit module and treat it as middleware. First, the request will pass through the Rate-limit middleware, which will check whether this request is allowed to proceed to the next middleware or the execution layer.</p>
<p><img decoding="async" loading="lazy" alt="Request to Rate-limit Middleware" src="/assets/images/request-to-rate-limit-middleware-9696d4f339085cd77c0a8268f7b78653.png#center" width="691" height="131" class="img_ev3q"></p>
<p>When working with FastAPI, we have many ways to implement this module. I can list a few methods as follows:</p>
<ol>
<li>Take advantage of the Dependencies feature in FastAPI.</li>
<li>Use Python&#x27;s decorator feature.</li>
<li>Build a middleware in the FastAPI application, similar in concept to Global Dependencies.</li>
</ol>
<p>In this article, I choose option 1 for simplicity and efficiency.</p>
<blockquote>
<p>“Simplicity is the soul of efficiency.” 😁</p>
</blockquote>
<p>Next, I will create a rate-limit class. It will be responsible for connecting to Redis and executing the algorithm to filter requests. Additionally, we&#x27;ll need some helper functions to process the input data. Now, let&#x27;s start coding!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implement-rate-limit-module">Implement Rate-limit module<a href="#implement-rate-limit-module" class="hash-link" aria-label="Direct link to Implement Rate-limit module" title="Direct link to Implement Rate-limit module">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="initialize-ratelimiter-class">Initialize RateLimiter class<a href="#initialize-ratelimiter-class" class="hash-link" aria-label="Direct link to Initialize RateLimiter class" title="Direct link to Initialize RateLimiter class">​</a></h3>
<p>This is the core of this module. The RateLimiter class has the following constructor parameters:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/rate_limiter.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimiter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">__init__</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        rule</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        exception_message</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;Too many Request!&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        exception_status</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> status</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">HTTP_429_TOO_MANY_REQUESTS</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        redis</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> RedisClient </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> redis_client</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        lua_script</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> SLIDING_WINDOW_COUNTER</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">limit</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># count requests in duration time</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">duration_in_second</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> retrieve_rule</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rule</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">exp_message </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> exception_message</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">exp_status </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> exception_status</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> redis_client</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis_client </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> redis</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lua_script </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> lua_script</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lua_sha </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;&quot;</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>rule (str): This is the parameter that takes the filtering rule for the API. For example, <code>5/15s</code> .</li>
<li>exception_message (str): An optional parameter to customize the error message sent when a request violates the rule. Default, <code>Too many Request!</code>.</li>
<li>exception_status (int): An optional parameter to customize the error status code sent when a request violates the rule. Default, <code>429</code>.</li>
<li>redis (RedisClient): An optional parameter to change the Redis instance used.</li>
<li>lua_script (str): An optional parameter to change the script running the algorithm on the Redis server. You can find it on <a href="https://redis.io/learn/develop/dotnet/aspnetcore/rate-limiting/sliding-window#sliding-window-rate-limiter-lua-script" target="_blank" rel="noopener noreferrer">Sliding Window Rate Limiting app using ASP.NET (redis.io)</a>.</li>
</ul>
<p>There are some functions and information you might be curious about. Don’t worry, I will explain them in the next section.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ratelimiter-execution-function">RateLimiter execution function<a href="#ratelimiter-execution-function" class="hash-link" aria-label="Direct link to RateLimiter execution function" title="Direct link to RateLimiter execution function">​</a></h3>
<p>Since we are defining a class, it operates within Dependencies based on the <code>__call__</code> method.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/rate_limiter.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimiter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">__call__</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token operator" style="color:#475569">&gt;</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">not</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ping</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> RedisUnavailableException</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        key </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">req_key_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            is_valid </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">check</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">except</span><span class="token plain"> NoScriptError</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lua_sha </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">load_script</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lua_script</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            is_valid </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">check</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> is_valid </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token plain"></span></span><br></span><span class="token-line theme-code-block-highlighted-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> HTTPException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">status_code</span><span class="token operator" style="color:#475569">=</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">exp_status</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> detail</span><span class="token operator" style="color:#475569">=</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">exp_message</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this function, it performs 4 steps:</p>
<ol>
<li>
<p>In line <strong>4</strong>, ensure the server is connected to Redis.</p>
</li>
<li>
<p>In line <strong>7</strong>, create a key based on the incoming request. We will identify incoming requests based on request method, path and client IP. Example: <code>get:127.0.0.1:/api/v1/utils/limiting</code></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/rate_limiter.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimiter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#475569">@staticmethod</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">req_key_builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token operator" style="color:#475569">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;:&quot;</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">req</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">method</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">host</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">url</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>From line <strong>9-13</strong>, call <code>check</code> method with key parameter created in the previous step. If the Lua script hasn&#x27;t been loaded onto Redis, load it and then call <code>check</code> method again.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/rate_limiter.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimiter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">	</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">async</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">check</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token operator" style="color:#475569">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">redis_client</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">evaluate_sha</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">            self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lua_sha</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">duration_in_second</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">limit</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It will make a call to the Redis server and get the result from executing the Lua script we loaded earlier into Redis.</p>
</li>
<li>
<p>From line <strong>15-17</strong>, get the result from the <code>check</code> method and perform the corresponding action.</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="retrieve_rule-function">retrieve_rule function<a href="#retrieve_rule-function" class="hash-link" aria-label="Direct link to retrieve_rule function" title="Direct link to retrieve_rule function">​</a></h3>
<p>This function simply takes a valid string and extracts the corresponding values. The desired outcome is to determine the number of requests allowed within a given time frame (in seconds).</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./app/core/rate_limiter.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">PATTERN</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> Final</span><span class="token punctuation" style="color:#475569">[</span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;(\d+)\/((\d+)(s|m|h))+&quot;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">retrieve_rule</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rule</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">str</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        limit </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">PATTERN</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        duration </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">PATTERN</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        period </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">PATTERN</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">4</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        limit </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">limit</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        duration </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token builtin" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">duration</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">except</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">re</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> AttributeError</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> ValueError</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> RetrieveRuleException</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> limit </span><span class="token operator" style="color:#475569">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">or</span><span class="token plain"> duration </span><span class="token operator" style="color:#475569">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">raise</span><span class="token plain"> LimitRuleException</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    duration_in_s </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> duration    </span><span class="token comment" style="color:#6A9955"># second</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> period </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;m&quot;</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        duration_in_s </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> duration </span><span class="token operator" style="color:#475569">*</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">60</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">elif</span><span class="token plain"> period </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;h&quot;</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        duration_in_s </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> duration </span><span class="token operator" style="color:#475569">*</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">60</span><span class="token plain"> </span><span class="token operator" style="color:#475569">*</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">60</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> duration_in_s</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-use-lua-scripts">Why use Lua scripts?<a href="#why-use-lua-scripts" class="hash-link" aria-label="Direct link to Why use Lua scripts?" title="Direct link to Why use Lua scripts?">​</a></h3>
<p>Basically, the execution of the algorithm will be handled by Redis, which reduces the load on the API Server when there is a large number of incoming requests. Additionally, it is faster than running the algorithm on the API Server.</p>
<p>Lua scripts block everything. You can&#x27;t run two Lua scripts in parallel. So it ensures atomicity for our operations.</p>
<blockquote>
<p>The trick here is that everything needs to happen atomically, we want to be able to trim the set, check its cardinality, add an item to it, and set it&#x27;s expiration, all without anything changing in the interim.
<a href="https://redis.io/learn/develop/dotnet/aspnetcore/rate-limiting/sliding-window#sliding-window-rate-limiter-lua-script" target="_blank" rel="noopener noreferrer">— By Redis —</a></p>
</blockquote>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">local current_time = redis.call(&#x27;TIME&#x27;)</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">local trim_time = tonumber(current_time[1]) - ARGV[1]</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">redis.call(&#x27;ZREMRANGEBYSCORE&#x27;, KEYS[1], 0, trim_time)</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">local request_count = redis.call(&#x27;ZCARD&#x27;, KEYS[1])</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">if request_count &lt; tonumber(ARGV[2]) then</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    redis.call(&#x27;ZADD&#x27;, KEYS[1], current_time[1], current_time[1] .. current_time[2])</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    redis.call(&#x27;EXPIRE&#x27;, KEYS[1], ARGV[1])</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    return 0</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">end</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">return 1</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing">Testing<a href="#testing" class="hash-link" aria-label="Direct link to Testing" title="Direct link to Testing">​</a></h2>
<p>I created 2 APIs with Rate-limit middleware and 2 test scripts for it. The script will look like this:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockTitle_Ktv7">./tests/rate_limiting/test_rate_limit_1.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">url </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;http://localhost:8000/api/v1/utils/limiting1&quot;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">payload </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;&quot;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">def</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    now </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">now</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    response </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;GET&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> url</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> data</span><span class="token operator" style="color:#475569">=</span><span class="token plain">payload</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">print</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">now</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    time</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0.5</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># On my local machine, the request function take 2 seconds to get a response.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#6A9955"># Rule: 5/15s</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R1 success at 2.5s, redis contains [R1]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R2 success at 5s, redis contains [R1, R2]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R3 success at 7.5s, redis contains [R1, R2, R3]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R4 success at 10s, redis contains [R1, R2, R3, R4]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R5 success at 12.5s, redis contains [R1, R2, R3, R4, R5]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R6 fails at 15s, redis contains [R1, R2, R3, R4, R5]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#0f172a"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">send_request</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955"># R7 success at 18.5s, redis contains [R2, R3, R4, R5, R7]</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, let&#x27;s see the results:</p>
<p><img decoding="async" loading="lazy" alt="Test results" src="/assets/images/test-results-bbe79d181c7c7e1e219a1d150bdbaab4.png#center" width="659" height="147" class="img_ev3q"></p>
<p>API server logs:</p>
<p><img decoding="async" loading="lazy" alt="API Server Logs" src="/assets/images/api-server-logs-956ceccd09215b82def7393181e2be3f.png#center" width="661" height="237" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2>
<p>Instead of Redis, you can implement a queue/map in your application to store request values. But consider the scalability of your system—implementing in-app queues or maps like this is no longer suitable and can lead to redundancy and resource waste. Therefore, if your application has non-functional requirements for scalability, consider using shared storage solutions like <strong>Redis</strong> (<a href="https://redis.io/" target="_blank" rel="noopener noreferrer">Redis - The Real-time Data Platform</a>) or <strong>Memcached</strong> (<a href="https://memcached.org/" target="_blank" rel="noopener noreferrer">memcached - a distributed memory object caching system</a>).</p>
<p>Additionally, to implement rate-limiting as middleware in API server, we can also implement it at <strong>network layer</strong>. This is also an interesting topic, and I hope to share more about it in other posts.</p>
<p>Some packages that you may be interested in:</p>
<ul>
<li><a href="https://github.com/laurentS/slowapi" target="_blank" rel="noopener noreferrer">laurentS/slowapi: A rate limiter for Starlette and FastAPI (github.com)</a> (1.1k stars, 72 forks on 18/08/2024)</li>
<li><a href="https://github.com/long2ice/fastapi-limiter" target="_blank" rel="noopener noreferrer">long2ice/fastapi-limiter: A request rate limiter for fastapi (github.com)</a> (465 stars, 52 forks on 18/08/2024)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>We have explored some aspects of rate-limiting and how to implement it in FastAPI.</p>
<p>I hope this post was useful. If you need a project to run a demo on your environment, here is my <a href="https://github.com/pxuanbach/fastapi-essential-modules/tree/module/rate-limiting" target="_blank" rel="noopener noreferrer">Git repository</a>.</p>
<p>See you again!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://www.cloudflare.com/learning/bots/what-is-rate-limiting/" target="_blank" rel="noopener noreferrer">What is rate limiting? | Rate limiting and bots | Cloudflare</a></li>
<li><a href="https://developers.cloudflare.com/waf/rate-limiting-rules/best-practices/" target="_blank" rel="noopener noreferrer">Rate limiting best practices · Cloudflare Web Application Firewall (WAF) docs</a></li>
<li><a href="https://redis.io/learn/develop/dotnet/aspnetcore/rate-limiting/sliding-window#sliding-window-rate-limiter-lua-script" target="_blank" rel="noopener noreferrer">How to implement Sliding Window Rate Limiting app using ASP.NET Core &amp; Redis</a></li>
<li><a href="https://blogs.halodoc.io/taming-the-traffic-redis-and-lua-powered-sliding-window-rate-limiter-in-action/" target="_blank" rel="noopener noreferrer">Redis and Lua Powered Sliding Window Rate Limiter (halodoc.io)</a></li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/fastapi">fastapi</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/redis">redis</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rate-limit">rate-limit</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/python">python</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/essential-modules-fastapi">essential-modules-fastapi</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Essential modules for developing applications with FastAPI (P6 - Monitoring)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Essential modules for developing applications with FastAPI (P4 - Job Scheduler)</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#frameworklibrary-version" class="table-of-contents__link toc-highlight"><strong>Framework/Library version</strong></a></li><li><a href="#rate-limiting-overview" class="table-of-contents__link toc-highlight">Rate-limiting Overview</a><ul><li><a href="#what-exactly-is-rate-limiting" class="table-of-contents__link toc-highlight">What exactly is rate-limiting?</a></li><li><a href="#how-does-it-work" class="table-of-contents__link toc-highlight">How does it work?</a></li><li><a href="#prepare-before-coding" class="table-of-contents__link toc-highlight">Prepare before coding</a></li></ul></li><li><a href="#implement-rate-limit-module" class="table-of-contents__link toc-highlight">Implement Rate-limit module</a><ul><li><a href="#initialize-ratelimiter-class" class="table-of-contents__link toc-highlight">Initialize RateLimiter class</a></li><li><a href="#ratelimiter-execution-function" class="table-of-contents__link toc-highlight">RateLimiter execution function</a></li><li><a href="#retrieve_rule-function" class="table-of-contents__link toc-highlight">retrieve_rule function</a></li><li><a href="#why-use-lua-scripts" class="table-of-contents__link toc-highlight">Why use Lua scripts?</a></li></ul></li><li><a href="#testing" class="table-of-contents__link toc-highlight">Testing</a></li><li><a href="#notes" class="table-of-contents__link toc-highlight">Notes</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ImmersedinCode Blog</div><ul class="footer__items clean-list"><li class="footer__item"><p>Simplicity is the soul of efficiency.</p></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/pxuanbach" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="mailto:pxuanbach1412@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gmail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/pham-bach-97a389217/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Bach Pham, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>