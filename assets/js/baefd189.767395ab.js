"use strict";(self.webpackChunkme=self.webpackChunkme||[]).push([[2945],{7537:(e,i,t)=>{t.r(i),t.d(i,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var n=t(4848),s=t(8453);const r={slug:"essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting",title:"Essential modules for developing applications with FastAPI (P5 - Rate-limiting)",authors:["pxuanbach"],tags:["fastapi","redis","rate-limit","python","essential-modules-fastapi"],date:"2024-08-15T10:00",image:"/img/09_essential-modules-for-developing-applications-with-fastapi-p5/featured.png"},a=void 0,l={permalink:"/blog/essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting",source:"@site/blog/09_essential-modules-for-developing-applications-with-fastapi-p5/index.md",title:"Essential modules for developing applications with FastAPI (P5 - Rate-limiting)",description:"Another week has passed, how was your weekend? I am planning my future journey.",date:"2024-08-15T10:00:00.000Z",tags:[{label:"fastapi",permalink:"/blog/tags/fastapi"},{label:"redis",permalink:"/blog/tags/redis"},{label:"rate-limit",permalink:"/blog/tags/rate-limit"},{label:"python",permalink:"/blog/tags/python"},{label:"essential-modules-fastapi",permalink:"/blog/tags/essential-modules-fastapi"}],readingTime:9.74,hasTruncateMarker:!0,authors:[{name:"Bach Pham",title:"Software Engineer",url:"https://github.com/pxuanbach",imageURL:"https://avatars.githubusercontent.com/u/55500268?v=4",key:"pxuanbach"}],frontMatter:{slug:"essential-modules-for-developing-applications-with-fastapi-p5-rate-limiting",title:"Essential modules for developing applications with FastAPI (P5 - Rate-limiting)",authors:["pxuanbach"],tags:["fastapi","redis","rate-limit","python","essential-modules-fastapi"],date:"2024-08-15T10:00",image:"/img/09_essential-modules-for-developing-applications-with-fastapi-p5/featured.png"},unlisted:!1,prevItem:{title:"Essential modules for developing applications with FastAPI (P6 - Monitoring)",permalink:"/blog/essential-modules-for-developing-applications-with-fastapi-p6-monitoring"},nextItem:{title:"Essential modules for developing applications with FastAPI (P4 - Job Scheduler)",permalink:"/blog/essential-modules-for-developing-applications-with-fastapi-p4-job-scheduler"}},o={authorsImageUrls:[void 0]},c=[{value:"<strong>Framework/Library version</strong>",id:"frameworklibrary-version",level:2},{value:"Rate-limiting Overview",id:"rate-limiting-overview",level:2},{value:"What exactly is rate-limiting?",id:"what-exactly-is-rate-limiting",level:3},{value:"How does it work?",id:"how-does-it-work",level:3},{value:"Prepare before coding",id:"prepare-before-coding",level:3},{value:"Implement Rate-limit module",id:"implement-rate-limit-module",level:2},{value:"Initialize RateLimiter class",id:"initialize-ratelimiter-class",level:3},{value:"RateLimiter execution function",id:"ratelimiter-execution-function",level:3},{value:"retrieve_rule function",id:"retrieve_rule-function",level:3},{value:"Why use Lua scripts?",id:"why-use-lua-scripts",level:3},{value:"Testing",id:"testing",level:2},{value:"Notes",id:"notes",level:2},{value:"Conclusion",id:"conclusion",level:2},{value:"References",id:"references",level:2}];function d(e){const i={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(i.p,{children:"Another week has passed, how was your weekend? I am planning my future journey."}),"\n",(0,n.jsx)(i.p,{children:"In this article, I will introduce you to a crucial module to protect your system. As the title of the article, it is about Rate-limiting. Let's explore how we can apply it to FastAPI!"}),"\n",(0,n.jsx)(i.h2,{id:"frameworklibrary-version",children:(0,n.jsx)(i.strong,{children:"Framework/Library version"})}),"\n",(0,n.jsxs)(i.p,{children:["This project uses ",(0,n.jsx)(i.a,{href:"https://www.python.org/",children:"Python"})," 3.10 as the environment and ",(0,n.jsx)(i.a,{href:"https://python-poetry.org/",children:"Poetry"})," as the package manager."]}),"\n",(0,n.jsx)(i.p,{children:"The code and examples in this post will use frameworks/libraries with the following versions."}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-toml",children:'[tool.poetry.dependencies]\r\npython = "^3.10"\r\nuvicorn = {extras = ["standard"], version = "^0.24.0.post1"}\r\nfastapi = "^0.109.1"\r\npython-multipart = "^0.0.7"\r\nemail-validator = "^2.1.0.post1"\r\npasslib = {extras = ["bcrypt"], version = "^1.7.4"}\r\ntenacity = "^8.2.3"\r\npydantic = ">2.0"\r\nemails = "^0.6"\r\ngunicorn = "^21.2.0"\r\njinja2 = "^3.1.2"\r\nalembic = "^1.12.1"\r\npython-jose = {extras = ["cryptography"], version = "^3.3.0"}\r\nhttpx = "^0.25.1"\r\npsycopg = {extras = ["binary"], version = "^3.1.13"}\r\n\r\nsqlmodel = "^0.0.16"\r\n\r\n# Pin bcrypt until passlib supports the latest\r\nbcrypt = "4.0.1"\r\npydantic-settings = "^2.2.1"\r\nsentry-sdk = {extras = ["fastapi"], version = "^1.40.6"}\r\npsycopg2 = "^2.9.9"\r\nasyncpg = "^0.29.0"\r\nredis = {extras = ["hiredis"], version = "^5.0.3"}\r\norjson = "^3.10.0"\r\napscheduler = "^3.10.4"\n'})}),"\n",(0,n.jsx)(i.h2,{id:"rate-limiting-overview",children:"Rate-limiting Overview"}),"\n",(0,n.jsx)(i.h3,{id:"what-exactly-is-rate-limiting",children:"What exactly is rate-limiting?"}),"\n",(0,n.jsxs)(i.blockquote,{children:["\n",(0,n.jsxs)(i.p,{children:["Rate limiting is a strategy for limiting network traffic. It puts a cap on how often someone can repeat an action within a certain timeframe \u2013 for instance, trying to log in to an account. Rate limiting can help stop certain kinds of malicious\xa0",(0,n.jsx)(i.a,{href:"https://www.cloudflare.com/learning/bots/what-is-a-bot/",children:"bot activity"}),". It can also reduce strain on web servers.\r\n",(0,n.jsx)(i.a,{href:"https://www.cloudflare.com/learning/bots/what-is-rate-limiting/",children:(0,n.jsx)(i.em,{children:"\u2014 By Cloud Flare \u2014"})})]}),"\n"]}),"\n",(0,n.jsx)(i.p,{children:"Besides, it also offers other benefits, such as monitoring API usage, enforcing API usage policies, and even implementing some business logic to differentiate customer permission levels."}),"\n",(0,n.jsx)(i.p,{children:"There are many types of rate-limiting to meet various needs, including Fixed Window Counter, Sliding Window Counter, Token Bucket, and more. Additionally, rule limiting is also a topic of concern. I will introduce Fixed Window Counter rate-limiting in this article with an IP-based limiting mechanism."}),"\n",(0,n.jsx)(i.h3,{id:"how-does-it-work",children:"How does it work?"}),"\n",(0,n.jsx)(i.p,{children:"I'll give a few simple examples to describe how Rate-limit works; take a look at the image below:"}),"\n",(0,n.jsx)(i.p,{children:(0,n.jsx)(i.img,{alt:"How It Work",src:t(1318).A+"#center",width:"531",height:"491"})}),"\n",(0,n.jsx)(i.p,{children:"Suppose we have a Client sending requests to a Server, and we set a rule on the Server to only accept 2 requests within 1 minute. Therefore, if more than 2 requests are sent from the Client, starting from the 3rd request, an error will occur and it will be responded to immediately."}),"\n",(0,n.jsxs)(i.p,{children:["Perhaps you are curious as to why the 1-minute time frame is not calculated from point ",(0,n.jsx)(i.strong,{children:"(1)"})," but rather from point ",(0,n.jsx)(i.strong,{children:"(2)"}),". To understand this, you'll need to learn about Rate-Limit algorithms. If the time were calculated from point ",(0,n.jsx)(i.strong,{children:"(1)"})," and I could successfully make 2 requests after 1 minute, that would be the Fixed Window Counter algorithm. I calculate the time from point ",(0,n.jsx)(i.strong,{children:"(2)"})," because I am applying the Sliding Window Counter algorithm."]}),"\n",(0,n.jsxs)(i.p,{children:[(0,n.jsx)(i.strong,{children:"Fixed Window Counter algorithm"})," can be described as follows:"]}),"\n",(0,n.jsx)(i.p,{children:(0,n.jsx)(i.img,{alt:"Fixed Window Counter Example",src:t(8679).A+"#center",width:"521",height:"261"})}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsx)(i.li,{children:"We still use the 2 requests per minute rule."}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"R1"})," and ",(0,n.jsx)(i.strong,{children:"R2"})," belong to Frame 1, and both responded successfully. At this point, Server will count ",(0,n.jsx)(i.strong,{children:"R1"})," and ",(0,n.jsx)(i.strong,{children:"R2"}),", with count = 2."]}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"R3"})," failed because Frame 1 reached limit (count = 2 = limit)."]}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"R5"})," and ",(0,n.jsx)(i.strong,{children:"R6"})," belong to Frame 2, and do the same with ",(0,n.jsx)(i.strong,{children:"R1"}),", ",(0,n.jsx)(i.strong,{children:"R2"}),"."]}),"\n"]}),"\n",(0,n.jsxs)(i.p,{children:[(0,n.jsx)(i.strong,{children:"Sliding Window Counter algorithm"})," can be described as follows:"]}),"\n",(0,n.jsx)(i.p,{children:(0,n.jsx)(i.img,{alt:"Sliding Window Counter Example",src:t(9655).A+"#center",width:"542",height:"251"})}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"R1"})," was successful because Frame 1 had no previous requests. We store ",(0,n.jsx)(i.strong,{children:"R1"})," with time = 60."]}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"R2"})," also executes successfully. Because in Frame 2, there is only 1 request, which is ",(0,n.jsx)(i.strong,{children:"R1"})," (count = 1). At this stage, we adds ",(0,n.jsx)(i.strong,{children:"R2"})," with time = 75 to cache."]}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"R3"})," failed because Frame 3 reached limit. We will check how many requests have been stored from around 30 to 90. Oh, we have ",(0,n.jsx)(i.strong,{children:"R1"})," and ",(0,n.jsx)(i.strong,{children:"R2"})," with corresponding times of 60 and 75."]}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"R4"})," was successful because Frame 4 only contains ",(0,n.jsx)(i.strong,{children:"R2"})," (count = 1). At this point, we will cache ",(0,n.jsx)(i.strong,{children:"R2"})," and ",(0,n.jsx)(i.strong,{children:"R4"}),"."]}),"\n"]}),"\n",(0,n.jsx)(i.h3,{id:"prepare-before-coding",children:"Prepare before coding"}),"\n",(0,n.jsxs)(i.p,{children:["In ",(0,n.jsx)(i.a,{href:"/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching",children:"part 3 - caching"}),", we integrated Redis into our system. So I'm going to reuse it to store some stuff."]}),"\n",(0,n.jsx)(i.p,{children:"Now, let's find out what we are going to do."}),"\n",(0,n.jsx)(i.p,{children:"In the API Server, I usually create a rate-limit module and treat it as middleware. First, the request will pass through the Rate-limit middleware, which will check whether this request is allowed to proceed to the next middleware or the execution layer."}),"\n",(0,n.jsx)(i.p,{children:(0,n.jsx)(i.img,{alt:"Request to Rate-limit Middleware",src:t(6927).A+"#center",width:"691",height:"131"})}),"\n",(0,n.jsx)(i.p,{children:"When working with FastAPI, we have many ways to implement this module. I can list a few methods as follows:"}),"\n",(0,n.jsxs)(i.ol,{children:["\n",(0,n.jsx)(i.li,{children:"Take advantage of the Dependencies feature in FastAPI."}),"\n",(0,n.jsx)(i.li,{children:"Use Python's decorator feature."}),"\n",(0,n.jsx)(i.li,{children:"Build a middleware in the FastAPI application, similar in concept to Global Dependencies."}),"\n"]}),"\n",(0,n.jsx)(i.p,{children:"In this article, I choose option 1 for simplicity and efficiency."}),"\n",(0,n.jsxs)(i.blockquote,{children:["\n",(0,n.jsx)(i.p,{children:"\u201cSimplicity is the soul of efficiency.\u201d \ud83d\ude01"}),"\n"]}),"\n",(0,n.jsx)(i.p,{children:"Next, I will create a rate-limit class. It will be responsible for connecting to Redis and executing the algorithm to filter requests. Additionally, we'll need some helper functions to process the input data. Now, let's start coding!"}),"\n",(0,n.jsx)(i.h2,{id:"implement-rate-limit-module",children:"Implement Rate-limit module"}),"\n",(0,n.jsx)(i.h3,{id:"initialize-ratelimiter-class",children:"Initialize RateLimiter class"}),"\n",(0,n.jsx)(i.p,{children:"This is the core of this module. The RateLimiter class has the following constructor parameters:"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-python",metastring:'{4-8} showLineNumbers title="./app/core/rate_limiter.py"',children:'class RateLimiter():\r\n    def __init__(\r\n        self,\r\n        rule: str,\r\n        exception_message: str = "Too many Request!",\r\n        exception_status: int = status.HTTP_429_TOO_MANY_REQUESTS,\r\n        redis: RedisClient = redis_client,\r\n        lua_script: str = SLIDING_WINDOW_COUNTER\r\n    ) -> None:\r\n        (\r\n            self.limit,  # count requests in duration time\r\n            self.duration_in_second\r\n        ) = retrieve_rule(rule)\r\n        self.exp_message = exception_message\r\n        self.exp_status = exception_status\r\n        if redis_client:\r\n            self.redis_client = redis\r\n        self.lua_script = lua_script\r\n        self.lua_sha = ""\n'})}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsxs)(i.li,{children:["rule (str): This is the parameter that takes the filtering rule for the API. For example, ",(0,n.jsx)(i.code,{children:"5/15s"})," ."]}),"\n",(0,n.jsxs)(i.li,{children:["exception_message (str): An optional parameter to customize the error message sent when a request violates the rule. Default, ",(0,n.jsx)(i.code,{children:"Too many Request!"}),"."]}),"\n",(0,n.jsxs)(i.li,{children:["exception_status (int): An optional parameter to customize the error status code sent when a request violates the rule. Default, ",(0,n.jsx)(i.code,{children:"429"}),"."]}),"\n",(0,n.jsx)(i.li,{children:"redis (RedisClient): An optional parameter to change the Redis instance used."}),"\n",(0,n.jsxs)(i.li,{children:["lua_script (str): An optional parameter to change the script running the algorithm on the Redis server. You can find it on ",(0,n.jsx)(i.a,{href:"https://redis.io/learn/develop/dotnet/aspnetcore/rate-limiting/sliding-window#sliding-window-rate-limiter-lua-script",children:"Sliding Window Rate Limiting app using ASP.NET (redis.io)"}),"."]}),"\n"]}),"\n",(0,n.jsx)(i.p,{children:"There are some functions and information you might be curious about. Don\u2019t worry, I will explain them in the next section."}),"\n",(0,n.jsx)(i.h3,{id:"ratelimiter-execution-function",children:"RateLimiter execution function"}),"\n",(0,n.jsxs)(i.p,{children:["Since we are defining a class, it operates within Dependencies based on the ",(0,n.jsx)(i.code,{children:"__call__"})," method."]}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-python",metastring:'{4,7,9-13,15-17} showLineNumbers title="./app/core/rate_limiter.py"',children:"class RateLimiter():\r\n    ...\r\n    async def __call__(self, request: Request) -> Any:\r\n        if not await self.redis_client.ping():\r\n            raise RedisUnavailableException\r\n\r\n        key = self.req_key_builder(request)\r\n\r\n        try:\r\n            is_valid = await self.check(key)\r\n        except NoScriptError:\r\n            self.lua_sha = await self.redis_client.load_script(self.lua_script)\r\n            is_valid = await self.check(key)\r\n\r\n        if is_valid == 0:\r\n            return True\r\n        raise HTTPException(status_code=self.exp_status, detail=self.exp_message)\n"})}),"\n",(0,n.jsx)(i.p,{children:"In this function, it performs 4 steps:"}),"\n",(0,n.jsxs)(i.ol,{children:["\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:["In line ",(0,n.jsx)(i.strong,{children:"4"}),", ensure the server is connected to Redis."]}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:["In line ",(0,n.jsx)(i.strong,{children:"7"}),", create a key based on the incoming request. We will identify incoming requests based on request method, path and client IP. Example: ",(0,n.jsx)(i.code,{children:"get:127.0.0.1:/api/v1/utils/limiting"})]}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-python",metastring:'showLineNumbers title="./app/core/rate_limiter.py"',children:'class RateLimiter():\r\n    ...\r\n    @staticmethod\r\n    def req_key_builder(req: Request, **kwargs):\r\n        return ":".join([req.method.lower(), req.client.host, req.url.path])\n'})}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:["From line ",(0,n.jsx)(i.strong,{children:"9-13"}),", call ",(0,n.jsx)(i.code,{children:"check"})," method with key parameter created in the previous step. If the Lua script hasn't been loaded onto Redis, load it and then call ",(0,n.jsx)(i.code,{children:"check"})," method again."]}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-python",metastring:'showLineNumbers title="./app/core/rate_limiter.py"',children:"class RateLimiter():\r\n    ...\t\r\n    async def check(self, key: str, **kwargs):\r\n        return await self.redis_client.evaluate_sha(\r\n            self.lua_sha, 1, [key, str(self.duration_in_second), str(self.limit)]\r\n        )\n"})}),"\n",(0,n.jsx)(i.p,{children:"It will make a call to the Redis server and get the result from executing the Lua script we loaded earlier into Redis."}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:["From line ",(0,n.jsx)(i.strong,{children:"15-17"}),", get the result from the ",(0,n.jsx)(i.code,{children:"check"})," method and perform the corresponding action."]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(i.h3,{id:"retrieve_rule-function",children:"retrieve_rule function"}),"\n",(0,n.jsx)(i.p,{children:"This function simply takes a valid string and extracts the corresponding values. The desired outcome is to determine the number of requests allowed within a given time frame (in seconds)."}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-python",metastring:'showLineNumbers title="./app/core/rate_limiter.py"',children:'PATTERN: Final[str] = "(\\d+)\\/((\\d+)(s|m|h))+"\r\n\r\ndef retrieve_rule(rule: str):\r\n    try:\r\n        limit = re.search(PATTERN, rule).group(1)\r\n        duration = re.search(PATTERN, rule).group(3)\r\n        period = re.search(PATTERN, rule).group(4)\r\n        limit = int(limit)\r\n        duration = int(duration)\r\n    except (re.error, AttributeError, ValueError):\r\n        raise RetrieveRuleException\r\n    \r\n    if limit < 1 or duration < 0:\r\n        raise LimitRuleException\r\n\r\n    duration_in_s = duration    # second\r\n    if period == "m":\r\n        duration_in_s = duration * 60\r\n    elif period == "h":\r\n        duration_in_s = duration * 60 * 60\r\n    return limit, duration_in_s\n'})}),"\n",(0,n.jsx)(i.h3,{id:"why-use-lua-scripts",children:"Why use Lua scripts?"}),"\n",(0,n.jsx)(i.p,{children:"Basically, the execution of the algorithm will be handled by Redis, which reduces the load on the API Server when there is a large number of incoming requests. Additionally, it is faster than running the algorithm on the API Server."}),"\n",(0,n.jsx)(i.p,{children:"Lua scripts block everything. You can't run two Lua scripts in parallel. So it ensures atomicity for our operations."}),"\n",(0,n.jsxs)(i.blockquote,{children:["\n",(0,n.jsxs)(i.p,{children:["The trick here is that everything needs to happen atomically, we want to be able to trim the set, check its cardinality, add an item to it, and set it's expiration, all without anything changing in the interim.\r\n",(0,n.jsx)(i.a,{href:"https://redis.io/learn/develop/dotnet/aspnetcore/rate-limiting/sliding-window#sliding-window-rate-limiter-lua-script",children:"\u2014 By Redis \u2014"})]}),"\n"]}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-lua",metastring:"showLineNumbers",children:"local current_time = redis.call('TIME')\r\nlocal trim_time = tonumber(current_time[1]) - ARGV[1]\r\nredis.call('ZREMRANGEBYSCORE', KEYS[1], 0, trim_time)\r\nlocal request_count = redis.call('ZCARD', KEYS[1])\r\n\r\nif request_count < tonumber(ARGV[2]) then\r\n    redis.call('ZADD', KEYS[1], current_time[1], current_time[1] .. current_time[2])\r\n    redis.call('EXPIRE', KEYS[1], ARGV[1])\r\n    return 0\r\nend\r\nreturn 1\n"})}),"\n",(0,n.jsx)(i.h2,{id:"testing",children:"Testing"}),"\n",(0,n.jsx)(i.p,{children:"I created 2 APIs with Rate-limit middleware and 2 test scripts for it. The script will look like this:"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-python",metastring:'showLineNumbers title="./tests/rate_limiting/test_rate_limit_1.py"',children:'url = "http://localhost:8000/api/v1/utils/limiting1"\r\npayload = ""\r\n\r\ndef send_request():\r\n    now = datetime.now()\r\n    response = requests.request("GET", url, data=payload)\r\n    print(now, response.text)\r\n    time.sleep(0.5)\r\n\r\n# On my local machine, the request function take 2 seconds to get a response.\r\n# Rule: 5/15s\r\nsend_request()  # R1 success at 2.5s, redis contains [R1]\r\nsend_request()  # R2 success at 5s, redis contains [R1, R2]\r\nsend_request()  # R3 success at 7.5s, redis contains [R1, R2, R3]\r\nsend_request()  # R4 success at 10s, redis contains [R1, R2, R3, R4]\r\nsend_request()  # R5 success at 12.5s, redis contains [R1, R2, R3, R4, R5]\r\nsend_request()  # R6 fails at 15s, redis contains [R1, R2, R3, R4, R5]\r\nsend_request()  # R7 success at 18.5s, redis contains [R2, R3, R4, R5, R7]\n'})}),"\n",(0,n.jsx)(i.p,{children:"Now, let's see the results:"}),"\n",(0,n.jsx)(i.p,{children:(0,n.jsx)(i.img,{alt:"Test results",src:t(8111).A+"#center",width:"659",height:"147"})}),"\n",(0,n.jsx)(i.p,{children:"API server logs:"}),"\n",(0,n.jsx)(i.p,{children:(0,n.jsx)(i.img,{alt:"API Server Logs",src:t(5903).A+"#center",width:"661",height:"237"})}),"\n",(0,n.jsx)(i.h2,{id:"notes",children:"Notes"}),"\n",(0,n.jsxs)(i.p,{children:["Instead of Redis, you can implement a queue/map in your application to store request values. But consider the scalability of your system\u2014implementing in-app queues or maps like this is no longer suitable and can lead to redundancy and resource waste. Therefore, if your application has non-functional requirements for scalability, consider using shared storage solutions like ",(0,n.jsx)(i.strong,{children:"Redis"})," (",(0,n.jsx)(i.a,{href:"https://redis.io/",children:"Redis - The Real-time Data Platform"}),") or ",(0,n.jsx)(i.strong,{children:"Memcached"})," (",(0,n.jsx)(i.a,{href:"https://memcached.org/",children:"memcached - a distributed memory object caching system"}),")."]}),"\n",(0,n.jsxs)(i.p,{children:["Additionally, to implement rate-limiting as middleware in API server, we can also implement it at ",(0,n.jsx)(i.strong,{children:"network layer"}),". This is also an interesting topic, and I hope to share more about it in other posts."]}),"\n",(0,n.jsx)(i.p,{children:"Some packages that you may be interested in:"}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.a,{href:"https://github.com/laurentS/slowapi",children:"laurentS/slowapi: A rate limiter for Starlette and FastAPI (github.com)"})," (1.1k stars, 72 forks on 18/08/2024)"]}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.a,{href:"https://github.com/long2ice/fastapi-limiter",children:"long2ice/fastapi-limiter: A request rate limiter for fastapi (github.com)"})," (465 stars, 52 forks on 18/08/2024)"]}),"\n"]}),"\n",(0,n.jsx)(i.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,n.jsx)(i.p,{children:"We have explored some aspects of rate-limiting and how to implement it in FastAPI."}),"\n",(0,n.jsxs)(i.p,{children:["I hope this post was useful. If you need a project to run a demo on your environment, here is my\xa0",(0,n.jsx)(i.a,{href:"https://github.com/pxuanbach/fastapi-essential-modules/tree/module/rate-limiting",children:"Git repository"}),"."]}),"\n",(0,n.jsx)(i.p,{children:"See you again!"}),"\n",(0,n.jsx)(i.h2,{id:"references",children:"References"}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsx)(i.li,{children:(0,n.jsx)(i.a,{href:"https://www.cloudflare.com/learning/bots/what-is-rate-limiting/",children:"What is rate limiting? | Rate limiting and bots | Cloudflare"})}),"\n",(0,n.jsx)(i.li,{children:(0,n.jsx)(i.a,{href:"https://developers.cloudflare.com/waf/rate-limiting-rules/best-practices/",children:"Rate limiting best practices \xb7 Cloudflare Web Application Firewall (WAF) docs"})}),"\n",(0,n.jsx)(i.li,{children:(0,n.jsx)(i.a,{href:"https://redis.io/learn/develop/dotnet/aspnetcore/rate-limiting/sliding-window#sliding-window-rate-limiter-lua-script",children:"How to implement Sliding Window Rate Limiting app using ASP.NET Core & Redis"})}),"\n",(0,n.jsx)(i.li,{children:(0,n.jsx)(i.a,{href:"https://blogs.halodoc.io/taming-the-traffic-redis-and-lua-powered-sliding-window-rate-limiter-in-action/",children:"Redis and Lua Powered Sliding Window Rate Limiter (halodoc.io)"})}),"\n"]})]})}function h(e={}){const{wrapper:i}={...(0,s.R)(),...e.components};return i?(0,n.jsx)(i,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},5903:(e,i,t)=>{t.d(i,{A:()=>n});const n=t.p+"assets/images/api-server-logs-956ceccd09215b82def7393181e2be3f.png"},8679:(e,i,t)=>{t.d(i,{A:()=>n});const n=t.p+"assets/images/fixed-window-counter-example-4ac6045486f5487be115b22878994f0a.png"},1318:(e,i,t)=>{t.d(i,{A:()=>n});const n=t.p+"assets/images/how-it-work-7b13a0fe01410027bc8e74f6620ed664.png"},6927:(e,i,t)=>{t.d(i,{A:()=>n});const n=t.p+"assets/images/request-to-rate-limit-middleware-9696d4f339085cd77c0a8268f7b78653.png"},9655:(e,i,t)=>{t.d(i,{A:()=>n});const n=t.p+"assets/images/sliding-window-counter-example-60a8886904147c3066897af1632d0bcb.png"},8111:(e,i,t)=>{t.d(i,{A:()=>n});const n=t.p+"assets/images/test-results-bbe79d181c7c7e1e219a1d150bdbaab4.png"},8453:(e,i,t)=>{t.d(i,{R:()=>a,x:()=>l});var n=t(6540);const s={},r=n.createContext(s);function a(e){const i=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function l(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),n.createElement(r.Provider,{value:i},e.children)}}}]);