"use strict";(self.webpackChunkme=self.webpackChunkme||[]).push([[4275],{8731:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var t=s(4848),i=s(8453);const a={slug:"essential-modules-for-developing-applications-with-fastapi-p3-caching",title:"Essential modules for developing applications with FastAPI (P3 - Caching)",authors:["pxuanbach"],tags:["caching","fastapi","redis","python","essential-modules-fastapi"],date:"2024-04-20T10:00",image:"/img/02_essential-modules-for-developing-applications-with-fastapi-p1/featured.png"},r=void 0,o={permalink:"/blog/essential-modules-for-developing-applications-with-fastapi-p3-caching",source:"@site/blog/05_essential-modules-for-developing-applications-with-fastapi-p3/index.md",title:"Essential modules for developing applications with FastAPI (P3 - Caching)",description:"Hello, we meet again!",date:"2024-04-20T10:00:00.000Z",tags:[{label:"caching",permalink:"/blog/tags/caching"},{label:"fastapi",permalink:"/blog/tags/fastapi"},{label:"redis",permalink:"/blog/tags/redis"},{label:"python",permalink:"/blog/tags/python"},{label:"essential-modules-fastapi",permalink:"/blog/tags/essential-modules-fastapi"}],readingTime:7.81,hasTruncateMarker:!0,authors:[{name:"Bach Pham",title:"Software Engineer",url:"https://github.com/pxuanbach",imageURL:"https://avatars.githubusercontent.com/u/55500268?v=4",key:"pxuanbach"}],frontMatter:{slug:"essential-modules-for-developing-applications-with-fastapi-p3-caching",title:"Essential modules for developing applications with FastAPI (P3 - Caching)",authors:["pxuanbach"],tags:["caching","fastapi","redis","python","essential-modules-fastapi"],date:"2024-04-20T10:00",image:"/img/02_essential-modules-for-developing-applications-with-fastapi-p1/featured.png"},unlisted:!1,prevItem:{title:"Destructuring in Python",permalink:"/blog/destructuring-in-python"},nextItem:{title:"Dockerize MedusaJS Components: Optimize and Deploy Your Application",permalink:"/blog/dockerizing-medusajs-for-optimized-deployment"}},c={authorsImageUrls:[void 0]},l=[{value:"Framework/Library version",id:"frameworklibrary-version",level:2},{value:"Caching",id:"caching",level:2},{value:"Prepare an adapter for Redis",id:"prepare-an-adapter-for-redis",level:3},{value:"Implement logic for caching",id:"implement-logic-for-caching",level:3},{value:"What is Redis?",id:"what-is-redis",level:4},{value:"What to cache?",id:"what-to-cache",level:4},{value:"How long to keep it?",id:"how-long-to-keep-it",level:4},{value:"Integration with FastAPI",id:"integration-with-fastapi",level:3},{value:"Conclusion",id:"conclusion",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"Hello, we meet again!"}),"\n",(0,t.jsx)(n.p,{children:"In the previous post, I introduced two quite important modules in a project, which are Migration and Logging. In this article, I will introduce the Caching module."}),"\n",(0,t.jsx)(n.p,{children:"I hope you enjoy it!"}),"\n",(0,t.jsx)(n.h2,{id:"frameworklibrary-version",children:"Framework/Library version"}),"\n",(0,t.jsxs)(n.p,{children:["This project uses ",(0,t.jsx)(n.a,{href:"https://www.python.org/",children:"Python"})," 3.10 as the environment and ",(0,t.jsx)(n.a,{href:"https://python-poetry.org/",children:"Poetry"})," as the package manager."]}),"\n",(0,t.jsx)(n.p,{children:"The code and examples in this post will use frameworks/libraries with the following versions."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",metastring:'showLineNumbers title="./pyproject.toml"',children:'[tool.poetry.dependencies]\npython = "^3.10"\nuvicorn = {extras = ["standard"], version = "^0.24.0.post1"}\nfastapi = "^0.109.1"\npython-multipart = "^0.0.7"\nemail-validator = "^2.1.0.post1"\npasslib = {extras = ["bcrypt"], version = "^1.7.4"}\ntenacity = "^8.2.3"\npydantic = ">2.0"\nemails = "^0.6"\ngunicorn = "^21.2.0"\njinja2 = "^3.1.2"\nalembic = "^1.12.1"\npython-jose = {extras = ["cryptography"], version = "^3.3.0"}\nhttpx = "^0.25.1"\npsycopg = {extras = ["binary"], version = "^3.1.13"}\n\nsqlmodel = "^0.0.16"\n\n# Pin bcrypt until passlib supports the latest\nbcrypt = "4.0.1"\npydantic-settings = "^2.2.1"\nsentry-sdk = {extras = ["fastapi"], version = "^1.40.6"}\npsycopg2 = "^2.9.9"\nasyncpg = "^0.29.0"\nredis = {extras = ["hiredis"], version = "^5.0.3"}\norjson = "^3.10.0"\n'})}),"\n",(0,t.jsx)(n.h2,{id:"caching",children:"Caching"}),"\n",(0,t.jsx)(n.p,{children:"We will explore integrating a caching module into FastAPI. This caching module will automatically store the results of previous API requests, thereby improving response times and reducing server load. There are many other places where you can cache data, such as In-memory, Redis, DynamoDB,\u2026 This section will implement a simple Redis caching solution for APIs."}),"\n",(0,t.jsxs)(n.p,{children:["First, we should install the ",(0,t.jsx)(n.a,{href:"https://github.com/redis/redis-py",children:"Redis"})," package."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"poetry add redis   # pip install redis\n"})}),"\n",(0,t.jsx)(n.h3,{id:"prepare-an-adapter-for-redis",children:"Prepare an adapter for Redis"}),"\n",(0,t.jsx)(n.p,{children:"When working with Redis, we must manage connecting and disconnecting to Redis as necessary. Additionally, certain features require additional logic to integrate with the system seamlessly."}),"\n",(0,t.jsx)(n.p,{children:"So, I define some functions that I want to use such as\u2026"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Connect."}),"\n",(0,t.jsx)(n.li,{children:"Disconnect."}),"\n",(0,t.jsx)(n.li,{children:"Add a key to Redis."}),"\n",(0,t.jsx)(n.li,{children:"Check the key exists in Redis."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Let\u2019s build it."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'showLineNumbers title="./app/core/redis.py"',children:'from typing import Any, Dict, Tuple\nimport redis.asyncio as aioredis\nimport logging\nfrom app.utils import ORJsonCoder\n\nclass RedisClient:\n    async def connect(self, redis_url: str):\n        self.pool = aioredis.ConnectionPool().from_url(redis_url)\n        self.redis = aioredis.Redis.from_pool(self.pool)\n        if await self.redis.ping():\n            logging.info("Redis connected")\n            return True\n        logging.warning("Cannot connect to Redis")\n        return False\n    \n    async def add_to_cache(self, key: str, value: Dict, expire: int) -> bool:\n        response_data = None\n        try:\n            response_data = ORJsonCoder().encode(value)\n        except TypeError:\n            message = f"Object of type {type(value)} is not JSON-serializable"\n            logging.error(message)\n            return False\n        cached = await self.redis.set(name=key, value=response_data, ex=expire)\n        if cached:\n            logging.info(f"{key} added to cache")\n        else:  # pragma: no cover\n            logging.warning(f"Failed to cache key {key}")\n        return cached\n    \n    async def check_cache(self, key: str) -> Tuple[int, str]:\n        pipe = self.redis.pipeline()\n        ttl, in_cache = await pipe.ttl(key).get(key).execute()\n        if in_cache:\n            logging.info(f"Key {key} found in cache")\n        return (ttl, in_cache)\n\n    async def disconnect(self):\n        if await self.redis.ping():\n            await self.redis.aclose()\n            logging.info("Redis disconnected")\n        return None\n\nredis_client = RedisClient()\n'})}),"\n",(0,t.jsxs)(n.p,{children:["In this class, you might wonder about the ",(0,t.jsx)(n.code,{children:"ORJsonCoder"})," module. Where is it? What can it do?"]}),"\n",(0,t.jsxs)(n.p,{children:["This module provides methods to perform JSON encoding and decoding using the ",(0,t.jsx)(n.a,{href:"https://github.com/ijl/orjson",children:"orjson"})," library, aimed at increasing speed and performance compared to standard JSON libraries in Python."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'showLineNumbers title="./app/utils/orjson_coder.py"',children:"from typing import Any, Union\nfrom fastapi.encoders import jsonable_encoder\nimport orjson\n\nclass ORJsonCoder:\n    def encode(cls, value: Any) -> bytes:\n        return orjson.dumps(\n            value,\n            default=jsonable_encoder,\n            option=orjson.OPT_NON_STR_KEYS | orjson.OPT_SERIALIZE_NUMPY,\n        )\n\n    def decode(cls, value: Union[bytes | str]) -> Any:\n        return orjson.loads(value)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"implement-logic-for-caching",children:"Implement logic for caching"}),"\n",(0,t.jsxs)(n.p,{children:["Next, we will create a module to provide caching features based on ",(0,t.jsx)(n.code,{children:"RedisClient"}),". To clarify what we need, let's explore the concept of Redis a bit."]}),"\n",(0,t.jsx)(n.h4,{id:"what-is-redis",children:"What is Redis?"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["Redis (",(0,t.jsx)(n.strong,{children:"RE"}),"mote\xa0",(0,t.jsx)(n.strong,{children:"DI"}),"ctionary\xa0",(0,t.jsx)(n.strong,{children:"S"}),"erver) is an open source, in-memory, NoSQL\xa0key/value store that is used primarily as an application cache or quick-response database.\n",(0,t.jsx)(n.a,{href:"https://www.ibm.com/topics/redis",children:(0,t.jsx)(n.em,{children:"\u2014 By IBM \u2014"})})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["So, to effectively use Redis as a cache, we need an efficient strategy for creating keys and values. Fortunately, Redis now supports various ",(0,t.jsx)(n.a,{href:"https://redis.io/docs/latest/develop/data-types/",children:"data types"})," such as strings, hashes, lists, sets, sorted sets, and JSON\u2026"]}),"\n",(0,t.jsx)(n.p,{children:"Another thing to keep in mind is what to cache and how long to keep it in cache."}),"\n",(0,t.jsx)(n.h4,{id:"what-to-cache",children:"What to cache?"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["We don't want to cache many keys that change continuously.\nWe don't want to cache many keys that are requested very rarely.\nWe want to cache keys that are requested often and change at a reasonable rate. For an example of key not changing at a reasonable rate, think of a global counter that is continuously\xa0",(0,t.jsx)(n.a,{href:"https://redis.io/docs/latest/commands/incr/",children:"INCR"}),"emented.\n",(0,t.jsx)(n.a,{href:"https://redis.io/docs/latest/develop/use/client-side-caching/#what-to-cache",children:"\u2014 By Redis Docs \u2014"})]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"how-long-to-keep-it",children:"How long to keep it?"}),"\n",(0,t.jsx)(n.p,{children:"This is a question that you need to answer for yourself; everything depends on the logic of your system."}),"\n",(0,t.jsx)(n.p,{children:"Some systems use Redis to implement a whitelist strategy for their authorization tokens, so the time to keep that key in the cache memory could be the token's lifespan."}),"\n",(0,t.jsx)(n.p,{children:"They also implement data caching for high-traffic APIs with large response data, where the data returned from these APIs has minimal changes. The time to keep the key in the cache memory could be either the time it takes for a change to occur or just enough time to ensure users aren't stuck with outdated data for too long."}),"\n",(0,t.jsx)(n.p,{children:"Suppose you have complex computational tasks that are time-consuming or require significant computational resources. In that case, you can use cron jobs (schedule jobs) to precompute the results and store them in the cache to optimize user experience and system resource utilization."}),"\n",(0,t.jsx)(n.p,{children:"Next, let's take a quick look at this code snippet."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'showLineNumbers title="./app/core/cache.py"',children:'from typing import Any\nfrom urllib.parse import urlencode\nfrom fastapi import Request\nfrom fastapi.datastructures import QueryParams\n\nfrom app.core.redis import redis_client\nfrom app.utils import ORJsonCoder\n\ndef query_params_builder(params: QueryParams) -> str:\n    sorted_query_params = sorted(params.items())\n    return urlencode(sorted_query_params, doseq=True)\n\ndef req_key_builder(req: Request, **kwargs):\n    return ":".join([\n        req.method.lower(), \n        req.url.path, \n        query_params_builder(req.query_params)\n    ])\n\nasync def add(req: Request, data: Any, expire: int = 60):   \n    cached = await redis_client.add_to_cache(req_key_builder(req), data, expire)\n    if not cached:\n        return False\n    return True\n\nasync def check_exist(req: Request) -> str:\n    key = req_key_builder(req)\n    ttl, in_cache = await redis_client.check_cache(key)\n    return in_cache\n\ndef load_cache_data(data: str):\n    return ORJsonCoder().decode(data)\n'})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"query_params_builder"}),": The order of sent query parameters may be inconsistent. Therefore, we need a function to ensure consistency for the query parameters."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"req_key_builder"}),": This function is used to create a unique key based on the incoming request. The value of the key will look like ",(0,t.jsx)(n.code,{children:"get:/api/v1/users:limit=20&skip=0"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"add"}),": As the name suggests, add a key/value pair to Redis with the corresponding parameters."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"check_exist"}),": Used to check whether the data exists in the cache or not."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"load_cache_data"}),": Simply used to decode the data retrieved from the cache."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"integration-with-fastapi",children:"Integration with FastAPI"}),"\n",(0,t.jsx)(n.p,{children:"After all the preparations are complete, the remaining task is to integrate it into the FastAPI application seamlessly."}),"\n",(0,t.jsx)(n.p,{children:"First, connect to Redis."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'showLineNumbers {10,13,18} title="./app/main.py"',children:'from fastapi import FastAPI\nfrom contextlib import asynccontextmanager\n\nfrom app.core.config import settings\nfrom app.core.redis import redis_client\n\n@asynccontextmanager\nasync def lifespan(app: FastAPI):\n    # start up\n    await redis_client.connect(str(settings.REDIS_URL))\n    yield\n    # shut down\n    await redis_client.disconnect()\n\napp = FastAPI(\n    title=settings.PROJECT_NAME,\n    openapi_url=f"{settings.API_STR}{settings.API_VERSION_STR}/openapi.json",\n    lifespan=lifespan\n)\n'})}),"\n",(0,t.jsx)(n.p,{children:"Second, let's do a simple example. I have an API that returns user information as follows."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'showLineNumbers {7,8} title="./app/api/user.py"',children:'@router.get("", response_model=List[User])\nasync def get_pagination_cache(\n    skip: int = Query(0),\n    limit: int = Query(20),\n    session: AsyncSession = Depends(get_async_session)\n) -> Any:\n    data = await user.get_pagination(session, skip, limit)\n    return data\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Now I will implement caching logic for this API. In FastAPI, you can use ",(0,t.jsx)(n.a,{href:"https://fastapi.tiangolo.com/tutorial/background-tasks/",children:"Background Tasks"})," to cache asynchronously, which reduces system load and request latency."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'showLineNumbers {4,9-11,13} title="./app/api/user.py"',children:'@router.get("", response_model=List[User])\nasync def get_pagination_cache(\n    request: Request,\n    bg_tasks: BackgroundTasks,\n    skip: int = Query(0),\n    limit: int = Query(20),\n    session: AsyncSession = Depends(get_async_session)\n) -> Any:\n    in_cache = await cache.check_exist(req=request)\n    if in_cache:\n        return cache.load_cache_data(in_cache)\n    data = await user.get_pagination(session, skip, limit)\n    bg_tasks.add_task(cache.add, req=request, data=data, expire=60)\n    return data\n'})}),"\n",(0,t.jsx)(n.p,{children:"When a user calls this API, it will check the corresponding key in Redis. If this key exists, it will return the value of the key without querying the database. If the key does not exist, the system will query the database to retrieve the data as usual. Once the data is obtained, we return it and simultaneously store it in the cache with an expiration time of 60 seconds."}),"\n",(0,t.jsxs)(n.p,{children:["I will insert approximately 20,000 records and use the ",(0,t.jsx)(n.code,{children:"/users"})," API to retrieve that information. The larger the data, the more noticeable the difference in response time will be."]}),"\n",(0,t.jsx)(n.p,{children:"Let's see what changes now. In the first usage, the API response time falls around 223 ms."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Test API Nocache",src:s(4577).A+"",width:"1493",height:"531"})}),"\n",(0,t.jsx)(n.p,{children:"In the second usage, the response time falls around 136 ms."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Test API Cached",src:s(5484).A+"",width:"1461",height:"531"})}),"\n",(0,t.jsxs)(n.p,{children:["If you have ",(0,t.jsx)(n.a,{href:"https://redis.io/insight/",children:"Redis Insight"})," on your machine, you can connect to Redis and view the values stored within it."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Redis Insight",src:s(4704).A+"",width:"1876",height:"863"})}),"\n",(0,t.jsxs)(n.p,{children:["Additionally, you will need to pay attention to response headers such as ",(0,t.jsx)(n.code,{children:"Cache-Control"}),", ",(0,t.jsx)(n.code,{children:"ETag"}),", ",(0,t.jsx)(n.code,{children:"Vary"}),",\u2026"]}),"\n",(0,t.jsx)(n.p,{children:"Some packages that you may be interested in:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/long2ice/fastapi-cache",children:"long2ice/fastapi-cache (github.com)"})," (1.1k stars, 132 forks on 18/04/2024)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/madkote/fastapi-plugins",children:"madkote/fastapi-plugins (github.com)"})," (334 stars, 19 forks on 18/04/2024)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/comeuplater/fastapi_cache",children:"comeuplater/fastapi_cache (github.com)"})," (208 stars, 16 forks on 18/04/2024)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/a-luna/fastapi-redis-cache",children:"a-luna/fastapi-redis-cache (github.com)"})," (143 stars, 23 forks on 18/04/2024)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/mailgun/expiringdict",children:"mailgun/expiringdict (github.com)"})," (335 stars, 75 forks on 18/04/2024)"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,t.jsx)(n.p,{children:"Well, that\u2019s it. I have discussed some approaches to implementing caching for APIs with FastAPI as well as some related aspects."}),"\n",(0,t.jsxs)(n.p,{children:["I hope this post was useful. If you need a project to run a demo on your environment, here is my\xa0",(0,t.jsx)(n.a,{href:"https://github.com/pxuanbach/fastapi-essential-modules",children:"Git repository"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://www.ibm.com/topics/redis",children:"What is Redis Explained? | IBM"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://redis.io/docs/latest/develop/use/client-side-caching/",children:"Client-side caching in Redis | Docs (redis.io)"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://redis.io/docs/latest/develop/data-types/",children:"Understand Redis data types | Docs (redis.io)"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},4704:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/redis-insight-f387145bfa493f325cf3fa93c745ed20.png"},5484:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/test-api-cached-0312526561d3640715f1f3f7af6de04c.png"},4577:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/test-api-nocache-b807ee3e35ae6bd3e8f514336925ae12.png"},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>o});var t=s(6540);const i={},a=t.createContext(i);function r(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);